<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="data:,">
<title>–°–∫–∏–Ω ‚Äî –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –æ—Ü–µ–Ω–∫–∞</title>
<style>
  :root{ --bg:#0e0e12; --card:#14141a; --accent:#8a2be2; --text:#eaeaf2; --muted:#9aa0b2; --gold:#ffd700; --silver:#c0c0c0; --bronze:#cd7f32; }
  * { box-sizing: border-box; }
  body{ margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); padding:20px; }
  .wrap{ max-width:1200px; margin:0 auto; display:grid; grid-template-columns: 480px 1fr; gap:20px; align-items:start; }
  .viewer{ background:#0b0b0d; border-radius:16px; padding:12px; border:1px solid rgba(255,255,255,0.05); position:relative; box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .info{ background:var(--card); border-radius:16px; padding:16px; border:1px solid rgba(255,255,255,0.05); }
  h1{ margin:0 0 10px 0; font-size:1.3rem; font-weight:800; letter-spacing:-0.3px; }
  .small{ color:var(--muted); font-size:0.95rem; line-height:1.6; }
  .list{ margin-top:14px; display:flex; flex-direction:column; gap:10px; }
  .judge{ padding:12px; background:rgba(255,255,255,0.02); border-radius:10px; display:flex; gap:12px; align-items:flex-start; transition: all 0.3s ease; border-left: 3px solid transparent; }
  .judge:hover{ background:rgba(255,255,255,0.05); border-left-color: var(--accent); transform: translateX(4px); box-shadow: 0 2px 8px rgba(138,43,226,0.15); }
  .judge b{ min-width:130px; display:inline-block; font-size:1rem; }
  .btn{ background:var(--accent); color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; border:none; font-weight:700; transition: all 0.3s ease; font-size:0.95rem; }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(138,43,226,0.5); }
  input[type="range"] {
    width: 100%;
    -webkit-appearance: none;
    background: linear-gradient(90deg,#007bff,#8a2be2);
    height: 7px;
    border-radius: 7px;
    outline: none;
    transition: all 0.2s ease;
  }
  input[type="range"]:hover { height: 9px; }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 22px;
    height: 22px;
    background: #fff;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid #8a2be2;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  input[type="range"]::-webkit-slider-thumb:hover {
    width: 26px;
    height: 26px;
    box-shadow: 0 0 16px rgba(138,43,226,0.8);
  }
  .criterion { margin-bottom:14px; }
  .criterion label { display:flex; justify-content:space-between; font-weight:600; margin-bottom:8px; font-size:0.95rem; }
  .score-display { background:linear-gradient(135deg, #1e1e27, #252530); border-radius:12px; padding:16px; text-align:center; font-size:1.3em; font-weight:800; margin-top:14px; border: 2px solid rgba(138,43,226,0.3); box-shadow: 0 4px 12px rgba(138,43,226,0.2); }
  textarea{ width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:#0a0a0f; color:var(--text); transition: all 0.3s ease; font-size:0.95rem; resize: vertical; }
  textarea:focus{ outline:none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(138,43,226,0.1); }
  .hidden{ display:none; }
  
  .place-badge{ display:inline-block; padding:6px 14px; border-radius:10px; font-weight:800; font-size:0.95rem; margin-left:10px; border: 2px solid; }
  .place-1{ background: linear-gradient(135deg, var(--gold), #ffed4e); color:#000; border-color: var(--gold); }
  .place-2{ background: linear-gradient(135deg, var(--silver), #e8e8e8); color:#000; border-color: var(--silver); }
  .place-3{ background: linear-gradient(135deg, var(--bronze), #e89b5f); color:#000; border-color: var(--bronze); }
  
  .medal-big{ font-size:4rem; position:absolute; top:12px; right:12px; opacity:0.25; pointer-events:none; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.6)); z-index:1; }
  
  .judge-scores{ display:grid; grid-template-columns: repeat(5, 1fr); gap:6px; margin-top:6px; font-size:0.85rem; }
  .judge-scores span{ background:rgba(138,43,226,0.15); padding:4px 6px; border-radius:6px; text-align:center; }
  
  @media (max-width:1024px){ 
    .wrap{ grid-template-columns: 1fr; } 
    .medal-big{ font-size:3rem; } 
  }
</style>
</head>
<body>
  <div class="wrap">
    <div>
      <div class="viewer" id="viewerWrap" style="height:560px;">
        <div id="medalBig" class="medal-big"></div>
      </div>
      <div style="margin-top:12px; display:flex; gap:10px;">
        <button id="backBtn" class="btn" style="background:#333">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</button>
        <button id="signBtn" class="btn" style="margin-left:auto">–í–æ–π—Ç–∏</button>
      </div>
    </div>

    <div>
      <div class="info">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <h1 id="authorTitle">–ê–≤—Ç–æ—Ä: ‚Äî</h1>
          <span id="placeBadge" class="place-badge hidden"></span>
        </div>
        <div class="small" id="placeLine" style="margin-bottom:12px;">–ú–µ—Å—Ç–æ: ‚Äî ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ‚Äî / 90</div>
        <div id="judgeControls"></div>

        <div id="evalWrap" class="hidden" style="margin-top:16px; border-top:2px dashed rgba(255,255,255,0.05); padding-top:16px;">
          <h3 style="margin:0 0 14px 0; font-size:1.15rem;">‚ú® –û—Ü–µ–Ω–∏—Ç—å —Å–∫–∏–Ω</h3>

          <div class="criterion">
            <label for="line">–õ–∞–π–Ω / –û–±—Ä–∞–∑ <span id="line-value">5</span></label>
            <input type="range" id="line" min="1" max="10" value="5">
          </div>

          <div class="criterion">
            <label for="palette">–ü–∞–ª–∏—Ç—Ä–∞ <span id="palette-value">5</span></label>
            <input type="range" id="palette" min="1" max="10" value="5">
          </div>

          <div class="criterion">
            <label for="shade">–†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –®–µ–π–¥ <span id="shade-value">5</span></label>
            <input type="range" id="shade" min="1" max="10" value="5">
          </div>

          <div class="criterion">
            <label for="style">–ê–π–¥–µ–Ω—Ç–∏–∫–∞ / –°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞ <span id="style-value">5</span></label>
            <input type="range" id="style" min="1" max="10" value="5">
          </div>

          <div class="criterion">
            <label for="vibe">–û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ / –í–∞–π–± <span id="vibe-value">5</span></label>
            <input type="range" id="vibe" min="1" max="10" value="5">
          </div>

          <textarea id="reviewText" rows="4" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—É—é —Ä–µ—Ü–µ–Ω–∑–∏—é..."></textarea>

          <div style="display:flex; gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap;">
            <button id="submitEval" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
            <div id="evalMsg" class="small"></div>
          </div>

          <div class="score-display" id="totalDisplay">–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª: 0 / 90</div>
        </div>
      </div>

      <div class="info" style="margin-top:16px;">
        <strong style="font-size:1.1rem;">üìù –û—Ü–µ–Ω–∫–∏ —Å—É–¥–µ–π</strong>
        <div id="scoresList" class="list" style="margin-top:10px;">
          <div class="small">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/skinview3d/bundles/skinview3d.bundle.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, collection, query, where,
      onSnapshot, addDoc, updateDoc, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
      authDomain: "skinsrzt.firebaseapp.com",
      projectId: "skinsrzt",
      storageBucket: "skinsrzt.appspot.com",
      messagingSenderId: "1084042281569",
      appId: "1:1084042281569:web:25872944cf7dac7fd66020"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const urlParams = new URLSearchParams(location.search);
    const skinId = urlParams.get('id');
    if (!skinId) { alert('id —Å–∫–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω'); throw new Error('no id'); }

    const MEDALS = ['ü•á', 'ü•à', 'ü•â'];

    const viewerWrap = document.getElementById('viewerWrap');
    const medalBig = document.getElementById('medalBig');
    const authorTitle = document.getElementById('authorTitle');
    const placeLine = document.getElementById('placeLine');
    const placeBadge = document.getElementById('placeBadge');
    const scoresList = document.getElementById('scoresList');
    const judgeControls = document.getElementById('judgeControls');
    const evalWrap = document.getElementById('evalWrap');
    const lineIn = document.getElementById('line');
    const paletteIn = document.getElementById('palette');
    const shadeIn = document.getElementById('shade');
    const styleIn = document.getElementById('style');
    const vibeIn = document.getElementById('vibe');
    const reviewText = document.getElementById('reviewText');
    const submitEval = document.getElementById('submitEval');
    const evalMsg = document.getElementById('evalMsg');
    const totalDisplay = document.getElementById('totalDisplay');
    const signBtn = document.getElementById('signBtn');
    const backBtn = document.getElementById('backBtn');

    backBtn.addEventListener('click', ()=> location.href = 'results.html');

    const provider = new GoogleAuthProvider();
    let currentUser = null;
    signBtn.addEventListener('click', async ()=>{
      if (!currentUser) {
        try { await signInWithPopup(auth, provider); } catch(e){ alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: '+e.message); }
      } else {
        await signOut(auth);
      }
    });

    onAuthStateChanged(auth, user => {
      currentUser = user;
      signBtn.textContent = user ? '–í—ã–π—Ç–∏ (' + (user.email || user.displayName || '') + ')' : '–í–æ–π—Ç–∏';
      checkJudgeAndShow();
    });

    let skinDoc = null;
    async function loadSkin(){
      const docRef = doc(db, 'contest_entries', skinId);
      const snap = await getDoc(docRef);
      if (!snap.exists()) { alert('–°–∫–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
      skinDoc = { id: snap.id, ...snap.data() };
      authorTitle.textContent = '–ê–≤—Ç–æ—Ä: ' + (skinDoc.authorName || '‚Äî');
      initViewer(skinDoc.skinData);
      listenScores();
      computePlaceAndUpdate();
    }

    let viewerInstance = null;
    function initViewer(skinDataUrl){
      viewerWrap.innerHTML = '<div id="medalBig" class="medal-big"></div>';
      const canvas = document.createElement('canvas');
      canvas.style.width = '100%';
      canvas.style.height = '100%';
      viewerWrap.appendChild(canvas);
      try {
        viewerInstance = new skinview3d.SkinViewer({
          canvas: canvas,
          width: canvas.clientWidth,
          height: canvas.clientHeight,
          skin: skinDataUrl || ''
        });
        viewerInstance.autoRotate = true;
        viewerInstance.autoRotateSpeed = 0.5;
      } catch(e) {
        viewerWrap.innerHTML = `<div id="medalBig" class="medal-big"></div><img src="${skinDataUrl||''}" style="width:100%;height:100%;object-fit:contain" />`;
      }
    }

    // —Å–ª—É—à–∞–µ–º contest_scores –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫–∏–Ω–∞
    let scoreDocs = [];
    let judgesCache = {}; // –ö–µ—à –¥–ª—è –∏–º–µ–Ω —Å—É–¥–µ–π
    let usersCache = {}; // –ö–µ—à –¥–ª—è –Ω–∏–∫–æ–≤ –∏–∑ users
    
    function listenScores(){
      const q = query(collection(db, 'contest_scores'), where('skinId','==', skinId));
      onSnapshot(q, async snap => {
        scoreDocs = [];
        snap.forEach(d => scoreDocs.push({ id: d.id, ...d.data() }));
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–º–µ–Ω–∞ —Å—É–¥–µ–π –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ judges –ò –Ω–∏–∫–∏ –∏–∑ users
        for (const score of scoreDocs) {
          if (score.judgeId) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ judges
            if (!judgesCache[score.judgeId]) {
              try {
                const judgeDoc = await getDoc(doc(db, 'judges', score.judgeId));
                if (judgeDoc.exists()) {
                  judgesCache[score.judgeId] = judgeDoc.data().name || null;
                }
              } catch(e) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–º—è —Å—É–¥—å–∏ –∏–∑ judges:', e);
              }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∏–∫ –∏–∑ users
            if (!usersCache[score.judgeId]) {
              try {
                const userDoc = await getDoc(doc(db, 'users', score.judgeId));
                if (userDoc.exists()) {
                  usersCache[score.judgeId] = userDoc.data().displayName || null;
                }
              } catch(e) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏–∫ –∏–∑ users:', e);
              }
            }
          }
        }
        
        renderScores();
        computePlaceAndUpdate();
      });
    }

    function renderScores(){
      if (!scoreDocs.length) {
        scoresList.innerHTML = '<div class="small" style="text-align:center;padding:20px;opacity:0.6;">–û—Ü–µ–Ω–æ–∫ –µ—â—ë –Ω–µ—Ç.</div>';
      } else {
        scoresList.innerHTML = '';
        scoreDocs.sort((a,b)=> (b.total||0)-(a.total||0));
        scoreDocs.forEach(s => {
          // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –Ω–∏–∫ –∏–∑ users > –∏–º—è –∏–∑ judges > judgeName > '–°—É–¥—å—è'
          const userNick = usersCache[s.judgeId];
          const judgeName = judgesCache[s.judgeId];
          const fallbackName = s.judgeName || '–°—É–¥—å—è';
          
          const displayName = userNick || judgeName || fallbackName;
          
          const div = document.createElement('div');
          div.className = 'judge';
          div.innerHTML = `
            <div style="flex:1;">
              <b>${escapeHtml(displayName)}</b>
              <div class="small" style="margin-top:6px;">–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª: <strong style="color:var(--accent);font-size:1.05rem;">${s.total || '-'} / 90</strong></div>
              <div class="judge-scores">
                <span>L: ${s.line||'-'}</span>
                <span>P: ${s.palette||'-'}</span>
                <span>S: ${s.shade||'-'}</span>
                <span>St: ${s.style||'-'}</span>
                <span>V: ${s.vibe||'-'}</span>
              </div>
              ${s.reviewText ? `<div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;border-left:3px solid var(--accent);font-style:italic;font-size:0.9rem;line-height:1.5;">"${escapeHtml(s.reviewText)}"</div>` : ''}
            </div>
            <div style="text-align:right;">
              <div class="small" style="color:var(--muted);font-size:0.8rem;">${new Date((s.createdAt && s.createdAt.seconds)? s.createdAt.seconds*1000 : Date.now()).toLocaleString('ru-RU')}</div>
            </div>
          `;
          scoresList.appendChild(div);
        });
      }
    }

    async function computePlaceAndUpdate(){
      const entriesSnap = await getDocs(collection(db, 'contest_entries'));
      const all = [];
      for (const d of entriesSnap.docs){
        const id = d.id;
        const scoresSnap = await getDocs(query(collection(db,'contest_scores'), where('skinId','==', id)));
        let sum = 0, cnt = 0;
        scoresSnap.forEach(s => { sum += (s.data().total||0); cnt++; });
        const avgRaw = cnt? sum/cnt : 0;
        const avgCeil = cnt? Math.ceil(avgRaw) : 0;
        all.push({ id, avgCeil, avgRaw, sum });
      }
      all.sort((a,b)=> {
        if (b.avgCeil !== a.avgCeil) return b.avgCeil - a.avgCeil;
        return (b.avgRaw || 0) - (a.avgRaw || 0);
      });
      const idx = all.findIndex(x=>x.id === skinId);
      const place = idx >= 0 ? idx+1 : '-';
      const cur = all.find(x=>x.id===skinId) || { avgCeil:0, avgRaw:0, sum:0 };
      placeLine.textContent = `üìç –ú–µ—Å—Ç–æ: ${place} ‚Ä¢ ‚≠ê –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ${cur.avgCeil} / 90 ‚Ä¢ üë• –û—Ü–µ–Ω–æ–∫: ${scoreDocs.length}`;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–¥–∞–ª—å –∏ –±–µ–π–¥–∂ –¥–ª—è —Ç–æ–ø-3
      if (place >= 1 && place <= 3) {
        medalBig.textContent = MEDALS[place-1];
        placeBadge.textContent = `${place} –º–µ—Å—Ç–æ`;
        placeBadge.className = `place-badge place-${place}`;
        placeBadge.classList.remove('hidden');
      } else {
        medalBig.textContent = '';
        placeBadge.classList.add('hidden');
      }
    }

    async function checkJudgeAndShow(){
      judgeControls.innerHTML = '';
      evalWrap.classList.add('hidden');
      if (!currentUser) {
        judgeControls.innerHTML = '<div class="small" style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;text-align:center;">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –¥–æ—Å—Ç—É–ø–Ω—ã –ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—É–¥—å–∏.</div>';
        return;
      }
      try {
        const judgeDoc = await getDoc(doc(db, 'judges', currentUser.uid));
        if (judgeDoc.exists()) {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∏–∫ –∏–∑ users
          let displayName = judgeDoc.data().name || currentUser.displayName || '';
          try {
            const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
            if (userDoc.exists() && userDoc.data().displayName) {
              displayName = userDoc.data().displayName;
            }
          } catch(e) {
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏–∫ –∏–∑ users:', e);
          }
          
          judgeControls.innerHTML = `<div style="padding:10px;background:rgba(138,43,226,0.1);border-radius:8px;border:1px solid rgba(138,43,226,0.3);"><div class="small">‚úÖ –í—ã ‚Äî —Å—É–¥—å—è (${escapeHtml(displayName)})</div><button id="toggleEval" class="btn" style="margin-top:10px;width:100%;">üìù –û—Ü–µ–Ω–∏—Ç—å —Å–∫–∏–Ω</button></div>`;
          document.getElementById('toggleEval').addEventListener('click', ()=>{
            evalWrap.classList.toggle('hidden');
          });
          await prefillJudgeEvaluation();
        } else {
          judgeControls.innerHTML = '<div class="small" style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;text-align:center;">‚ùå –í—ã –Ω–µ —Å—É–¥—å—è ‚Äî —Ç–æ–ª—å–∫–æ —Å—É–¥—å–∏ –º–æ–≥—É—Ç –æ—Ü–µ–Ω–∏–≤–∞—Ç—å.</div>';
        }
      } catch(e){
        console.error(e);
        judgeControls.innerHTML = '<div class="small" style="padding:10px;background:rgba(255,0,0,0.1);border-radius:8px;text-align:center;">‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤.</div>';
      }
    }

    async function prefillJudgeEvaluation(){
      if (!currentUser) return;
      const q = query(collection(db, 'contest_scores'), where('skinId','==', skinId), where('judgeId','==', currentUser.uid));
      const snaps = await getDocs(q);
      if (!snaps.empty) {
        const d = snaps.docs[0].data();
        lineIn.value = d.line || 5;
        paletteIn.value = d.palette || 5;
        shadeIn.value = d.shade || 5;
        styleIn.value = d.style || 5;
        vibeIn.value = d.vibe || 5;
        reviewText.value = d.reviewText || '';
        updateSliderLabels();
        calculateAndShowTotal();
        evalWrap.classList.remove('hidden');
      } else {
        lineIn.value = 5; paletteIn.value = 5; shadeIn.value = 5; styleIn.value = 5; vibeIn.value = 5;
        reviewText.value = '';
        updateSliderLabels();
        calculateAndShowTotal();
      }
    }

    const vibeMultiplier = {
      1: 1, 2: 1.0675, 3: 1.1349, 4: 1.2024, 5: 1.2699,
      6: 1.3373, 7: 1.4048, 8: 1.4723, 9: 1.5397, 10: 1.6072
    };

    function calculateTotalFromSliders() {
      const line = Number(lineIn.value || 0);
      const palette = Number(paletteIn.value || 0);
      const shade = Number(shadeIn.value || 0);
      const style = Number(styleIn.value || 0);
      const vibe = Number(vibeIn.value || 0);
      const baseSum = line + palette + shade + style;
      const scaled = baseSum * 1.4;
      const multiplier = vibeMultiplier[vibe] || 1;
      const total = Math.round(scaled * multiplier);
      return Math.min(total, 90);
    }

    function calculateAndShowTotal(){
      const total = calculateTotalFromSliders();
      totalDisplay.textContent = `–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª: ${total} / 90`;
      return total;
    }

    function updateSliderLabels(){
      document.getElementById('line-value').textContent = lineIn.value;
      document.getElementById('palette-value').textContent = paletteIn.value;
      document.getElementById('shade-value').textContent = shadeIn.value;
      document.getElementById('style-value').textContent = styleIn.value;
      document.getElementById('vibe-value').textContent = vibeIn.value;
    }

    function debounce(fn, ms=80){ let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; }

    [lineIn, paletteIn, shadeIn, styleIn, vibeIn].forEach(inp => {
      inp.addEventListener('input', debounce(() => {
        updateSliderLabels();
        calculateAndShowTotal();
      }, 60));
    });

    submitEval.addEventListener('click', async ()=>{
      if (!currentUser) { evalMsg.textContent = '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥.'; return; }
      const judgeDoc = await getDoc(doc(db, 'judges', currentUser.uid));
      if (!judgeDoc.exists()) { evalMsg.textContent = '‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Å—É–¥—å–∏.'; return; }

      const line = Number(lineIn.value)||0;
      const palette = Number(paletteIn.value)||0;
      const shade = Number(shadeIn.value)||0;
      const style = Number(styleIn.value)||0;
      const vibe = Number(vibeIn.value)||0;
      for (const v of [line,palette,shade,style,vibe]) {
        if (v < 1 || v > 10) { evalMsg.textContent = '‚ö†Ô∏è –ó–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç 1 –¥–æ 10.'; return; }
      }
      const total = calculateTotalFromSliders();
      const review = (reviewText.value || '').trim();
      evalMsg.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

      try {
        const q = query(collection(db, 'contest_scores'), where('skinId','==', skinId), where('judgeId','==', currentUser.uid));
        const snaps = await getDocs(q);
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Å—É–¥—å–∏: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç - –Ω–∏–∫ –∏–∑ users > –∏–º—è –∏–∑ judges > displayName > email
        let judgeName = currentUser.displayName || currentUser.email || '–°—É–¥—å—è';
        
        try {
          const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
          if (userDoc.exists() && userDoc.data().displayName) {
            judgeName = userDoc.data().displayName;
          } else {
            const judgeDoc = await getDoc(doc(db, 'judges', currentUser.uid));
            if (judgeDoc.exists() && judgeDoc.data().name) {
              judgeName = judgeDoc.data().name;
            }
          }
        } catch(e) {
          console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–º—è —Å—É–¥—å–∏:', e);
        }
        
        if (!snaps.empty) {
          const docRef = snaps.docs[0].ref;
          await updateDoc(docRef, {
            line, palette, shade, style, vibe, total, reviewText: review, 
            judgeName: judgeName,
            createdAt: serverTimestamp()
          });
        } else {
          await addDoc(collection(db, 'contest_scores'), {
            skinId,
            judgeId: currentUser.uid,
            judgeName: judgeName,
            line, palette, shade, style, vibe, total, reviewText: review,
            createdAt: serverTimestamp()
          });
        }
        evalMsg.textContent = '‚úÖ –û—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞';
        evalMsg.style.color = '#4ade80';
        setTimeout(()=> { evalMsg.textContent = ''; evalMsg.style.color = ''; }, 3000);
      } catch(e){
        console.error(e);
        evalMsg.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + (e.message || e);
        evalMsg.style.color = '#f87171';
      }
    });

    function escapeHtml(s){ if (!s && s !== 0) return ''; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

    await loadSkin();
    checkJudgeAndShow();
    updateSliderLabels();
    calculateAndShowTotal();
  </script>
</body>
</html>
