
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Скин — Просмотр и оценка</title>
<style>
  :root{ --bg:#0e0e12; --card:#14141a; --accent:#8a2be2; --text:#eaeaf2; --muted:#9aa0b2; }
  body{ margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); padding:20px; }
  .wrap{ max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 440px 1fr; gap:16px; align-items:start; }
  .viewer{ background:#0b0b0d; border-radius:12px; padding:10px; border:1px solid rgba(255,255,255,0.03); }
  .info{ background:var(--card); border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,0.03); }
  h1{ margin:0 0 8px 0; font-size:1.1rem; }
  .small{ color:var(--muted); font-size:0.95rem; }
  .list{ margin-top:12px; display:flex; flex-direction:column; gap:8px; }
  .judge{ padding:8px; background:rgba(255,255,255,0.02); border-radius:8px; display:flex; gap:8px; align-items:center; }
  .judge b{ min-width:120px; display:inline-block; }
  .btn{ background:var(--accent); color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; border:none; font-weight:700; }
  input[type="range"] {
    width: 100%;
    -webkit-appearance: none;
    background: linear-gradient(90deg,#007bff,#8a2be2);
    height: 6px;
    border-radius: 6px;
    outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: #fff;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid #8a2be2;
  }
  .criterion { margin-bottom:12px; }
  .criterion label { display:flex; justify-content:space-between; font-weight:600; margin-bottom:6px; }
  .score-display { background:#1e1e27; border-radius:10px; padding:12px; text-align:center; font-size:1.1em; font-weight:bold; margin-top:12px; }
  textarea{ width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:#0e0e12; color:var(--text); }
  .hidden{ display:none; }
  @media (max-width:980px){ .wrap{ grid-template-columns: 1fr; } }
</style>
</head>
<body>
  <div class="wrap">
    <div>
      <div class="viewer" id="viewerWrap" style="height:520px;"></div>
      <div style="margin-top:10px; display:flex; gap:8px;">
        <button id="backBtn" class="btn" style="background:#444">Вернуться</button>
        <button id="signBtn" class="btn" style="margin-left:auto">Войти</button>
      </div>
    </div>

    <div>
      <div class="info">
        <h1 id="authorTitle">Автор: —</h1>
        <div class="small" id="placeLine">Место: — • Средний: — / 90</div>
        <div id="judgeControls" style="margin-top:12px;"></div>

        <!-- Блок оценки (скрыт по умолчанию, только для судей) -->
        <div id="evalWrap" class="hidden" style="margin-top:12px; border-top:1px dashed rgba(255,255,255,0.03); padding-top:12px;">
          <h3>Оценить скин</h3>

          <div class="criterion">
            <label for="line">Лайн / Образ <span id="line-value">5</span></label>
            <input type="range" id="line" min="1" max="10" value="5">
          </div>

          <div class="criterion">
            <label for="palette">Палитра <span id="palette-value">5</span></label>
            <input type="range" id="palette" min="1" max="10" value="5">
          </div>

          <div class="criterion">
            <label for="shade">Реализация / Шейд <span id="shade-value">5</span></label>
            <input type="range" id="shade" min="1" max="10" value="5">
          </div>

          <div class="criterion">
            <label for="style">Айдентика / Стилистика <span id="style-value">5</span></label>
            <input type="range" id="style" min="1" max="10" value="5">
          </div>

          <div class="criterion">
            <label for="vibe">Общее впечатление / Вайб <span id="vibe-value">5</span></label>
            <input type="range" id="vibe" min="1" max="10" value="5">
          </div>

<textarea id="reviewText" rows="3" placeholder="Рецензия (текст)"></textarea>

          <div style="display:flex; gap:8px; margin-top:8px; align-items:center;">
            <button id="submitEval" class="btn">Отправить оценку</button>
            <div id="evalMsg" class="small"></div>
          </div>

          <div class="score-display" id="totalDisplay">Итог: 0 / 90</div>
        </div>
      </div>

      <div class="info" style="margin-top:12px;">
        <strong>Оценки судей</strong>
        <div id="scoresList" class="list" style="margin-top:8px;">
          <div class="small">Загрузка оценок...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SkinView3D -->
  <script src="https://unpkg.com/skinview3d@latest/dist/skinview3d.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, doc, getDoc, collection, query, where,
      onSnapshot, addDoc, updateDoc, serverTimestamp, getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
      authDomain: "skinsrzt.firebaseapp.com",
      projectId: "skinsrzt",
      storageBucket: "skinsrzt.appspot.com",
      messagingSenderId: "1084042281569",
      appId: "1:1084042281569:web:25872944cf7dac7fd66020"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const urlParams = new URLSearchParams(location.search);
    const skinId = urlParams.get('id');
    if (!skinId) { alert('id скина не указан'); throw new Error('no id'); }

    // элементы
    const viewerWrap = document.getElementById('viewerWrap');
    const authorTitle = document.getElementById('authorTitle');
    const placeLine = document.getElementById('placeLine');
    const scoresList = document.getElementById('scoresList');
    const judgeControls = document.getElementById('judgeControls');
    const evalWrap = document.getElementById('evalWrap');
    const lineIn = document.getElementById('line');
    const paletteIn = document.getElementById('palette');
    const shadeIn = document.getElementById('shade');
    const styleIn = document.getElementById('style');
    const vibeIn = document.getElementById('vibe');
    const reviewText = document.getElementById('reviewText');
    const submitEval = document.getElementById('submitEval');
    const evalMsg = document.getElementById('evalMsg');
    const totalDisplay = document.getElementById('totalDisplay');
    const signBtn = document.getElementById('signBtn');
    const backBtn = document.getElementById('backBtn');

    backBtn.addEventListener('click', ()=> location.href = 'results.html');

    // auth
    const provider = new GoogleAuthProvider();
    let currentUser = null;
    signBtn.addEventListener('click', async ()=>{
      if (!currentUser) {
        try { await signInWithPopup(auth, provider); } catch(e){ alert('Ошибка входа: '+e.message); }
      } else {
        await signOut(auth);
      }
    });

    onAuthStateChanged(auth, user => {
      currentUser = user;
      signBtn.textContent = user ? 'Выйти (' + (user.emailuser.displayName'') + ')' : 'Войти';
      checkJudgeAndShow();
    });

    // загрузка данных скина
    let skinDoc = null;
    async function loadSkin(){
      const docRef = doc(db, 'contest_entries', skinId);
      const snap = await getDoc(docRef);
      if (!snap.exists()) { alert('Скин не найден'); return; }
      skinDoc = { id: snap.id, ...snap.data() };
      authorTitle.textContent = 'Автор: ' + (skinDoc.authorName || '—');
      // инициализация viewer
      initViewer(skinDoc.skinData);
      // слушаем оценки
      listenScores();
      // посчитаем место
      computePlaceAndUpdate();
    }

// SkinView3D full viewer
    let viewerInstance = null;
    function initViewer(skinDataUrl){
      viewerWrap.innerHTML = '';
      const canvas = document.createElement('canvas');
      canvas.style.width = '100%';
      canvas.style.height = '100%';
      viewerWrap.appendChild(canvas);
      try {
        viewerInstance = new skinview3d.SkinViewer({
          canvas: canvas,
          width: canvas.clientWidth,
          height: canvas.clientHeight,
          skin: skinDataUrl || ''
        });
        viewerInstance.autoUpdate = true;
      } catch(e) {
        viewerWrap.innerHTML = <img src="${skinDataUrl||''}" style="width:100%;height:100%;object-fit:contain" />;
      }
    }

    // слушаем contest_scores для этого скина
    let scoreDocs = [];
    function listenScores(){
      const q = query(collection(db, 'contest_scores'), where('skinId','==', skinId));
      onSnapshot(q, snap => {
        scoreDocs = [];
        snap.forEach(d => scoreDocs.push({ id: d.id, ...d.data() }));
        renderScores();
        computePlaceAndUpdate();
      });
    }

    function renderScores(){
      if (!scoreDocs.length) {
        scoresList.innerHTML = '<div class="small">Оценок ещё нет.</div>';
      } else {
        scoresList.innerHTML = '';
        scoreDocs.sort((a,b)=> (b.total0)-(a.total0));
        scoreDocs.forEach(s => {
          const div = document.createElement('div');
          div.className = 'judge';
          div.innerHTML = 
            <div style="flex:1;">
              <b>${escapeHtml(s.judgeName||'Судья')}</b>
              <div class="small">Итог: ${s.total || '-'} / 90</div>
              <div class="small">Баллы: L:${s.line||'-'} P:${s.palette||'-'} S:${s.shade||'-'} St:${s.style||'-'} V:${s.vibe||'-'}</div>
            </div>
            <div style="max-width:40%;text-align:right;">
              <div class="small" style="color:var(--muted)">${new Date((s.createdAt && s.createdAt.seconds)? s.createdAt.seconds*1000 : Date.now()).toLocaleString('ru-RU')}</div>
              <div style="margin-top:6px;">${escapeHtml(s.reviewText||'')}</div>
            </div>
          ;
          scoresList.appendChild(div);
        });
      }
    }

    // вычисляем средний и место
    async function computePlaceAndUpdate(){
      const entriesSnap = await getDocs(collection(db, 'contest_entries'));
      const all = [];
      for (const d of entriesSnap.docs){
        const id = d.id;
        const scoresSnap = await getDocs(query(collection(db,'contest_scores'), where('skinId','==', id)));
        let sum = 0, cnt = 0;
        scoresSnap.forEach(s => { sum += (s.data().total||0); cnt++; });
        const avgRaw = cnt? sum/cnt : 0;
        const avgCeil = cnt? Math.ceil(avgRaw) : 0;
        all.push({ id, avgCeil, avgRaw, sum });
      }
      all.sort((a,b)=> {
        if (b.avgCeil !== a.avgCeil) return b.avgCeil - a.avgCeil;
        return (b 0) - (a.avgRaw vgRaw || 0);
      });
      const idx = all.findIndex(x=>x.id === skinId);
      const place = idx >= 0 ? idx+1 : '-';
      const cur = all.find(x=>x.id===skinId) || { avgCeil:0, avgRaw:0, sum:0 };
      placeLine.textContent = Место: ${place} • Средний: ${cur.avgCeil} / 90 • Судей: ${scoreDocs.length};
    }

    // проверяем, является ли текущий пользователь судьёй
    async function checkJudgeAndShow(){
      judgeControls.innerHTML = '';
      evalWrap.classList.add('hidden');
      if (!currentUser) {
        judgeControls.innerHTML = '<div class="small">Войдите, чтобы узнать, доступны ли функции судьи.</div>';
        return;
      }
      try {
        const judgeDoc = await getDoc(doc(db, 'judges', currentUser.uid));
        if (judgeDoc.exists()) {
          judgeControls.innerHTML = `<div class="small">Вы — судья (${escapeHtml(currentUscurrentUser.displayNameayName||'')}).</div>

<button id="toggleEval" class="btn" style="margin-top:8px;">Оценить</button>;
          document.getElementById('toggleEval').addEventListener('click', ()=>{
            evalWrap.classList.toggle('hidden');
          });
          await prefillJudgeEvaluation();
        } else {
          judgeControls.innerHTML = '<div class="small">Вы не судья — только судьи могут оценивать.</div>';
        }
      } catch(e){
        console.error(e);
        judgeControls.innerHTML = '<div class="small">Ошибка проверки прав.</div>';
      }
    }

    // prefill
    async function prefillJudgeEvaluation(){
      if (!currentUser) return;
      const q = query(collection(db, 'contest_scores'), where('skinId','==', skinId), where('judgeId','==', currentUser.uid));
      const snaps = await getDocs(q);
      if (!snaps.empty) {
        const d = snaps.docs[0].data();
        lineIn.value = d.line || 5;
        paletteIn.value = d.palette || 5;
        shadeIn.value = d.shade || 5;
        styleIn.value = d.style || 5;
        vibeIn.value = d.vibe || 5;
        reviewText.value = d.reviewText || '';
        updateSliderLabels();
        calculateAndShowTotal();
        evalWrap.classList.remove('hidden');
      } else {
        // defaults
        lineIn.value = 5; paletteIn.value = 5; shadeIn.value = 5; styleIn.value = 5; vibeIn.value = 5;
        reviewText.value = '';
        updateSliderLabels();
        calculateAndShowTotal();
      }
    }

    // расчёт по формуле из твоего примера
    const vibeMultiplier = {
      1: 1, 2: 1.0675, 3: 1.1349, 4: 1.2024, 5: 1.2699,
      6: 1.3373, 7: 1.4048, 8: 1.4723, 9: 1.5397, 10: 1.6072
    };

    function calculateTotalFromSliders() {
      const line = Number(lineIn.value || 0);
      const palette = Number(paletteIn.value || 0);
      const shade = Number(shadeIn.value || 0);
      const style = Number(styleIn.value || 0);
      const vibe = Number(vibeIn.value || 0);
      const baseSum = line + palette + shade + style;
      const scaled = baseSum * 1.4;
      const multiplier = vibeMultiplier[vibe] || 1;
      const total = Math.round(scaled * multiplier);
      // cap to 90 safety (shouldn't exceed, but just in case)
      return Math.min(total, 90);
    }

    function calculateAndShowTotal(){
      const total = calculateTotalFromSliders();
      totalDisplay.textContent = Итог: ${total} / 90`;
      return total;
    }

    function updateSliderLabels(){
      document.getElementById('line-value').textContent = lineIn.value;
      document.getElementById('palette-value').textContent = paletteIn.value;
      document.getElementById('shade-value').textContent = shadeIn.value;
      document.getElementById('style-value').textContent = styleIn.value;
      document.getElementById('vibe-value').textContent = vibeIn.value;
    }

    // debounce helper
    function debounce(fn, ms=80){ let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; }

    // wire sliders
    [lineIn, paletteIn, shadeIn, styleIn, vibeIn].forEach(inp => {
      inp.addEventListener('input', debounce(() => {
        updateSliderLabels();
        calculateAndShowTotal();
      }, 60));
    });

    // отправка оценки
    submitEval.addEventListener('click', async ()=>{
      if (!currentUser) { evalMsg.textContent = 'Требуется вход.'; return; }
      const judgeDoc = await getDoc(doc(db, 'judges', currentUser.uid));
      if (!judgeDoc.exists()) { evalMsg.textContent = 'У вас нет прав судьи.'; return; }

      const line = Number(lineIn.value)||0;
      const palette = Number(paletteIn.value)||0;
      const shade = Number(shadeIn.value)||0;
      const style = Number(styleIn.value)||0;
      const vibe = Number(vibeIn.value)||0;
      for (const v of [line,palette,shade,style,vibe]) {
        if (v < 1 || v > 10) { evalMsg.textContent = 'Значения должны быть от 1 до 10.'; return; }
      }
      const total = calculateTotalFromSliders();
      const review = (reviewText.value || '').trim();
      evalMsg.textContent = 'Отправка...';


try {
        const q = query(collection(db, 'contest_scores'), where('skinId','==', skinId), where('judgeId','==', currentUser.uid));
        const snaps = await getDocs(q);
        if (!snaps.empty) {
          const docRef = snaps.docs[0].ref;
          await updateDoc(docRef, {
            line, palette, shade, style, vibe, total, reviewText: review, createdAt: serverTimestamp()
          });
        } else {
          await addDoc(collection(db, 'contest_scores'), {
            skinId,
            judgeId: currentUser.uid,
            judgeName: currentUser.displayName  currentUser.email  'Судья',
            line, palette, shade, style, vibe, total, reviewText: review,
            createdAt: serverTimestamp()
          });
        }
        evalMsg.textContent = 'Оценка сохранена';
        setTimeout(()=> evalMsg.textContent = '', 2000);
      } catch(e){
        console.error(e);
        evalMsg.textContent = 'Ошибка: ' + (e.message || e);
      }
    });

    // утилиты
    function escapeHtml(s){ if (!s && s !== 0) return ''; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

    // старт
    await loadSkin();
    checkJudgeAndShow();
    // show initial slider labels & total
    updateSliderLabels();
    calculateAndShowTotal();
  </script>
</body>
</html>
