<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Оценка скина</title>
  <script src="https://unpkg.com/skinview3d/bundles/skinview3d.bundle.js"></script>
  <style>
    body {
      background-color: #0e0e12;
      color: #fff;
      font-family: 'Inter', sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      background: #15151c;
      border-radius: 16px;
      padding: 20px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 0 30px rgba(0,0,0,0.4);
    }
    header { text-align:center; margin-bottom:20px; }
    header img { 
      height:70px; 
      width:auto; 
      display:block; 
      margin:0 auto 8px; 
    }
    header h1 { font-size:1.7em; margin:0; }
    .upload-section { text-align:center; margin-bottom:20px; }
    input[type=file] {
      background:#1e1e27; border-radius:8px; padding:10px; border:1px solid #2f2f3b; color:#fff;
      cursor:pointer; font-size:0.9em; max-width:100%;
    }
    .skin-preview { width:100%; max-width:300px; height:400px; margin:15px auto; display:block;
      border:2px solid #2f2f3b; border-radius:8px; background: repeating-conic-gradient(#2a2a35 0% 25%, #1e1e27 0% 50%) 50% / 20px 20px;
    }
    .criterion { margin-bottom:15px; }
    .criterion label { display:flex; justify-content:space-between; margin-bottom:5px; font-weight:600; }
    input[type=range] { width:100%; -webkit-appearance:none; background:linear-gradient(90deg,#007bff,#8a2be2); height:6px; border-radius:6px; outline:none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; border:2px solid #8a2be2; }
    input[type=range]::-moz-range-thumb { width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; border:2px solid #8a2be2; }
    .score-display { background:#1e1e27; border-radius:10px; padding:12px; text-align:center; font-size:1.1em; font-weight:bold; margin-top:20px;}
    textarea { width:100%; min-height:80px; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:10px; resize:vertical; margin-bottom:12px; font-family:inherit; box-sizing:border-box; }
    .reset-button, .submit-button { background:#8a2be2; color:#fff; border:none; padding:10px 20px; border-radius:8px; font-size:1em; cursor:pointer; margin-right:8px; transition:all .15s; }
    .reset-button:hover, .submit-button:hover { background:#9b4dff; transform:translateY(-1px); }
    .reset-button:disabled, .submit-button:disabled { background:#555; cursor:not-allowed; }
    .reviews { margin-top:30px; }
    .review-item { background:#1b1b23; border-radius:8px; padding:12px; margin-bottom:12px; border-left:3px solid #8a2be2; }
    .review-item h3 { margin-top:0; color:#8a2be2; }
    .criteria { background:#1e1e27; border-radius:8px; padding:8px 10px; margin:10px 0; font-size:0.9em; line-height:1.6; }
    .criteria small { display:block; color:#ccc; }
    .review-item .skin-thumb { max-width:120px; margin-top:10px; border-radius:8px; border:1px solid #2f2f3b; cursor:pointer; display:block; }
    .review-item .skin-thumb:hover { border-color:#8a2be2; }
    .info-text { text-align:center; color:#888; font-size:0.85em; margin-top:8px; }
    .loading { text-align:center; color:#8a2be2; padding:20px; }
    .error { color:#f88; padding:10px; border-radius:6px; background:#2a1a2a; text-align:center; }
    /* Автор-бейдж над заголовком рецензии */
    .author-badge {
      display: inline-block;
      background: #1e1e27;
      color: #fff;
      border: 1px solid #8a2be2;
      border-radius: 12px;
      padding: 6px 10px;
      font-weight: 700;
      margin-bottom: 8px;
      box-shadow: 0 0 10px rgba(138,43,226,0.15);
    }
    /* Фиксированная панель авторизации справа */
    @media (min-width: 1100px) {
      body.with-auth-sidebar { padding-right: 340px; }
    }
    @media (max-width: 1099px) {
      #auth-section { position: static !important; width: auto !important; margin:10px 0 16px 0 !important; }
    }
    /* Модальное окно для увеличенного SkinViewer */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index: 2000; }
    .modal-content { background:#15151c; border:1px solid #2f2f3b; border-radius:12px; padding:14px; box-shadow: 0 0 30px rgba(0,0,0,0.5); max-width: 90vw; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .modal-title { font-size:1.1em; font-weight:700; }
    .modal-close { background:#8a2be2; border:none; color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
#contest {
  margin: 20px auto 30px auto;
  padding: 15px 20px;
  max-width: 600px;
  text-align: center;
  background-color: #111;
  border-radius: 14px;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
}

#contest h3 {
  color: #fff;
  margin-bottom: 8px;
  font-size: 1.2em;
}

#contest p {
  color: #ccc;
  margin-bottom: 12px;
  font-size: 0.95em;
}

.contest-btn {
  display: inline-block;
  padding: 8px 18px;
  background-color: #ff0066;
  color: #fff;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 600;
  transition: 0.2s;
}

.contest-btn:hover {
  background-color: #ff3388;
  transform: scale(1.05);
}
    .disclaimer {
  margin: 10px 0 16px 0;
  background: #1e1e27;
  border: 1px solid #2f2f3b;
  border-radius: 10px;
  padding: 10px 14px;
  color: #bbb;
  font-size: 0.85em;
  line-height: 1.5;
  text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}
.disclaimer b {
  color: #ff4d4d;
}
  </style>

</head>
<body>
  <div class="container">
    <header>
  <a href="https://t.me/MeatMakers" target="_blank">
    <img src="assets/МММ_ЛОГО_ОРИГИНАЛ.png" alt="Логотип" onerror="this.style.display='none'">
  </a>
  <h1>Оценка скина</h1>
</header>
    <section class="auth" id="auth-section" style="margin:10px 0 16px 0; background:#1e1e27; border:1px solid #2f2f3b; border-radius:10px; padding:10px 14px; position:fixed; right:20px; top:20px; width:300px; z-index:1000;">
      <div id="auth-status" class="info-text" style="margin-bottom:8px;">Вы не вошли. Войдите или зарегистрируйтесь, чтобы сохранять рецензии.</div>
      <div id="auth-controls" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <input id="auth-email" type="email" placeholder="Email" style="flex:1; min-width:180px; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:8px;" />
        <input id="auth-password" type="password" placeholder="Пароль" style="flex:1; min-width:140px; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:8px;" />
        <button id="auth-login" class="submit-button" style="margin-right:0;">Войти</button>
        <button id="auth-register" class="reset-button" style="margin-right:0;">Регистрация</button>
        <button id="auth-google" class="submit-button" style="background:#4285F4; margin-right:0;">Google</button>
      </div>
      <div id="nick-row" style="display:none; margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span id="nick-display" style="font-weight:700; color:#fff; background:#1e1e27; border:1px solid #8a2be2; border-radius:10px; padding:6px 10px;">—</span>
        <button id="nick-edit" class="reset-button" style="margin-right:0;">Изменить</button>
        <div id="nick-edit-box" style="display:none; width:100%; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="nick-input" type="text" placeholder="Ваш ник" maxlength="40" style="flex:1 1 100%; min-width:0; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:8px;" />
          <button id="nick-save" class="submit-button" style="margin-right:0; flex:1 1 0;">Сохранить</button>
          <button id="nick-cancel" class="reset-button" style="margin-right:0; flex:1 1 0;">Отмена</button>
        </div>
      </div>
      <div style="margin-top:8px;">
        <button id="auth-logout" class="reset-button" style="display:none; margin-right:0;">Выйти</button>
      </div>
      <div id="auth-error" class="error" style="display:none; margin-top:8px;"></div>
    </section>
    <div class="upload-section">
      <input type="file" id="skin-upload" accept="image/png" />
      <div class="info-text">Загрузите PNG файл скина (64x64 или 64x32)</div>
      <canvas id="skin-viewer" class="skin-preview"></canvas>
    </div>

    <div class="criterion">
      <label for="line">Лайн / Образ <span id="line-value">5</span></label>
      <input type="range" id="line" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="palette">Палитра <span id="palette-value">5</span></label>
      <input type="range" id="palette" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="shade">Реализация / Шейд <span id="shade-value">5</span></label>
      <input type="range" id="shade" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="style">Айдентика / Стилистика <span id="style-value">5</span></label>
      <input type="range" id="style" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="vibe">Общее впечатление / Вайб <span id="vibe-value">5</span></label>
      <input type="range" id="vibe" min="1" max="10" value="5">
    </div>

    <div class="score-display" id="total">Итог: 25 / 90</div>

    <textarea id="title" placeholder="Заголовок рецензии" maxlength="200"></textarea>
    <textarea id="text" placeholder="Текст рецензии (до 8500 символов)" maxlength="8500"></textarea>
    <div id="text-warning" class="info-text" style="display:none; text-align:left; margin-top:-6px;">
      Минимум 30 символов в тексте рецензии.
    </div>
  <p class="disclaimer">
   <b>ДИСКЛЕЙМЕР!</b><br>
  Все рецензии без осмысленного текста и оценки — а также состоящие из случайного набора букв,
  оскорблений, шуток и т.д. — будут <b>удалены администрацией</b>.
</p>


    <button class="reset-button" id="reset">Очистить</button>
    <button class="submit-button" id="submit" disabled>Сохранить</button>

     <section id="contest" class="centered-block">
  <div class="contest-content">
    <h2>Хэллоуинский Конкурс от MMM</h2>
    <p>Отправь свой скин и заработай до 2000 РУБЛЕЙ</p>
    <a href="https://t.me/MeatMakers/17" target="_blank" class="contest-btn">Участвовать</a>
  </div>
</section>
    <div class="reviews" id="reviews">
      <div class="loading">Загрузка рецензий...</div>
    </div>
    <!-- Модальное окно увеличенного предпросмотра скина -->
    <div id="skin-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="skin-modal-title">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title" id="skin-modal-title">Предпросмотр скина</div>
          <button id="skin-modal-close" class="modal-close">Закрыть</button>
        </div>
        <canvas id="skin-modal-canvas" width="320" height="420" class="skin-preview"></canvas>
      </div>
    </div>
  </div>

<script>
// Основной UI-скрипт
document.addEventListener('DOMContentLoaded', () => {
  const ranges = ['line', 'palette', 'shade', 'style', 'vibe'];
  const values = {line: 5, palette: 5, shade: 5, style: 5, vibe: 5};
  const vibeMultiplier = {
    1: 1, 2: 1.0675, 3: 1.1349, 4: 1.2024, 5: 1.2699,
    6: 1.3373, 7: 1.4048, 8: 1.4723, 9: 1.5397, 10: 1.6072
  };
  let viewer = null;
  let uploadedSkin = null;
  
  // Делаем uploadedSkin доступным глобально для Firebase
  window.uploadedSkin = null;

    // Элементы формы и управление доступностью кнопки "Сохранить"
    const submitBtn = document.getElementById('submit');
    const titleEl = document.getElementById('title');
    const textEl = document.getElementById('text');
    const textWarning = document.getElementById('text-warning');
    const MIN_TEXT_LEN = 30;

    function isNonEmpty(str) {
      return !!(str && String(str).trim().length > 0);
    }

    function updateSubmitState() {
      const hasSkin = !!window.uploadedSkin;
      const hasTitle = isNonEmpty(titleEl?.value);
      const textVal = textEl?.value || '';
      const hasText = isNonEmpty(textVal);
      const textLongEnough = textVal.trim().length >= MIN_TEXT_LEN;
      const isAuthed = !!window.currentUserUid;

      if (textWarning) {
        textWarning.style.display = (!textLongEnough ? 'block' : 'none');
      }

      if (submitBtn) submitBtn.disabled = !(hasSkin && hasTitle && hasText && textLongEnough && isAuthed);
    }

    // Делаем доступным для модуля (Auth) вызывать пересчёт состояния
    window.updateSubmitState = updateSubmitState;

  function calculateTotal() {
    const baseSum = Number(values.line) + Number(values.palette) + Number(values.shade) + Number(values.style);
    const scaled = baseSum * 1.4;
    const multiplier = vibeMultiplier[Number(values.vibe)] || 1;
    const total = Math.round(scaled * multiplier);
    document.getElementById('total').textContent = `Итог: ${total} / 90`;
    return total;
  }

  // Инициализация слайдеров
  ranges.forEach(id => {
    const input = document.getElementById(id);
    const label = document.getElementById(`${id}-value`);
    if (input && label) {
      input.addEventListener('input', () => {
        values[id] = parseInt(input.value, 10);
        label.textContent = input.value;
        calculateTotal();
      });
    }
  });

  // Загрузка файла
  document.getElementById('skin-upload').addEventListener('change', async e => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    if (!file.type.includes('png')) {
      alert('Только PNG файлы подходят для скинов.');
      return;
    }
    
    // Сохраняем data URL скина в window.uploadedSkin (base64)
    
    const reader = new FileReader();
    reader.onload = evt => {
      uploadedSkin = evt.target.result;
      window.uploadedSkin = uploadedSkin;
      
      try {
        if (!viewer) {
          viewer = new skinview3d.SkinViewer({
            canvas: document.getElementById('skin-viewer'),
            width: 300,
            height: 400,
            skin: uploadedSkin
          });
          viewer.zoom = 0.9;
          viewer.autoRotate = false;
        } else {
          viewer.loadSkin(uploadedSkin);
        }
      } catch (err) {
        console.error('Ошибка при загрузке скина:', err);
      }

      // Обновляем доступность кнопки после успешной загрузки скина
      updateSubmitState();
    };
    
    reader.onerror = () => {
      alert('Ошибка при чтении файла.');
    };
    
    reader.readAsDataURL(file);
  });

  // Кнопка сброса
  document.getElementById('reset').addEventListener('click', () => {
    ranges.forEach(id => {
      values[id] = 5;
      const el = document.getElementById(id);
      if (el) el.value = 5;
      const label = document.getElementById(`${id}-value`);
      if (label) label.textContent = '5';
    });
    
    document.getElementById('title').value = '';
    document.getElementById('text').value = '';
    document.getElementById('skin-upload').value = '';
    
    uploadedSkin = null;
    window.uploadedSkin = null;

    if (viewer) {
      try {
        viewer.dispose();
        viewer = null;
      } catch(e) {}
    }
    
    const canvas = document.getElementById('skin-viewer');
    const ctx = canvas.getContext('2d');
    if (ctx) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    calculateTotal();

    // После сброса снова блокируем кнопку сохранения
    updateSubmitState();
  });

  calculateTotal();
  
  // Отслеживаем ввод текста для включения/выключения кнопки
  if (titleEl) titleEl.addEventListener('input', updateSubmitState);
  if (textEl) textEl.addEventListener('input', updateSubmitState);
  
  // Устанавливаем корректное начальное состояние кнопки
  updateSubmitState();
});
</script>


<!-- Firebase Module -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    getDoc,
    query,
    orderBy,
    serverTimestamp,
    limit
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut,
    GoogleAuthProvider,
    signInWithPopup
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
    authDomain: "skinsrzt.firebaseapp.com",
    projectId: "skinsrzt",
    storageBucket: "skinsrzt.appspot.com",
    messagingSenderId: "1084042281569",
    appId: "1:1084042281569:web:25872944cf7dac7fd66020"
  };

  // Инициализация Firebase (только Firestore)
  let app, db, auth;
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
  } catch (err) {
    console.error("Ошибка инициализации Firebase:", err);
    document.getElementById('reviews').innerHTML = '<div class="error">Не удалось инициализировать базу данных.</div>';
  }

  // Элементы Auth UI
  const authStatus = document.getElementById('auth-status');
  const authError = document.getElementById('auth-error');
  const authEmail = document.getElementById('auth-email');
  const authPassword = document.getElementById('auth-password');
  const authLoginBtn = document.getElementById('auth-login');
  const authRegisterBtn = document.getElementById('auth-register');
  const authGoogleBtn = document.getElementById('auth-google');
  const authLogoutBtn = document.getElementById('auth-logout');
  const authControls = document.getElementById('auth-controls');
  const googleProvider = auth ? new GoogleAuthProvider() : null;
  const nickRow = document.getElementById('nick-row');
  const nickInput = document.getElementById('nick-input');
  const nickSaveBtn = document.getElementById('nick-save');
  const nickCancelBtn = document.getElementById('nick-cancel');
  const nickEditBtn = document.getElementById('nick-edit');
  const nickEditBox = document.getElementById('nick-edit-box');
  const nickDisplay = document.getElementById('nick-display');

  async function loadNickname(uid) {
    try {
      if (!uid) return null;
      const userDocRef = doc(db, 'users', uid);
      const snap = await getDoc(userDocRef);
      if (snap.exists()) {
        const data = snap.data();
        return data?.displayName || null;
      }
      return null;
    } catch (e) {
      console.warn('Не удалось получить ник:', e);
      return null;
    }
  }

  async function saveNickname(uid, name) {
    if (!uid) throw new Error('Нет пользователя');
    const safe = String(name || '').trim().slice(0, 40);
    const userDocRef = doc(db, 'users', uid);
    await setDoc(userDocRef, { displayName: safe, updatedAt: Date.now() }, { merge: true });
    return safe;
  }

  function setAuthError(message) {
    if (!authError) return;
    if (message) {
      authError.textContent = message;
      authError.style.display = 'block';
    } else {
      authError.textContent = '';
      authError.style.display = 'none';
    }
  }

  // Следим за состоянием входа
  if (auth) {
    onAuthStateChanged(auth, (user) => {
      window.currentUserUid = user ? user.uid : null;
      if (user) {
        if (authStatus) authStatus.textContent = `Вход выполнен: ${user.email || 'пользователь'}`;
        if (authLogoutBtn) authLogoutBtn.style.display = 'inline-block';
        if (authLoginBtn) authLoginBtn.style.display = 'none';
        if (authRegisterBtn) authRegisterBtn.style.display = 'none';
        if (authGoogleBtn) authGoogleBtn.style.display = 'none';
        if (authEmail) authEmail.style.display = 'none';
        if (authPassword) authPassword.style.display = 'none';
        if (nickRow) nickRow.style.display = 'flex';
        // загрузка ника
        (async () => {
          const existing = await loadNickname(user.uid);
          const fallback = user.email ? user.email.split('@')[0] : 'user';
          const name = existing || fallback;
          if (nickInput) nickInput.value = name;
          if (nickDisplay) nickDisplay.textContent = name;
          if (nickEditBox) nickEditBox.style.display = 'none';
          window.currentUserDisplayName = name;
        })();
      } else {
        if (authStatus) authStatus.textContent = 'Вы не вошли. Войдите или зарегистрируйтесь, чтобы сохранять рецензии.';
        if (authLogoutBtn) authLogoutBtn.style.display = 'none';
        if (authLoginBtn) authLoginBtn.style.display = 'inline-block';
        if (authRegisterBtn) authRegisterBtn.style.display = 'inline-block';
        if (authGoogleBtn) authGoogleBtn.style.display = 'inline-block';
        if (authEmail) authEmail.style.display = 'inline-block';
        if (authPassword) authPassword.style.display = 'inline-block';
        if (nickRow) nickRow.style.display = 'none';
        window.currentUserDisplayName = null;
      }
      if (window.updateSubmitState) try { window.updateSubmitState(); } catch(e) {}
      setAuthError('');
    });
  }

  // Обработчики кнопок входа/регистрации/выхода
  if (authLoginBtn) authLoginBtn.addEventListener('click', async () => {
    setAuthError('');
    try {
      const email = authEmail?.value?.trim();
      const password = authPassword?.value || '';
      if (!email || !password) return setAuthError('Введите email и пароль.');
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      setAuthError(e?.message || 'Ошибка входа');
    }
  });

  if (authRegisterBtn) authRegisterBtn.addEventListener('click', async () => {
    setAuthError('');
    try {
      const email = authEmail?.value?.trim();
      const password = authPassword?.value || '';
      if (!email || !password) return setAuthError('Введите email и пароль.');
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (e) {
      setAuthError(e?.message || 'Ошибка регистрации');
    }
  });

  if (authLogoutBtn) authLogoutBtn.addEventListener('click', async () => {
    setAuthError('');
    try {
      await signOut(auth);
    } catch (e) {
      setAuthError(e?.message || 'Ошибка выхода');
    }
  });

  if (authGoogleBtn) authGoogleBtn.addEventListener('click', async () => {
    setAuthError('');
    try {
      await signInWithPopup(auth, googleProvider);
    } catch (e) {
      setAuthError(e?.message || 'Ошибка входа через Google');
    }
  });

  if (nickEditBtn) nickEditBtn.addEventListener('click', () => {
    if (!window.currentUserUid) return setAuthError('Войдите, чтобы изменить ник.');
    if (nickEditBox) nickEditBox.style.display = 'flex';
  });

  if (nickCancelBtn) nickCancelBtn.addEventListener('click', () => {
    if (nickEditBox) nickEditBox.style.display = 'none';
    if (nickInput && nickDisplay) nickInput.value = nickDisplay.textContent || '';
  });

  if (nickSaveBtn) nickSaveBtn.addEventListener('click', async () => {
    setAuthError('');
    try {
      const uid = window.currentUserUid;
      if (!uid) return setAuthError('Войдите, чтобы сохранить ник.');
      const name = nickInput?.value || '';
      const saved = await saveNickname(uid, name);
      window.currentUserDisplayName = saved;
      if (authStatus) authStatus.textContent = `Вход выполнен: ${saved}`;
      if (nickDisplay) nickDisplay.textContent = saved;
      if (nickEditBox) nickEditBox.style.display = 'none';
    } catch (e) {
      setAuthError(e?.message || 'Не удалось сохранить ник');
    }
  });

  // Утилита: экранирование HTML для вывода
  function escapeHtml(unsafe) {
    if (!unsafe && unsafe !== 0) return '';
    return String(unsafe)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Загрузка рецензий
  async function loadReviews() {
    const container = document.getElementById('reviews');

    try {
      container.innerHTML = '<div class="loading">Загрузка рецензий...</div>';

      const q = query(
        collection(db, "reviews"),
        orderBy("createdAt", "desc"),
        limit(50)
      );

      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        container.innerHTML = '<div class="info-text">Пока нет рецензий. Будьте первым!</div>';
        return;
      }

      container.innerHTML = '';

      snapshot.forEach(doc => {
        const r = doc.data();
        const reviewDiv = document.createElement('div');
        reviewDiv.classList.add('review-item');

        let createdStr = '';
        if (r.createdAt) {
          try {
            const date = r.createdAt.toDate ? r.createdAt.toDate() : new Date(r.createdAt);
            createdStr = date.toLocaleString('ru-RU');
          } catch(e) {
            createdStr = '';
          }
        }

        const authorDisplay = escapeHtml(r.authorName || 'Пользователь');
        let reviewHTML = `
          <div class="author-badge">${authorDisplay}</div>
          <h3>${escapeHtml(r.title || 'Без заголовка')}</h3>
          <p>${escapeHtml(r.text || '')}</p>
          <div class="criteria">
            <small>Лайн / Образ: ${r.line ?? '-'}</small>
            <small>Палитра: ${r.palette ?? '-'}</small>
            <small>Реализация / Шейд: ${r.shade ?? '-'}</small>
            <small>Айдентика / Стилистика: ${r.style ?? '-'}</small>
            <small>Общее впечатление / Вайб: ${r.vibe ?? '-'}</small>
          </div>
          <small><b>Итоговая оценка:</b> ${r.total ?? '-'} / 90</small>
        `;

        if (createdStr) {
          reviewHTML += `<br><small>Дата: ${createdStr}</small>`;
        }

        // Показываем base64 скин напрямую, если он есть
        if (r.skinData) {
          const viewerId = `viewer_${doc.id}`;
          reviewHTML += `<br><canvas id="${viewerId}" width="150" height="200" class="skin-thumb" style="cursor:zoom-in"></canvas>`;
          setTimeout(() => {
            try {
              const canvasEl = document.getElementById(viewerId);
              const viewer = new skinview3d.SkinViewer({
                canvas: canvasEl,
                width: 150,
                height: 200,
                skin: r.skinData
              });
              viewer.zoom = 0.9;
              viewer.autoRotate = true;
              const control = skinview3d.createOrbitControls(viewer);
              control.enableZoom = false;
              control.enableRotate = true;
              // Открыть модалку по клику на превью
              if (canvasEl) {
                canvasEl.addEventListener('click', () => openSkinModal(r.skinData));
              }
            } catch (e) {
              console.error('Ошибка при создании 3D предпросмотра:', e);
            }
          }, 300);
        }

        reviewDiv.innerHTML = reviewHTML;
        container.appendChild(reviewDiv);
      });

    } catch (err) {
      console.error('Ошибка при загрузке рецензий:', err);
      container.innerHTML = `<div class="error">Ошибка загрузки. Попробуйте обновить страницу.</div>`;
    }
  }

  // Загружаем рецензии при старте
  loadReviews();

  // Отправка рецензии
  document.getElementById('submit').addEventListener('click', async () => {
    const submitBtn = document.getElementById('submit');
    const titleEl = document.getElementById('title');
    const textEl = document.getElementById('text');

    const title = titleEl.value.trim();
    const text = textEl.value.trim();

    if (!title || !text) {
      alert('Пожалуйста, введите заголовок и текст рецензии');
      return;
    }
    if (text.trim().length < 30) {
      alert('Текст рецензии должен быть не короче 30 символов.');
      return;
    }
    if (!window.currentUserUid) {
      alert('Пожалуйста, войдите в аккаунт, чтобы сохранять рецензии.');
      return;
    }
if (!window.uploadedSkin) {
  alert('Пожалуйста, загрузите файл скина перед отправкой рецензии.');
  return;
}
    submitBtn.disabled = true;
    submitBtn.textContent = 'Сохранение...';

    try {
      const values = {
        line: parseInt(document.getElementById('line').value, 10),
        palette: parseInt(document.getElementById('palette').value, 10),
        shade: parseInt(document.getElementById('shade').value, 10),
        style: parseInt(document.getElementById('style').value, 10),
        vibe: parseInt(document.getElementById('vibe').value, 10)
      };

      // вычисление итоговой оценки (как в UI)
      const vibeMultiplier = {
        1: 1, 2: 1.0675, 3: 1.1349, 4: 1.2024, 5: 1.2699,
        6: 1.3373, 7: 1.4048, 8: 1.4723, 9: 1.5397, 10: 1.6072
      };
      const baseSum = Number(values.line) + Number(values.palette) + Number(values.shade) + Number(values.style);
      const scaled = baseSum * 1.4;
      const multiplier = vibeMultiplier[Number(values.vibe)] || 1;
      const total = Math.round(scaled * multiplier);

      const reviewData = {
        title: title,
        text: text,
        total: total,
        line: values.line,
        palette: values.palette,
        shade: values.shade,
        style: values.style,
        vibe: values.vibe,
        userId: window.currentUserUid,
        authorName: window.currentUserDisplayName || null,
        createdAt: serverTimestamp()
      };

      // Проверка и добавление base64 скина (если есть)
      // Firestore имеет ограничение ~1 MiB на документ. Отклоняем большие изображения.
      if (window.uploadedSkin) {
        const dataUrl = window.uploadedSkin;
        const parts = dataUrl.split(',');
        const base64 = parts[1] || '';
        const byteSize = Math.ceil((base64.length * 3) / 4); // приблизительный размер в байтах
        const MAX_BYTES = 900000; // 900 KB - запас перед лимитом Firestore

        if (byteSize > MAX_BYTES) {
          alert('Ошибка: скин слишком большой для сохранения в Firestore (≈' + byteSize + ' байт). Пожалуйста, уменьшите размер или используйте другой скин.');
          throw new Error('Скин слишком большой для Firestore');
        }

        reviewData.skinData = dataUrl;
      }

      const docRef = await addDoc(collection(db, "reviews"), reviewData);
      console.log('Документ сохранен с ID:', docRef.id);

      alert('✅ Рецензия успешно сохранена!');

      // Перезагружаем список
      await loadReviews();

    } catch (err) {
      console.error('Ошибка при сохранении:', err);
      alert('❌ Ошибка: ' + (err.message || err));
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Сохранить';
    }
  });

  // --------- Модалка SkinViewer ---------
  const skinModal = document.getElementById('skin-modal');
  const skinModalClose = document.getElementById('skin-modal-close');
  const skinModalCanvas = document.getElementById('skin-modal-canvas');
  let modalViewer = null;

  function openSkinModal(skinData) {
    if (!skinModal || !skinModalCanvas) return;
    skinModal.style.display = 'flex';
    try {
      if (modalViewer) { try { modalViewer.dispose(); } catch(e){} modalViewer = null; }
      modalViewer = new skinview3d.SkinViewer({
        canvas: skinModalCanvas,
        width: skinModalCanvas.width,
        height: skinModalCanvas.height,
        skin: skinData
      });
      modalViewer.zoom = 0.8;
      modalViewer.autoRotate = true;
      const ctl = skinview3d.createOrbitControls(modalViewer);
      ctl.enableZoom = true;
      ctl.enableRotate = true;
    } catch(e) {
      console.error('Не удалось открыть предпросмотр:', e);
    }
  }

  function closeSkinModal() {
    if (!skinModal) return;
    skinModal.style.display = 'none';
    if (modalViewer) { try { modalViewer.dispose(); } catch(e){} modalViewer = null; }
  }

  if (skinModalClose) skinModalClose.addEventListener('click', closeSkinModal);
  if (skinModal) skinModal.addEventListener('click', (e) => {
    if (e.target === skinModal) closeSkinModal();
  });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSkinModal(); });
</script>

</body>
</html>
