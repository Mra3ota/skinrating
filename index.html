<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Оценка скина</title>
  <script src="https://unpkg.com/skinview3d/bundles/skinview3d.bundle.js"></script>
  <style>
    body {
      background-color: #0e0e12;
      color: #fff;
      font-family: 'Inter', sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      background: #15151c;
      border-radius: 16px;
      padding: 20px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 0 30px rgba(0,0,0,0.4);
    }
    header { text-align:center; margin-bottom:20px; }
    header img { height:70px; width:auto; display:block; margin:0 auto 8px; }
    header h1 { font-size:1.7em; margin:0; }
    .upload-section { text-align:center; margin-bottom:20px; }
    input[type=file] {
      background:#1e1e27; border-radius:8px; padding:10px; border:1px solid #2f2f3b; color:#fff;
      cursor:pointer; font-size:0.9em; max-width:100%;
    }
    .skin-preview { width:100%; max-width:300px; height:400px; margin:15px auto; display:block;
      border:2px solid #2f2f3b; border-radius:8px; background: repeating-conic-gradient(#2a2a35 0% 25%, #1e1e27 0% 50%) 50% / 20px 20px;
    }
    .criterion { margin-bottom:15px; }
    .criterion label { display:flex; justify-content:space-between; margin-bottom:5px; font-weight:600; }
    input[type=range] { width:100%; -webkit-appearance:none; background:linear-gradient(90deg,#007bff,#8a2be2); height:6px; border-radius:6px; outline:none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; border:2px solid #8a2be2; }
    .score-display { background:#1e1e27; border-radius:10px; padding:12px; text-align:center; font-size:1.1em; font-weight:bold; margin-top:20px;}
    textarea { width:100%; min-height:80px; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:10px; resize:vertical; margin-bottom:12px; font-family:inherit; box-sizing:border-box; }
    .reset-button, .submit-button { background:#8a2be2; color:#fff; border:none; padding:10px 20px; border-radius:8px; font-size:1em; cursor:pointer; margin-right:8px; transition:all .15s; }
    .reset-button:hover, .submit-button:hover { background:#9b4dff; transform:translateY(-1px); }
    .reviews { margin-top:30px; }
    .review-item { background:#1b1b23; border-radius:8px; padding:12px; margin-bottom:12px; border-left:3px solid #8a2be2; }
    .review-item h3 { margin-top:0; color:#8a2be2; }
    .criteria { background:#1e1e27; border-radius:8px; padding:8px 10px; margin:10px 0; font-size:0.9em; line-height:1.6; }
    .criteria small { display:block; color:#ccc; }
    .review-item img { max-width:120px; margin-top:10px; border-radius:8px; border:1px solid #2f2f3b; }
    .info-text { text-align:center; color:#888; font-size:0.85em; margin-top:8px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="assets/МММ_ЛОГО_ОРИГИНАЛ.png" alt="Логотип">
      <h1>Оценка скина</h1>
    </header>

    <div class="upload-section">
      <input type="file" id="skin-upload" accept="image/png" />
      <div class="info-text">Загрузите PNG файл скина (64x64 или 64x32)</div>
      <canvas id="skin-viewer" class="skin-preview"></canvas>
    </div>

    <div class="criterion">
      <label for="line">Лайн / Образ <span id="line-value">5</span></label>
      <input type="range" id="line" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="palette">Палитра <span id="palette-value">5</span></label>


<input type="range" id="palette" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="shade">Реализация / Шейд <span id="shade-value">5</span></label>
      <input type="range" id="shade" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="style">Айдентика / Стилистика <span id="style-value">5</span></label>
      <input type="range" id="style" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="vibe">Общее впечатление / Вайб <span id="vibe-value">5</span></label>
      <input type="range" id="vibe" min="1" max="10" value="5">
    </div>

    <div class="score-display" id="total">Итог: 25 / 90</div>

    <textarea id="title" placeholder="Заголовок рецензии"></textarea>
    <textarea id="text" placeholder="Текст рецензии (до 8500 символов)"></textarea>

    <button class="reset-button" id="reset">Очистить</button>
    <button class="submit-button" id="submit">Сохранить</button>

    <div class="reviews" id="reviews"></div>
  </div>

<script>
/* Основной UI-скрипт — внимательно, все шаблонные строки и проверки на месте */
document.addEventListener('DOMContentLoaded', () => {
  const ranges = ['line','palette','shade','style','vibe'];
  const values = {line:5,palette:5,shade:5,style:5,vibe:5};
  const vibeMultiplier = {1:1,2:1.0675,3:1.1349,4:1.2024,5:1.2699,6:1.3373,7:1.4048,8:1.4723,9:1.5397,10:1.6072};
  let viewer = null;
  let uploadedSkin = null;
  window.uploadedSkin = null;

  function calculateTotal() {
    const baseSum = Number(values.line) + Number(values.palette) + Number(values.shade) + Number(values.style);
    const scaled = baseSum * 1.4;
    const multiplier = vibeMultiplier[Number(values.vibe)] || 1;
    const total = Math.round(scaled * multiplier);
    document.getElementById('total').textContent = Итог: ${total} / 90;
  }

  // инициализация слайдеров
  ranges.forEach(id => {
    const input = document.getElementById(id);
    const label = document.getElementById(${id}-value);
    input.addEventListener('input', () => {
      values[id] = parseInt(input.value, 10);
      label.textContent = input.value;
      calculateTotal();
    });
  });

  // восстановление скина из localStorage, если есть
  const savedSkin = localStorage.getItem('lastSkin');
  if (savedSkin) {
    try {
      uploadedSkin = savedSkin;
      window.uploadedSkin = uploadedSkin;
      viewer = new skinview3d.SkinViewer({
        canvas: document.getElementById('skin-viewer'),
        width: 300,
        height: 400,
        skin: uploadedSkin
      });
      viewer.zoom = 0.9;
      viewer.autoRotate = false;
    } catch (err) {
      console.error('Ошибка при инициализации SkinViewer с сохранённым скином:', err);
      // в крайнем случае очистим сохранение
      localStorage.removeItem('lastSkin');
    }
  }

  // загрузка файла input
  document.getElementById('skin-upload').addEventListener('change', e => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    // небольшая валидация типа/размера (опционально)
    if (!file.type.includes('png')) {
      alert('Только PNG файлы подходят для скинов.');
      return;
    }
    const reader = new FileReader();
    reader.onload = evt => {
      uploadedSkin = evt.target.result;
      window.uploadedSkin = uploadedSkin;
      try {
        localStorage.setItem('lastSkin', uploadedSkin);
      } catch (err) {
        console.warn('Не удалось сохранить skin в localStorage:', err);
      }
      if (!viewer) {
        try {
          viewer = new skinview3d.SkinViewer({
            canvas: document.getElementById('skin-viewer'),
            width: 300,
            height: 400,
            skin: uploadedSkin
          });
          viewer.zoom = 0.9;
          viewer.autoRotate = false;


} catch (err) {
          console.error('Ошибка при создании SkinViewer:', err);
        }
      } else {
        try {
          viewer.loadSkin(uploadedSkin);
        } catch (err) {
          console.error('Ошибка при загрузке скина в viewer:', err);
        }
      }
    };
    reader.onerror = () => {
      alert('Ошибка при чтении файла. Попробуйте другой PNG.');
    };
    reader.readAsDataURL(file);
  });

  // reset кнопка
  document.getElementById('reset').addEventListener('click', () => {
    ranges.forEach(id => {
      values[id] = 5;
      const el = document.getElementById(id);
      if (el) el.value = 5;
      const label = document.getElementById(${id}-value);
      if (label) label.textContent = '5';
    });
    document.getElementById('title').value = '';
    document.getElementById('text').value = '';
    document.getElementById('skin-upload').value = '';
    uploadedSkin = null;
    window.uploadedSkin = null;
    try { localStorage.removeItem('lastSkin'); } catch(e){/* ignore */ }

    // очистим canvas вручную (если viewer не может сбросить)
    try {
      const canvas = document.getElementById('skin-viewer');
      const ctx = canvas.getContext && canvas.getContext('2d');
      if (ctx) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      // если viewer поддерживает loadSkin(null) — пробуем, иначе игнорируем
      if (viewer && typeof viewer.loadSkin === 'function') {
        try { viewer.loadSkin(null); } catch(e) { /* игнорируем */ }
      }
    } catch (err) {
      console.warn('Ошибка при очистке предпросмотра:', err);
    }

    calculateTotal();
  });

  calculateTotal();
});
</script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
    authDomain: "skinsrzt.firebaseapp.com",
    databaseURL: "https://skinsrzt-default-rtdb.firebaseio.com",
    projectId: "skinsrzt",
    storageBucket: "skinsrzt.appspot.com",
    messagingSenderId: "1084042281569",
    appId: "1:1084042281569:web:25872944cf7dac7fd66020",
    measurementId: "G-YSFQLYDWJC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // загрузка отзывов
  async function loadReviews() {
    try {
      const container = document.getElementById('reviews');
      container.innerHTML = '';
      const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(q);
      snapshot.forEach(doc => {
        const r = doc.data();
        const reviewDiv = document.createElement('div');
        reviewDiv.classList.add('review-item');
        const createdStr = (r.createdAt && typeof r.createdAt.toDate === 'function') ? r.createdAt.toDate().toLocaleString() : '';
        reviewDiv.innerHTML = 
          <h3>${escapeHtml(r.title || '')}</h3>
          <p>${escapeHtml(r.text || '')}</p>
          <div class="criteria">
            <small>Лайн / Образ: ${r.line ?? '-'}</small>
            <small>Палитра: ${r.palette ?? '-'}</small>
            <small>Реализация / Шейд: ${r.shade ?? '-'}</small>
            <small>Айдентика / Стилистика: ${r.style ?? '-'}</small>
            <small>Общее впечатление / Вайб: ${r.vibe ?? '-'}</small>
          </div>
          <small><b>Итоговая оценка:</b> ${r.total ?? '-'} / 90</small><br>
          ${createdStr ? <small>${createdStr}</small>` : ''}


${r.skinUrl ? <img src="${r.skinUrl}" alt="skin preview" /> : ''}
        ;
        container.appendChild(reviewDiv);
      });
    } catch (err) {
      console.error('Ошибка при загрузке рецензий:', err);
      const container = document.getElementById('reviews');
      container.innerHTML = '<div style="color:#f88;padding:10px;border-radius:6px;background:#2a1a2a">Ошибка загрузки рецензий. Проверь консоль для деталей.</div>';
    }
  }

  // простая экранизация текста, чтобы не вставлять HTML напрямую
  function escapeHtml(str) {
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;')
      .replaceAll('\n', '<br>');
  }

  // сразу при старте
  loadReviews();

  // отправка рецензии
  document.getElementById('submit').addEventListener('click', async () => {
    const titleEl = document.getElementById('title');
    const textEl = document.getElementById('text');
    const title = titleEl.value.trim();
    const text = textEl.value.trim();
    if (!title || !text) return alert('Введите заголовок и текст рецензии');

    const values = {
      line: parseInt(document.getElementById('line').value, 10),
      palette: parseInt(document.getElementById('palette').value, 10),
      shade: parseInt(document.getElementById('shade').value, 10),
      style: parseInt(document.getElementById('style').value, 10),
      vibe: parseInt(document.getElementById('vibe').value, 10)
    };

    const vibeMultiplier = {1:1,2:1.0675,3:1.1349,4:1.2024,5:1.2699,6:1.3373,7:1.4048,8:1.4723,9:1.5397,10:1.6072};
    const total = Math.round((values.line + values.palette + values.shade + values.style) * 1.4 * (vibeMultiplier[values.vibe] || 1));

    let skinUrl = null;
    try {
      // если есть загруженный скин — загружаем в Storage
      if (window.uploadedSkin) {
        const skinId = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : skin-${Date.now()};
        const skinRef = ref(storage, skins/${skinId}.png`);
        // uploadString принимает data_url
        await uploadString(skinRef, window.uploadedSkin, 'data_url');
        skinUrl = await getDownloadURL(skinRef);
      }

      // добавляем документ в коллекцию reviews
      await addDoc(collection(db, "reviews"), {
        title,
        text,
        total,
        line: values.line,
        palette: values.palette,
        shade: values.shade,
        style: values.style,
        vibe: values.vibe,
        skinUrl: skinUrl,
        createdAt: serverTimestamp()
      });

      alert('✅ Рецензия успешно сохранена!');
      // перезагрузим список отзывов (не обязательно перезагружать страницу)
      loadReviews();
      // очистим форму
      titleEl.value = '';
      textEl.value = '';
      // не удаляем lastSkin — так удобнее, но можно очищать если нужно
    } catch (err) {
      console.error('Ошибка при сохранении рецензии:', err);
      alert('❌ Ошибка при сохранении рецензии: ' + (err && err.message ? err.message : String(err)));
    }
  });
</script>
</body>
</html>
