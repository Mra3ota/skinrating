<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="data:,">
<title>–û—Ü–µ–Ω–∫–∞ —Å–∫–∏–Ω–æ–≤</title>
<style>
  :root{
    --bg:#0e0e12; --card:#14141a; --accent:#8a2be2; --text:#eaeaf2; --muted:#9aa0b2;
  }
  * { box-sizing: border-box; }
  body{ margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); padding:22px; }
  .wrap{ max-width:1400px; margin:0 auto; }
  
  header{ display:flex; align-items:center; gap:16px; margin-bottom:32px; flex-wrap:wrap; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.05); }
  header .logo-section{ display:flex; align-items:center; gap:12px; }
  header .logo-section img{ height:50px; width:auto; }
  header h1{ font-size:1.8rem; font-weight:800; margin:0; letter-spacing:-0.5px; }
  header .nav{ margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  
  .btn{ background:var(--accent); color:#fff; padding:10px 16px; border-radius:8px; text-decoration:none; font-weight:700; cursor:pointer; border:none; transition: all 0.3s ease; font-size:0.95rem; display:inline-flex; align-items:center; justify-content:center; min-width:44px; min-height:44px; }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(138,43,226,0.4); }
  .btn:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
  .btn-secondary{ background:#1f1f28; border: 1px solid rgba(255,255,255,0.08); }
  .btn-secondary:hover{ background:#2a2a35; box-shadow: 0 4px 12px rgba(255,255,255,0.1); }
  
  .controls{ display:flex; gap:12px; margin-bottom:24px; align-items:center; flex-wrap:wrap; position:relative; }
  .controls select, .controls input[type="text"]{ background:#1a1a22; color:var(--text); border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:10px 14px; font-size:0.95rem; cursor:pointer; font-weight:600; min-height:44px; transition: all 0.3s ease; }
  .controls select:hover, .controls input[type="text"]:hover{ border-color: rgba(138,43,226,0.3); background:#1f1f28; }
  .controls select:focus, .controls input[type="text"]:focus{ outline:none; border-color:var(--accent); box-shadow: 0 0 0 3px rgba(138,43,226,0.1); }
  .controls input[type="text"]{ width:280px; }
  
  .cache-section{ margin-left:auto; display:flex; align-items:center; gap:8px; }
  .cache-info{ font-size:0.85rem; color:var(--muted); }
  
  .admin-form{ margin-bottom:24px; padding:24px; background:rgba(138,43,226,0.05); border:1px solid rgba(138,43,226,0.2); border-radius:12px; }
  .admin-form h3{ margin:0 0 16px 0; font-size:1.2rem; color:var(--accent); font-weight:800; }
  .admin-form .form-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
  .admin-form input[type="text"]{ flex:1; min-width:200px; padding:10px 14px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#0e0e12; color:var(--text); font-size:0.95rem; min-height:44px; transition: all 0.3s ease; }
  .admin-form input[type="text"]:hover{ border-color: rgba(138,43,226,0.3); }
  .admin-form input[type="text"]:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(138,43,226,0.1); }
  .file-label{ display:inline-flex; align-items:center; padding:10px 14px; background:#1a1a22; border-radius:8px; cursor:pointer; border:1px solid rgba(255,255,255,0.08); transition: all 0.3s ease; font-size:0.95rem; font-weight:600; min-height:44px; }
  .file-label:hover{ background:#2a2a35; border-color: rgba(138,43,226,0.4); transform: translateY(-1px); }
  
  .dropzone{ border:2px dashed rgba(138,43,226,0.3); border-radius:12px; padding:40px; text-align:center; background:rgba(138,43,226,0.05); cursor:pointer; transition:all 0.3s; margin-top:16px; }
  .dropzone:hover, .dropzone.dragover{ background:rgba(138,43,226,0.15); border-color:var(--accent); }
  .dropzone-text{ color:var(--muted); font-size:0.95rem; }
  
  .upload-progress{ margin-top:12px; display:none; }
  .progress-bar{ width:100%; height:8px; background:rgba(255,255,255,0.1); border-radius:8px; overflow:hidden; }
  .progress-fill{ height:100%; background:linear-gradient(90deg, var(--accent), #9b4dff); transition:width 0.3s; border-radius:8px; }
  
  .preview-mini{ margin-top:12px; width:80px; height:120px; background:#0a0a0f; border-radius:8px; display:none; overflow:hidden; border: 1px solid rgba(255,255,255,0.08); }
  .preview-mini img{ width:100%; height:100%; object-fit:contain; }
  
  .gallery{ display:grid; grid-template-columns:repeat(5, 1fr); gap:16px; }
  .skin-card{ background:var(--card); border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,0.05); cursor:pointer; transition: all 0.3s ease; display:flex; flex-direction:column; opacity:0; animation:fadeInUp 0.5s forwards; }
  .skin-card:hover{ transform: translateY(-4px); box-shadow: 0 8px 24px rgba(138,43,226,0.3); border-color: rgba(138,43,226,0.4); }
  
  @keyframes fadeInUp {
    from{ opacity:0; transform:translateY(20px); }
    to{ opacity:1; transform:translateY(0); }
  }
  
  .skeleton{ background:linear-gradient(90deg, #1a1a22 25%, #242430 50%, #1a1a22 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:8px; }
  @keyframes shimmer{ 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }
  
  .skeleton-card{ background:var(--card); border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,0.05); }
  .skeleton-preview{ width:100%; aspect-ratio:3/4; border-radius:10px; }
  .skeleton-text{ height:16px; margin:8px 0; border-radius:4px; }
  .skeleton-text.short{ width:60%; }
  
  .skin-preview{ width:100%; aspect-ratio:3/4; border-radius:10px; overflow:hidden; background:#0a0a0f; margin-bottom:12px; position:relative; }
  .skin-preview img{ width:100%; height:100%; object-fit:contain; }
  .loading-spinner{ width:40px; height:40px; border:3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius:50%; animation: spin 0.8s linear infinite; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
  @keyframes spin{ to{ transform: translate(-50%,-50%) rotate(360deg); } }
  
  .skin-info{ flex:1; }
  .skin-name{ font-weight:700; font-size:1.05rem; margin-bottom:6px; line-height:1.3; }
  .skin-author{ color:var(--muted); font-size:0.9rem; margin-bottom:8px; }
  .skin-stats{ display:flex; gap:12px; font-size:0.85rem; color:var(--muted); margin-bottom:8px; flex-wrap:wrap; }
  .skin-score{ background:linear-gradient(135deg, rgba(138,43,226,0.2), rgba(155,77,255,0.2)); padding:8px 12px; border-radius:8px; font-weight:700; text-align:center; border: 1px solid rgba(138,43,226,0.3); font-size:0.95rem; }
  
  .empty-msg{ text-align:center; padding:60px 20px; color:var(--muted); font-size:1.1rem; }
  .hidden{ display:none !important; }
  
  @media (max-width:1200px){ .gallery{ grid-template-columns:repeat(4, 1fr); } }
  @media (max-width:900px){ .gallery{ grid-template-columns:repeat(3, 1fr); } }
  @media (max-width:640px){ 
    .gallery{ grid-template-columns:repeat(2, 1fr); }
    .controls input[type="text"]{ width:100%; }
    .cache-section{ margin-left:0; width:100%; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo-section">
        <a href="https://t.me/MeatMakers" target="_blank">
          <img src="assets/–ú–ú–ú_–õ–û–ì–û_–û–†–ò–ì–ò–ù–ê–õ.png" alt="–õ–æ–≥–æ—Ç–∏–ø –ú–ú–ú" onerror="this.style.display='none'">
        </a>
        <h1>–û—Ü–µ–Ω–∫–∞ —Å–∫–∏–Ω–æ–≤</h1>
      </div>
      <div class="nav">
        <a href="contests.html" class="btn btn-secondary" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ø–∏—Å–∫—É –∫–æ–Ω–∫—É—Ä—Å–æ–≤">–ö–æ–Ω–∫—É—Ä—Å—ã</a>
        <button id="infoBtn" class="btn btn-secondary" aria-label="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è">‚ÑπÔ∏è –û—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ</button>
        <button id="signBtn" class="btn" aria-label="–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç">–í–æ–π—Ç–∏</button>
      </div>
    </header>

    <div id="adminWrap" class="admin-form hidden">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–Ω (–∞–¥–º–∏–Ω)</h3>
      <div class="form-row">
        <input id="skinName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∏–Ω–∞" maxlength="100" aria-label="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∏–Ω–∞">
        <input id="skinAuthor" type="text" placeholder="–ê–≤—Ç–æ—Ä" maxlength="100" aria-label="–ò–º—è –∞–≤—Ç–æ—Ä–∞">
        <label class="file-label" tabindex="0">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª <input id="fileInput" type="file" accept=".png,.jpg,.jpeg" style="display:none" aria-label="–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª —Å–∫–∏–Ω–∞"></label>
        <button id="addBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        <span id="adminMsg" style="margin-left:8px; font-size:0.9rem;"></span>
      </div>
      <div class="dropzone" id="dropzone">
        <div class="dropzone-text">üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
      </div>
      <div class="preview-mini" id="previewMini"><img id="previewImg" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–∫–∏–Ω–∞"></div>
      <div class="upload-progress" id="uploadProgress">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div style="margin-top:4px; font-size:0.85rem; color:var(--muted);" id="progressText">–ó–∞–≥—Ä—É–∑–∫–∞: 0%</div>
      </div>
    </div>

    <div class="controls">
      <label style="font-weight:600; margin-right:8px;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
      <select id="sortSelect" aria-label="–í—ã–±—Ä–∞—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É">
        <option value="date">–ü–æ –¥–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</option>
        <option value="rating">–ü–æ —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–µ</option>
      </select>
      
      <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ—Ä—É..." aria-label="–ü–æ–∏—Å–∫ –ø–æ –∞–≤—Ç–æ—Ä—É">
      
      <div class="cache-section">
        <button id="refreshBtn" class="btn btn-secondary" style="padding:8px 12px; min-width:auto;" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" aria-label="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">üîÑ</button>
        <div class="cache-info">
          <div id="cacheIndicator" style="font-size:0.8rem;"></div>
        </div>
      </div>
    </div>

    <div id="gallery" class="gallery">
      <!-- Skeleton loaders -->
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="infoModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(4px);" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div style="background:var(--card); border-radius:16px; padding:24px; max-width:700px; width:100%; max-height:80vh; overflow-y:auto; border:1px solid rgba(138,43,226,0.2); box-shadow:0 8px 32px rgba(0,0,0,0.6); position:relative;">
      <button id="closeModal" style="position:absolute; top:12px; right:12px; width:32px; height:32px; background:rgba(255,255,255,0.08); border:none; border-radius:8px; cursor:pointer; font-size:1.5rem; color:var(--text); transition:all 0.2s ease; display:flex; align-items:center; justify-content:center;" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ">√ó</button>
      <h2 id="modalTitle" style="margin:0 0 16px 0; font-size:1.5rem; color:var(--accent); font-weight:800; letter-spacing:-0.5px;">–°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏—è</h2>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">–ü—Ä–∏ –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ 90 –±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª—ã. –°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 4 —á–∏—Å–ª–æ–≤—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –∏ 1 –º–Ω–æ–∂–∏—Ç–µ–ª—å.</p>
      
      <h3 style="margin:16px 0 8px 0; font-size:1.1rem; color:var(--text); font-weight:700; letter-spacing:-0.2px;">–õ–∞–π–Ω / –û–±—Ä–∞–∑ (1-10)</h3>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">–û—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –æ–±—â–∞—è –∏–¥–µ—è –ª–∞–π–Ω–∞, –µ–≥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ—Å—Ç—å –¥–µ—Ç–∞–ª–µ–π.</p>
      
      <h3 style="margin:16px 0 8px 0; font-size:1.1rem; color:var(--text); font-weight:700; letter-spacing:-0.2px;">–ü–∞–ª–∏—Ç—Ä–∞ (1-10)</h3>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">–û—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥–±–æ—Ä —Ü–≤–µ—Ç–æ–≤, –∏—Ö —Å–æ—á–µ—Ç–∞–Ω–∏–µ –∏ –æ–±—â–∞—è –ø—Ä–∏—è—Ç–Ω–æ—Å—Ç—å –¥–ª—è –≥–ª–∞–∑–∞.</p>
      
      <h3 style="margin:16px 0 8px 0; font-size:1.1rem; color:var(--text); font-weight:700; letter-spacing:-0.2px;">–†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –®–µ–π–¥ (1-10)</h3>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">–û—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–¥–µ–∏ –∏ —É–º–µ—Å—Ç–Ω–æ—Å—Ç—å —à–µ–π–¥–∏–Ω–≥–∞.</p>
      
      <h3 style="margin:16px 0 8px 0; font-size:1.1rem; color:var(--text); font-weight:700; letter-spacing:-0.2px;">–ê–π–¥–µ–Ω—Ç–∏–∫–∞ / –°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞ (1-10)</h3>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">–û—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏ —É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å —Å—Ç–∏–ª—è.</p>
      
      <h3 style="margin:16px 0 8px 0; font-size:1.1rem; color:var(--text); font-weight:700; letter-spacing:-0.2px;">–û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ / –í–∞–π–± (–º–Ω–æ–∂–∏—Ç–µ–ª—å 1-10)</h3>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">–°—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –æ–±—â–µ–≥–æ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –æ—Ç —Å–∫–∏–Ω–∞.</p>
      
      <p style="margin-top:20px;padding:12px;background:rgba(138,43,226,0.12);border-radius:8px;border-left:3px solid var(--accent); line-height:1.7; color:var(--muted);"><strong>–ò—Ç–æ–≥–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞:</strong><br>–ë–∞–ª–ª = (–õ–∞–π–Ω + –ü–∞–ª–∏—Ç—Ä–∞ + –†–µ–∞–ª–∏–∑–∞—Ü–∏—è + –°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞) √ó 1.4 √ó –ú–Ω–æ–∂–∏—Ç–µ–ª—å_–≤–∞–π–±–∞<br><strong>–ú–∞–∫—Å–∏–º—É–º: 90 –±–∞–ª–ª–æ–≤</strong></p>
    </div>
  </div>

  <script src="https://unpkg.com/skinview3d/bundles/skinview3d.bundle.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, where, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithRedirect, getRedirectResult, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
      authDomain: "skinsrzt.firebaseapp.com",
      projectId: "skinsrzt",
      storageBucket: "skinsrzt.appspot.com",
      messagingSenderId: "1084042281569",
      appId: "1:1084042281569:web:25872944cf7dac7fd66020"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const ADMIN_EMAIL = "nmprokhorov@gmail.com";
    const CACHE_DURATION = 2 * 60 * 60 * 1000; // 2 —á–∞—Å–∞
    const CACHE_KEY_SKINS = 'skins_cache';
    const CACHE_KEY_SCORES = 'skin_scores_cache';
    const CACHE_KEY_TIMESTAMP = 'cache_timestamp';
    
    const adminWrap = document.getElementById('adminWrap');
    const skinName = document.getElementById('skinName');
    const skinAuthor = document.getElementById('skinAuthor');
    const fileInput = document.getElementById('fileInput');
    const addBtn = document.getElementById('addBtn');
    const adminMsg = document.getElementById('adminMsg');
    const gallery = document.getElementById('gallery');
    const sortSelect = document.getElementById('sortSelect');
    const signBtn = document.getElementById('signBtn');
    const infoBtn = document.getElementById('infoBtn');
    const infoModal = document.getElementById('infoModal');
    const closeModal = document.getElementById('closeModal');
    const refreshBtn = document.getElementById('refreshBtn');
    const cacheIndicator = document.getElementById('cacheIndicator');
    const searchInput = document.getElementById('searchInput');
    const dropzone = document.getElementById('dropzone');
    const previewMini = document.getElementById('previewMini');
    const previewImg = document.getElementById('previewImg');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    let currentUser = null;
    let currentUserDisplayName = null;
    let skins = {};
    let scores = {};
    let searchTerm = '';
    
    // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    function saveToCache(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch(e) {
        console.log('Cache save error:', e);
      }
    }
    
    function loadFromCache(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      } catch(e) {
        console.log('Cache load error:', e);
        return null;
      }
    }
    
    function isCacheValid() {
      const timestamp = localStorage.getItem(CACHE_KEY_TIMESTAMP);
      if (!timestamp) return false;
      return (Date.now() - parseInt(timestamp)) < CACHE_DURATION;
    }
    
    function updateCacheIndicator() {
      const timestamp = localStorage.getItem(CACHE_KEY_TIMESTAMP);
      if (timestamp && isCacheValid()) {
        const date = new Date(parseInt(timestamp));
        cacheIndicator.textContent = `–î–∞–Ω–Ω—ã–µ –æ—Ç ${date.toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'})}`;
      } else {
        cacheIndicator.textContent = '–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
      }
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ URL —Å–∫–∏–Ω–∞
    function getSkinUrl(skin) {
      if (skin.skinUrl) return skin.skinUrl;
      if (skin.skinData) return skin.skinData;
      return '/assets/placeholder.png';
    }

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    infoBtn.addEventListener('click', () => { infoModal.style.display = 'flex'; });
    closeModal.addEventListener('click', () => { infoModal.style.display = 'none'; });
    infoModal.addEventListener('click', (e) => { if (e.target === infoModal) infoModal.style.display = 'none'; });

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    const provider = new GoogleAuthProvider();
    signBtn.addEventListener('click', async () => {
      if (!currentUser) {
        try { await signInWithPopup(auth, provider); } 
        catch(e){ alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + e.message); }
      } else {
        await signOut(auth);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      const isAdmin = user && user.email === ADMIN_EMAIL;

      signBtn.textContent = user ? (isAdmin ? 'üîß –ê–¥–º–∏–Ω' : '–í—ã–π—Ç–∏') : '–í–æ–π—Ç–∏';
      adminWrap.classList.toggle('hidden', !isAdmin);

      // === NICKNAME SYSTEM ===
      if (user) {
          try {
              const userDocRef = doc(db, "users", user.uid);
              const userDoc = await getDoc(userDocRef);

              if (userDoc.exists()) {
                  currentUserDisplayName = userDoc.data().displayName || user.email.split("@")[0];
              } else {
                  const defaultName = user.displayName || user.email.split("@")[0];
                  await setDoc(userDocRef, {
                      displayName: defaultName,
                      email: user.email,
                      createdAt: serverTimestamp()
                  });
                  currentUserDisplayName = defaultName;

                  setTimeout(() => {
                      if (confirm(`üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${defaultName}!\n\n–•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º?`)) {
                          openNicknameModal();
                      }
                  }, 800);
              }
              showNicknameButton();
          } catch (e) {
              console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è:", e);
              currentUserDisplayName = user.email.split("@")[0];
          }
      } else {
          currentUserDisplayName = null;
          hideNicknameButton();
      }
    });

    // Drag and drop
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFileSelect(file);
    });
    
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFileSelect(file);
    });
    
    function handleFileSelect(file) {
      if (!file.type.includes('png') && !file.type.includes('jpeg')) {
        alert('–¢–æ–ª—å–∫–æ PNG –∏ JPEG —Ñ–∞–π–ª—ã');
        return;
      }
      if (file.size > 1024 * 1024) {
        alert('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 1MB');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewMini.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∏–Ω–∞ (–∑–∞–≥—Ä—É–∑–∫–∞ –≤ Storage)
    addBtn.addEventListener('click', async () => {
      adminMsg.textContent = '';
      if (!currentUser || currentUser.email !== ADMIN_EMAIL) { 
        adminMsg.textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –∞–¥–º–∏–Ω–∞'; 
        return; 
      }
      
      const name = (skinName.value || '').trim();
      const author = (skinAuthor.value || '').trim();
      const file = fileInput.files[0];
      
      if (!name) { adminMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∏–Ω–∞'; return; }
      if (!author) { adminMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –∞–≤—Ç–æ—Ä–∞'; return; }
      if (!file) { adminMsg.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'; return; }
      
      try {
        uploadProgress.style.display = 'block';
        addBtn.disabled = true;
        
        // –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç —Å–Ω–∞—á–∞–ª–∞
        const docRef = doc(collection(db, 'skins'));
        const docId = docRef.id;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ Storage
        const storageRef = ref(storage, `gallery-skins/${docId}.png`);
        const uploadTask = uploadBytesResumable(storageRef, file);
        
        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressFill.style.width = progress + '%';
            progressText.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${Math.round(progress)}%`;
          },
          (error) => {
            console.error(error);
            adminMsg.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
            adminMsg.style.color = '#f87171';
            uploadProgress.style.display = 'none';
            addBtn.disabled = false;
          },
          async () => {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            
            await setDoc(docRef, {
              name: name,
              author: author,
              skinUrl: downloadURL,
              createdAt: serverTimestamp()
            });
            
            adminMsg.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ';
            adminMsg.style.color = '#4ade80';
            skinName.value = '';
            skinAuthor.value = '';
            fileInput.value = '';
            previewMini.style.display = 'none';
            uploadProgress.style.display = 'none';
            progressFill.style.width = '0%';
            addBtn.disabled = false;
            
            localStorage.removeItem(CACHE_KEY_TIMESTAMP);
            
            setTimeout(() => { adminMsg.textContent = ''; adminMsg.style.color = ''; }, 2000);
          }
        );
      } catch(e) {
        console.error(e);
        adminMsg.textContent = '–û—à–∏–±–∫–∞: ' + (e.message || e);
        adminMsg.style.color = '#f87171';
        addBtn.disabled = false;
        uploadProgress.style.display = 'none';
      }
    });

    // –ü–æ–∏—Å–∫
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchTerm = e.target.value.trim().toLowerCase();
        renderGallery();
      }, 300);
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      if (isCacheValid()) {
        const cachedSkins = loadFromCache(CACHE_KEY_SKINS);
        const cachedScores = loadFromCache(CACHE_KEY_SCORES);
        
        if (cachedSkins && cachedScores) {
          console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –∫—ç—à–∞');
          skins = cachedSkins;
          scores = cachedScores;
          updateCacheIndicator();
          renderGallery();
          return;
        }
      }
      
      showSkeletons();
      setupRealtimeListeners();
    }
    
    function showSkeletons() {
      gallery.innerHTML = '';
      for (let i = 0; i < 10; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'skeleton-card';
        skeleton.innerHTML = `
          <div class="skeleton skeleton-preview"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text short"></div>
          <div class="skeleton skeleton-text short"></div>
        `;
        gallery.appendChild(skeleton);
      }
    }
    
    function setupRealtimeListeners() {
      const skinsQ = query(collection(db, 'skins'), orderBy('createdAt', 'desc'));
      onSnapshot(skinsQ, snap => {
        snap.docChanges().forEach(ch => {
          const id = ch.doc.id;
          if (ch.type === 'removed') {
            delete skins[id];
          } else {
            skins[id] = { id, ...ch.doc.data() };
          }
        });
        saveToCache(CACHE_KEY_SKINS, skins);
        localStorage.setItem(CACHE_KEY_TIMESTAMP, Date.now().toString());
        updateCacheIndicator();
        renderGallery();
      });

      const scoresQ = query(collection(db, 'skin_scores'), orderBy('createdAt', 'asc'));
      onSnapshot(scoresQ, snap => {
        snap.docChanges().forEach(ch => {
          const data = ch.doc.data();
          const skinId = data.skinId;
          
          if (ch.type === 'removed') {
            if (scores[skinId]) {
              scores[skinId] = scores[skinId].filter(s => s.id !== ch.doc.id);
              if (scores[skinId].length === 0) delete scores[skinId];
            }
          } else {
            if (!scores[skinId]) scores[skinId] = [];
            const existingIndex = scores[skinId].findIndex(s => s.id === ch.doc.id);
            if (existingIndex >= 0) {
              scores[skinId][existingIndex] = { id: ch.doc.id, ...data };
            } else {
              scores[skinId].push({ id: ch.doc.id, ...data });
            }
          }
        });
        saveToCache(CACHE_KEY_SCORES, scores);
        renderGallery();
      });
    }

    sortSelect.addEventListener('change', renderGallery);
    refreshBtn.addEventListener('click', () => {
      localStorage.removeItem(CACHE_KEY_TIMESTAMP);
      refreshBtn.disabled = true;
      refreshBtn.textContent = '‚è≥';
      showSkeletons();
      setupRealtimeListeners();
      setTimeout(() => {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'üîÑ';
      }, 2000);
    });

    function renderGallery() {
      let arr = Object.values(skins).map(skin => {
        const skinScores = scores[skin.id] || [];
        const count = skinScores.length;
        const sum = skinScores.reduce((a, b) => a + (b.total || 0), 0);
        const avg = count ? Math.ceil(sum / count) : 0;
        return { ...skin, scoreCount: count, avgScore: avg };
      });

      // –ü–æ–∏—Å–∫
      if (searchTerm) {
        arr = arr.filter(s => s.author && s.author.toLowerCase().includes(searchTerm));
      }

      if (!arr.length) {
        gallery.innerHTML = '<div class="empty-msg">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        return;
      }

      const sortBy = sortSelect.value;
      if (sortBy === 'rating') {
        arr.sort((a, b) => b.avgScore - a.avgScore);
      } else {
        arr.sort((a, b) => {
          const timeA = a.createdAt?.seconds || 0;
          const timeB = b.createdAt?.seconds || 0;
          return timeB - timeA;
        });
      }

      gallery.innerHTML = '';
      
      arr.forEach((skin, idx) => {
        const card = document.createElement('div');
        card.className = 'skin-card';
        card.style.animationDelay = `${idx * 0.05}s`;
        
        const dateStr = skin.createdAt ? new Date(skin.createdAt.seconds * 1000).toLocaleDateString('ru-RU') : '';
        
        card.innerHTML = `
          <div class="skin-preview" id="preview_${skin.id}">
            <div class="loading-spinner"></div>
          </div>
          <div class="skin-info">
            <div class="skin-name">${escapeHtml(skin.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
            <div class="skin-author">–ê–≤—Ç–æ—Ä: ${escapeHtml(skin.author || '‚Äî')}</div>
            <div class="skin-stats">
              <span>–û—Ü–µ–Ω–æ–∫: ${skin.scoreCount}</span>
              ${dateStr ? `<span>${dateStr}</span>` : ''}
            </div>
            <div class="skin-score">–ë–∞–ª–ª: ${skin.avgScore} / 90</div>
          </div>
        `;
        
        card.addEventListener('click', () => location.href = `skin-view.html?id=${skin.id}`);
        card.setAttribute('tabindex', '0');
        card.setAttribute('role', 'button');
        card.setAttribute('aria-label', `–û—Ç–∫—Ä—ã—Ç—å —Å–∫–∏–Ω ${skin.name} –∞–≤—Ç–æ—Ä–∞ ${skin.author}`);
        card.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') location.href = `skin-view.html?id=${skin.id}`;
        });
        gallery.appendChild(card);
        
        if (skin.skinUrl || skin.skinData) {
          setTimeout(() => init3DPreview(`preview_${skin.id}`, getSkinUrl(skin)), 50);
        }
      });
    }

    const previewCache = new Map();
    let activeViewers = 0;
    const MAX_VIEWERS = 10;
    
    async function init3DPreview(containerId, skinUrl) {
      const container = document.getElementById(containerId);
      if (!container || !skinUrl) return;
      
      if (previewCache.has(skinUrl)) {
        const img = document.createElement('img');
        img.src = previewCache.get(skinUrl);
        img.alt = "–ü—Ä–µ–≤—å—é —Å–∫–∏–Ω–∞";
        img.loading = "lazy";
        container.innerHTML = '';
        container.appendChild(img);
        return;
      }
      
      while (activeViewers >= MAX_VIEWERS) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      activeViewers++;
      
      try {
        const img = document.createElement('img');
        img.src = skinUrl;
        img.alt = "–ü—Ä–µ–≤—å—é —Å–∫–∏–Ω–∞";
        img.loading = "lazy";
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        container.innerHTML = '';
        container.appendChild(img);
        
        const off = document.createElement('canvas');
        const targetWidth = 320;
        const targetHeight = Math.round(targetWidth * 1.35);
        off.width = targetWidth;
        off.height = targetHeight;
        
        const viewer = new skinview3d.SkinViewer({
          canvas: off,
          width: targetWidth,
          height: targetHeight,
          preserveDrawingBuffer: true
        });
        
        try { viewer.renderer.setClearColor(0x15151c, 1); } catch(_) {}
        await viewer.loadSkin(skinUrl);
        viewer.zoom = 0.95;
        viewer.autoRotate = false;
        
        try {
          const walk = new skinview3d.WalkingAnimation(viewer);
          walk.speed = 1.0;
          walk.paused = true;
          walk.progress = 0.30;
          viewer.playerObject.rotation.y = -0.4;
          viewer.camera.position.set(0, 24, 46);
          viewer.camera.lookAt(0, 18, 0);
        } catch(e) {
          try { viewer.playerObject.rotation.y = -0.4; } catch(_) {}
        }
        
        await new Promise(res => requestAnimationFrame(() => requestAnimationFrame(res)));
        
        const renderedDataUrl = off.toDataURL('image/png', 0.8);
        if (previewCache.size >= 50) {
          const firstKey = previewCache.keys().next().value;
          previewCache.delete(firstKey);
        }
        previewCache.set(skinUrl, renderedDataUrl);
        
        img.src = renderedDataUrl;
        
        try { viewer.dispose(); } catch(e) {}
      } catch(e) {
        console.error('3D preview error:', e);
      } finally {
        activeViewers--;
      }
    }

    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
    
    updateCacheIndicator();
    loadData();
  

    // ============================================
    // NICKNAME MODAL SYSTEM
    // ============================================
    let nicknameModal = null;

    function createNicknameModal() {
        if (nicknameModal) return;

        const modalHTML = `
            <div id="nicknameModal" style="
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.92);
                backdrop-filter: blur(10px);
                z-index: 10000;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.2s ease;
            ">
                <div style="
                    background: var(--card);
                    border-radius: 20px;
                    padding: 32px;
                    max-width: 440px;
                    width: 100%;
                    border: 1px solid rgba(138,43,226,0.3);
                    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
                    animation: slideUp 0.3s ease;
                ">
                    <h2 style="
                        margin: 0 0 8px 0;
                        font-size: 1.6rem;
                        font-weight: 800;
                        background: linear-gradient(135deg, #8a2be2, #da70d6);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                    ">
                        ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º
                    </h2>
                    <p style="
                        margin: 0 0 24px 0;
                        color: var(--muted);
                        font-size: 0.9rem;
                    ">
                        –≠—Ç–æ –∏–º—è –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                    </p>
                    <input 
                        type="text" 
                        id="nicknameInput" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º"
                        maxlength="30"
                        style="
                            width: 100%;
                            background: #0b0b0e;
                            border: 2px solid rgba(255,255,255,0.08);
                            color: var(--text);
                            padding: 14px 16px;
                            border-radius: 12px;
                            font-size: 1rem;
                            font-weight: 500;
                            margin-bottom: 20px;
                            transition: all 0.3s ease;
                            outline: none;
                            box-sizing: border-box;
                        "
                    />
                    <div style="display: flex; gap: 12px;">
                        <button id="saveNicknameBtn" class="btn" style="
                            flex: 1;
                            background: linear-gradient(135deg, #8a2be2, #6a1bb2);
                            box-shadow: 0 4px 12px rgba(138,43,226,0.3);
                        ">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button id="cancelNicknameBtn" style="
                            flex: 1;
                            background: rgba(255,255,255,0.05);
                            color: var(--text);
                            padding: 12px 18px;
                            border-radius: 10px;
                            border: 1px solid rgba(255,255,255,0.1);
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                    <div id="nicknameStatus" style="
                        margin-top: 16px;
                        font-size: 0.9rem;
                        text-align: center;
                        font-weight: 600;
                        min-height: 20px;
                    "></div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        nicknameModal = document.getElementById("nicknameModal");

        const input = document.getElementById("nicknameInput");
        const saveBtn = document.getElementById("saveNicknameBtn");
        const cancelBtn = document.getElementById("cancelNicknameBtn");
        const status = document.getElementById("nicknameStatus");

        input.addEventListener("focus", () => {
            input.style.borderColor = "var(--accent)";
            input.style.boxShadow = "0 0 0 4px rgba(138,43,226,0.15)";
        });
        input.addEventListener("blur", () => {
            input.style.borderColor = "rgba(255,255,255,0.08)";
            input.style.boxShadow = "none";
        });

        cancelBtn.addEventListener("mouseenter", () => {
            cancelBtn.style.background = "rgba(255,255,255,0.08)";
        });
        cancelBtn.addEventListener("mouseleave", () => {
            cancelBtn.style.background = "rgba(255,255,255,0.05)";
        });

        saveBtn.addEventListener("click", async () => {
            const newName = input.value.trim();

            if (!newName) {
                status.innerHTML = "‚ùå –ù–∏–∫–Ω–µ–π–º –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º";
                status.style.color = "#f87171";
                return;
            }

            if (newName.length < 2) {
                status.innerHTML = "‚ùå –ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞";
                status.style.color = "#f87171";
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = "‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
            status.textContent = "";

            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, {
                    displayName: newName,
                    updatedAt: serverTimestamp()
                });

                currentUserDisplayName = newName;
                status.innerHTML = "‚úÖ –ù–∏–∫–Ω–µ–π–º –æ–±–Ω–æ–≤–ª–µ–Ω!";
                status.style.color = "#4ade80";

                setTimeout(() => {
                    closeNicknameModal();
                    location.reload();
                }, 1200);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞:", e);
                status.innerHTML = `‚ùå ${e.message}`;
                status.style.color = "#f87171";
                saveBtn.disabled = false;
                saveBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
            }
        });

        cancelBtn.addEventListener("click", closeNicknameModal);

        nicknameModal.addEventListener("click", (e) => {
            if (e.target === nicknameModal) closeNicknameModal();
        });

        document.addEventListener("keydown", (e) => {
            if (!nicknameModal || nicknameModal.style.display === "none") return;
            if (e.key === "Enter") saveBtn.click();
            else if (e.key === "Escape") closeNicknameModal();
        });
    }

    function openNicknameModal() {
        createNicknameModal();
        const input = document.getElementById("nicknameInput");
        const saveBtn = document.getElementById("saveNicknameBtn");
        const status = document.getElementById("nicknameStatus");

        input.value = currentUserDisplayName || "";
        saveBtn.disabled = false;
        saveBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        status.textContent = "";

        nicknameModal.style.display = "flex";
        setTimeout(() => input.focus(), 150);
    }

    function closeNicknameModal() {
        if (nicknameModal) {
            nicknameModal.style.display = "none";
        }
    }

    function showNicknameButton() {
        let btn = document.getElementById("editNicknameBtn");
        if (!btn) {
            btn = document.createElement("button");
            btn.id = "editNicknameBtn";
            btn.className = "btn";
            btn.innerHTML = `
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right: 6px;">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                <span class="nickname-text">${currentUserDisplayName}</span>
            `;
            btn.style.cssText = `
                background: rgba(138,43,226,0.12);
                border: 1px solid rgba(138,43,226,0.25);
                color: var(--text);
            `;
            btn.addEventListener("click", openNicknameModal);
            signBtn.parentNode.insertBefore(btn, signBtn);
        } else {
            btn.querySelector(".nickname-text").textContent = currentUserDisplayName;
        }
    }

    function hideNicknameButton() {
        const btn = document.getElementById("editNicknameBtn");
        if (btn) btn.remove();
    }

    // CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);

</script>
</body>
</html>
