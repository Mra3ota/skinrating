<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="data:,">
<title>Оценка скинов</title>
<style>
  :root{
    --bg:#0e0e12; --card:#14141a; --accent:#8a2be2; --text:#eaeaf2; --muted:#9aa0b2;
  }
  * { box-sizing: border-box; }
  body{ margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); padding:22px; }
  .wrap{ max-width:1400px; margin:0 auto; }
  
  header{ display:flex; align-items:center; gap:16px; margin-bottom:32px; flex-wrap:wrap; padding-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.05); }
  header .logo-section{ display:flex; align-items:center; gap:12px; }
  header .logo-section img{ height:50px; width:auto; }
  header h1{ font-size:1.8rem; font-weight:800; margin:0; letter-spacing:-0.5px; }
  header .nav{ margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  
  .btn{ background:var(--accent); color:#fff; padding:10px 16px; border-radius:8px; text-decoration:none; font-weight:700; cursor:pointer; border:none; transition: all 0.3s ease; font-size:0.95rem; display:inline-block; }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(138,43,226,0.4); }
  .btn-secondary{ background:#333; }
  
  .controls{ display:flex; gap:12px; margin-bottom:24px; align-items:center; flex-wrap:wrap; }
  .controls select{ background:#1a1a22; color:var(--text); border:1px solid rgba(255,255,255,0.08); border-radius:8px; padding:10px 14px; font-size:0.95rem; cursor:pointer; font-weight:600; }
  .controls select:focus{ outline:none; border-color:var(--accent); }
  
  .admin-form{ margin-bottom:24px; padding:20px; background:rgba(138,43,226,0.05); border:1px solid rgba(138,43,226,0.2); border-radius:12px; }
  .admin-form h3{ margin:0 0 16px 0; font-size:1.2rem; }
  .admin-form .form-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
  .admin-form input[type="text"]{ flex:1; min-width:200px; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:#0e0e12; color:var(--text); font-size:0.95rem; }
  .admin-form input[type="text"]:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(138,43,226,0.1); }
  .file-label{ display:inline-block; padding:10px 14px; background:#1a1a22; border-radius:8px; cursor:pointer; border:1px solid rgba(255,255,255,0.08); transition: all 0.2s ease; font-size:0.95rem; font-weight:600; }
  .file-label:hover{ background:#242430; border-color: rgba(138,43,226,0.4); }
  
  .gallery{ display:grid; grid-template-columns:repeat(5, 1fr); gap:16px; }
  .skin-card{ background:var(--card); border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,0.05); cursor:pointer; transition: all 0.3s ease; display:flex; flex-direction:column; }
  .skin-card:hover{ transform: translateY(-4px); box-shadow: 0 8px 24px rgba(138,43,226,0.3); border-color: rgba(138,43,226,0.4); }
  
  .skin-preview{ width:100%; aspect-ratio:3/4; border-radius:10px; overflow:hidden; background:#0a0a0f; margin-bottom:12px; position:relative; }
  .skin-preview img{ width:100%; height:100%; object-fit:contain; }
  .loading-spinner{ width:40px; height:40px; border:3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius:50%; animation: spin 0.8s linear infinite; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
  @keyframes spin{ to{ transform: translate(-50%,-50%) rotate(360deg); } }
  
  .skin-info{ flex:1; }
  .skin-name{ font-weight:700; font-size:1.05rem; margin-bottom:6px; line-height:1.3; }
  .skin-author{ color:var(--muted); font-size:0.9rem; margin-bottom:8px; }
  .skin-stats{ display:flex; gap:12px; font-size:0.85rem; color:var(--muted); margin-bottom:8px; }
  .skin-score{ background:rgba(138,43,226,0.2); padding:6px 12px; border-radius:8px; font-weight:700; text-align:center; border: 1px solid rgba(138,43,226,0.3); }
  
  .empty-msg{ text-align:center; padding:60px 20px; color:var(--muted); font-size:1.1rem; }
  .hidden{ display:none; }
  
  @media (max-width:1200px){ .gallery{ grid-template-columns:repeat(4, 1fr); } }
  @media (max-width:900px){ .gallery{ grid-template-columns:repeat(3, 1fr); } }
  @media (max-width:640px){ .gallery{ grid-template-columns:repeat(2, 1fr); } }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo-section">
        <a href="https://t.me/MeatMakers" target="_blank">
          <img src="assets/МММ_ЛОГО_ОРИГИНАЛ.png" alt="Логотип" onerror="this.style.display='none'">
        </a>
        <h1>Оценка скинов</h1>
      </div>
      <div class="nav">
        <a href="results.html" class="btn btn-secondary">Итоги конкурса</a>
        <button id="infoBtn" class="btn btn-secondary">ℹ️ Оценивание</button>
        <button id="signBtn" class="btn">Войти</button>
      </div>
    </header>

    <div id="adminWrap" class="admin-form hidden">
      <h3>Добавить скин (админ)</h3>
      <div class="form-row">
        <input id="skinName" type="text" placeholder="Название скина" maxlength="100">
        <input id="skinAuthor" type="text" placeholder="Автор" maxlength="100">
        <label class="file-label">Выбрать файл <input id="fileInput" type="file" accept=".png,.jpg,.jpeg" style="display:none"></label>
        <button id="addBtn" class="btn">Добавить</button>
        <span id="adminMsg" style="margin-left:8px; font-size:0.9rem;"></span>
      </div>
    </div>

    <div class="controls">
      <label style="font-weight:600; margin-right:8px;">Сортировка:</label>
      <select id="sortSelect">
        <option value="date">По дате добавления</option>
        <option value="rating">По средней оценке</option>
      </select>
    </div>

    <div id="gallery" class="gallery">
      <div class="empty-msg">Загрузка скинов...</div>
    </div>
  </div>

  <!-- Модальное окно с информацией -->
  <div id="infoModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(4px);">
    <div style="background:var(--card); border-radius:16px; padding:24px; max-width:700px; width:100%; max-height:80vh; overflow-y:auto; border:1px solid rgba(138,43,226,0.2); box-shadow:0 8px 32px rgba(0,0,0,0.6); position:relative;">
      <button id="closeModal" style="position:absolute; top:12px; right:12px; width:32px; height:32px; background:rgba(255,255,255,0.08); border:none; border-radius:8px; cursor:pointer; font-size:1.5rem; color:var(--text); transition:all 0.2s ease; display:flex; align-items:center; justify-content:center;">×</button>
      <h2 style="margin:0 0 16px 0; font-size:1.5rem; color:var(--accent); font-weight:800; letter-spacing:-0.5px;">Система оценивания</h2>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">При оценивании используется система на основе 90 бальной шкалы. Система состоит из 4 числовых критериев и 1 множителя.</p>
      
      <h3 style="margin:16px 0 8px 0; font-size:1.1rem; color:var(--text); font-weight:700; letter-spacing:-0.2px;">Лайн / Образ (1-10)</h3>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">Оценивается общая идея лайна, его реализация, оригинальность и интересность деталей.</p>
      
      <h3 style="margin:16px 0 8px 0; font-size:1.1rem; color:var(--text); font-weight:700; letter-spacing:-0.2px;">Палитра (1-10)</h3>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">Оценивается подбор цветов, их сочетание и общая приятность для глаза.</p>
      
      <h3 style="margin:16px 0 8px 0; font-size:1.1rem; color:var(--text); font-weight:700; letter-spacing:-0.2px;">Реализация / Шейд (1-10)</h3>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">Оценивается качество реализации идеи и уместность шейдинга.</p>
      
      <h3 style="margin:16px 0 8px 0; font-size:1.1rem; color:var(--text); font-weight:700; letter-spacing:-0.2px;">Айдентика / Стилистика (1-10)</h3>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">Оценивается уникальность и узнаваемость стиля.</p>
      
      <h3 style="margin:16px 0 8px 0; font-size:1.1rem; color:var(--text); font-weight:700; letter-spacing:-0.2px;">Общее впечатление / Вайб (множитель 1-10)</h3>
      <p style="line-height:1.7; color:var(--muted); margin:0 0 12px 0;">Субъективный множитель общего впечатления от скина.</p>
      
      <p style="margin-top:20px;padding:12px;background:rgba(138,43,226,0.12);border-radius:8px;border-left:3px solid var(--accent); line-height:1.7; color:var(--muted);"><strong>Итоговая формула:</strong><br>Балл = (Лайн + Палитра + Реализация + Стилистика) × 1.4 × Множитель_вайба<br><strong>Максимум: 90 баллов</strong></p>
    </div>
  </div>

  <script src="https://unpkg.com/skinview3d/bundles/skinview3d.bundle.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
      authDomain: "skinsrzt.firebaseapp.com",
      projectId: "skinsrzt",
      storageBucket: "skinsrzt.appspot.com",
      messagingSenderId: "1084042281569",
      appId: "1:1084042281569:web:25872944cf7dac7fd66020"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const ADMIN_EMAIL = "nmprokhorov@gmail.com";
    
    const adminWrap = document.getElementById('adminWrap');
    const skinName = document.getElementById('skinName');
    const skinAuthor = document.getElementById('skinAuthor');
    const fileInput = document.getElementById('fileInput');
    const addBtn = document.getElementById('addBtn');
    const adminMsg = document.getElementById('adminMsg');
    const gallery = document.getElementById('gallery');
    const sortSelect = document.getElementById('sortSelect');
    const signBtn = document.getElementById('signBtn');
    const infoBtn = document.getElementById('infoBtn');
    const infoModal = document.getElementById('infoModal');
    const closeModal = document.getElementById('closeModal');

    let currentUser = null;
    let skins = {};
    let scores = {};

    // Модальное окно
    infoBtn.addEventListener('click', () => { infoModal.style.display = 'flex'; });
    closeModal.addEventListener('click', () => { infoModal.style.display = 'none'; });
    infoModal.addEventListener('click', (e) => { if (e.target === infoModal) infoModal.style.display = 'none'; });

    // Авторизация
    const provider = new GoogleAuthProvider();
    signBtn.addEventListener('click', async () => {
      if (!currentUser) {
        try { await signInWithPopup(auth, provider); } 
        catch(e){ alert('Ошибка входа: ' + e.message); }
      } else {
        await signOut(auth);
      }
    });

    onAuthStateChanged(auth, user => {
      currentUser = user;
      signBtn.textContent = user ? 'Выйти (' + (user.email || user.displayName || '') + ')' : 'Войти';
      adminWrap.classList.toggle('hidden', !(user && user.email === ADMIN_EMAIL));
    });

    // Добавление скина (админ)
    addBtn.addEventListener('click', async () => {
      adminMsg.textContent = '';
      if (!currentUser || currentUser.email !== ADMIN_EMAIL) { 
        adminMsg.textContent = 'Требуется вход админа'; 
        return; 
      }
      
      const name = (skinName.value || '').trim();
      const author = (skinAuthor.value || '').trim();
      const file = fileInput.files[0];
      
      if (!name) { adminMsg.textContent = 'Введите название скина'; return; }
      if (!author) { adminMsg.textContent = 'Введите автора'; return; }
      if (!file) { adminMsg.textContent = 'Выберите файл'; return; }
      
      adminMsg.textContent = 'Загрузка...';
      
      const reader = new FileReader();
      reader.onload = async (ev) => {
        try {
          const dataUrl = ev.target.result;
          await addDoc(collection(db, 'skins'), {
            name: name,
            author: author,
            skinData: dataUrl,
            createdAt: serverTimestamp()
          });
          adminMsg.textContent = 'Добавлено успешно';
          adminMsg.style.color = '#4ade80';
          skinName.value = '';
          skinAuthor.value = '';
          fileInput.value = '';
          setTimeout(() => { adminMsg.textContent = ''; adminMsg.style.color = ''; }, 2000);
        } catch(e) {
          console.error(e);
          adminMsg.textContent = 'Ошибка: ' + (e.message || e);
          adminMsg.style.color = '#f87171';
        }
      };
      reader.readAsDataURL(file);
    });

    // Загрузка скинов
    const skinsQ = query(collection(db, 'skins'), orderBy('createdAt', 'desc'));
    onSnapshot(skinsQ, snap => {
      snap.docChanges().forEach(ch => {
        const id = ch.doc.id;
        if (ch.type === 'removed') {
          delete skins[id];
        } else {
          skins[id] = { id, ...ch.doc.data() };
        }
      });
      renderGallery();
    });

    // Загрузка оценок
    const scoresQ = query(collection(db, 'skin_scores'), orderBy('createdAt', 'asc'));
    onSnapshot(scoresQ, snap => {
      snap.docChanges().forEach(ch => {
        const data = ch.doc.data();
        const skinId = data.skinId;
        
        if (ch.type === 'removed') {
          if (scores[skinId]) {
            scores[skinId] = scores[skinId].filter(s => s.id !== ch.doc.id);
            if (scores[skinId].length === 0) delete scores[skinId];
          }
        } else {
          if (!scores[skinId]) scores[skinId] = [];
          const existingIndex = scores[skinId].findIndex(s => s.id === ch.doc.id);
          if (existingIndex >= 0) {
            scores[skinId][existingIndex] = { id: ch.doc.id, ...data };
          } else {
            scores[skinId].push({ id: ch.doc.id, ...data });
          }
        }
      });
      renderGallery();
    });

    sortSelect.addEventListener('change', renderGallery);

    function renderGallery() {
      const arr = Object.values(skins).map(skin => {
        const skinScores = scores[skin.id] || [];
        const count = skinScores.length;
        const sum = skinScores.reduce((a, b) => a + (b.total || 0), 0);
        const avg = count ? Math.ceil(sum / count) : 0;
        return { ...skin, scoreCount: count, avgScore: avg };
      });

      if (!arr.length) {
        gallery.innerHTML = '<div class="empty-msg">Пока нет скинов. Будьте первым!</div>';
        return;
      }

      const sortBy = sortSelect.value;
      if (sortBy === 'rating') {
        arr.sort((a, b) => b.avgScore - a.avgScore);
      } else {
        arr.sort((a, b) => {
          const timeA = a.createdAt?.seconds || 0;
          const timeB = b.createdAt?.seconds || 0;
          return timeB - timeA;
        });
      }

      gallery.innerHTML = '';
      
      arr.forEach(skin => {
        const card = document.createElement('div');
        card.className = 'skin-card';
        
        const dateStr = skin.createdAt ? new Date(skin.createdAt.seconds * 1000).toLocaleDateString('ru-RU') : '';
        
        card.innerHTML = `
          <div class="skin-preview" id="preview_${skin.id}">
            <div class="loading-spinner"></div>
          </div>
          <div class="skin-info">
            <div class="skin-name">${escapeHtml(skin.name || 'Без названия')}</div>
            <div class="skin-author">Автор: ${escapeHtml(skin.author || '—')}</div>
            <div class="skin-stats">
              <span>Оценок: ${skin.scoreCount}</span>
              ${dateStr ? `<span>${dateStr}</span>` : ''}
            </div>
            <div class="skin-score">Балл: ${skin.avgScore} / 90</div>
          </div>
        `;
        
        card.addEventListener('click', () => location.href = `skin-view.html?id=${skin.id}`);
        gallery.appendChild(card);
        
        // Генерируем 3D превью
        if (skin.skinData) {
          setTimeout(() => init3DPreview(`preview_${skin.id}`, skin.skinData), 50);
        }
      });
    }

    const previewCache = new Map();
    async function init3DPreview(containerId, skinDataUrl) {
      const container = document.getElementById(containerId);
      if (!container || !skinDataUrl) return;
      
      if (previewCache.has(skinDataUrl)) {
        const img = document.createElement('img');
        img.src = previewCache.get(skinDataUrl);
        container.innerHTML = '';
        container.appendChild(img);
        return;
      }
      
      try {
        const img = document.createElement('img');
        img.src = skinDataUrl;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        container.innerHTML = '';
        container.appendChild(img);
        
        const off = document.createElement('canvas');
        const targetWidth = 320;
        const targetHeight = Math.round(targetWidth * 1.35);
        off.width = targetWidth;
        off.height = targetHeight;
        
        const viewer = new skinview3d.SkinViewer({
          canvas: off,
          width: targetWidth,
          height: targetHeight,
          preserveDrawingBuffer: true
        });
        
        try { viewer.renderer.setClearColor(0x15151c, 1); } catch(_) {}
        await viewer.loadSkin(skinDataUrl);
        viewer.zoom = 0.95;
        viewer.autoRotate = false;
        
        try {
          const walk = new skinview3d.WalkingAnimation(viewer);
          walk.speed = 1.0;
          walk.paused = true;
          walk.progress = 0.30;
          viewer.playerObject.rotation.y = -0.4;
          viewer.camera.position.set(0, 24, 46);
          viewer.camera.lookAt(0, 18, 0);
        } catch(e) {
          try { viewer.playerObject.rotation.y = -0.4; } catch(_) {}
        }
        
        await new Promise(res => requestAnimationFrame(() => requestAnimationFrame(res)));
        
        const renderedDataUrl = off.toDataURL('image/png', 0.8);
        previewCache.set(skinDataUrl, renderedDataUrl);
        img.src = renderedDataUrl;
        
        try { viewer.dispose(); } catch(e) {}
      } catch(e) {
        console.error('3D preview error:', e);
      }
    }

    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
  </script>
</body>
</html>
