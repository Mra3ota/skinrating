<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Ü–µ–Ω–∫–∞ —Å–∫–∏–Ω–∞</title>
  <script src="https://unpkg.com/skinview3d/bundles/skinview3d.bundle.js"></script>
  <style>
    :root {
      --bg: #0e0e12;
      --surface: #11131a;
      --surface-2: #15151c;
      --text: #eaeaf2;
      --text-2: #a9a9b8;
      --text-3: #7b7b8f;
      --line: #2a2d3a;
      --accent: #8a2be2;
      --accent-hover: #9b4dff;
      --grad: linear-gradient(135deg, #6B5BFF 0%, #9049FF 35%, #C24BFF 68%, #FF49C6 100%);
      --ring-shadow: 0 0 80px rgba(144,73,255,.25);
      --radius: 16px;
    }
    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      background: var(--surface-2);
      border-radius: var(--radius);
      padding: 20px;
      max-width: 980px;
      width: 100%;
      box-shadow: 0 0 30px rgba(0,0,0,0.4);
    }
    header { text-align:center; margin-bottom:20px; }
    header img { 
      height:70px; 
      width:auto; 
      display:block; 
      margin:0 auto 8px; 
    }
    header h1 { font-size:1.7em; margin:0; }
    .upload-section { text-align:center; margin-bottom:20px; }
    input[type=file] {
      background:#1e1e27; border-radius:8px; padding:10px; border:1px solid #2f2f3b; color:#fff;
      cursor:pointer; font-size:0.9em; max-width:100%;
    }
    .skin-preview { width:100%; max-width:300px; height:400px; margin:15px auto; display:block;
      border:2px solid #2f2f3b; border-radius:8px; background: repeating-conic-gradient(#2a2a35 0% 25%, #1e1e27 0% 50%) 50% / 20px 20px;
    }
    .criterion { margin-bottom:15px; }
    .criterion label { display:flex; justify-content:space-between; margin-bottom:5px; font-weight:600; }
    input[type=range] { width:100%; -webkit-appearance:none; background:linear-gradient(90deg,#007bff,#8a2be2); height:6px; border-radius:6px; outline:none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; border:2px solid #8a2be2; }
    input[type=range]::-moz-range-thumb { width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; border:2px solid #8a2be2; }
    .score-display { background:#1e1e27; border-radius:10px; padding:12px; text-align:center; font-size:1.1em; font-weight:bold; margin-top:20px;}
    textarea { width:100%; min-height:80px; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:10px; resize:vertical; margin-bottom:12px; font-family:inherit; box-sizing:border-box; }
    .reset-button, .submit-button { background:var(--accent); color:#fff; border:none; padding:10px 20px; border-radius:8px; font-size:1em; cursor:pointer; margin-right:8px; transition:all .15s; }
    .reset-button:hover, .submit-button:hover { background:var(--accent-hover); transform:translateY(-1px); }
    .reset-button:disabled, .submit-button:disabled { background:#555; cursor:not-allowed; }
    .reset-button:focus-visible, .submit-button:focus-visible, input:focus-visible, textarea:focus-visible {
      outline: 2px solid #8a2be2;
      outline-offset: 2px;
    }
    .reviews { margin-top:30px; }
    .review-item { background:#1b1b23; border-radius:8px; padding:12px; margin-bottom:12px; border-left:3px solid var(--accent); }
    .review-item h3 { margin-top:0; color:#8a2be2; }
    .review-item { display:flex; gap:16px; align-items:flex-start; }
    .review-body { flex: 1 1 60%; }
    .review-preview { flex: 1 1 40%; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
    /* –ü—Ä–µ–≤—å—é —Å–∫–∏–Ω–∞ –≤ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–µ: –Ω–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ (—É–º–µ–Ω—å—à–µ–Ω–æ ~–≤ 1.5 —Ä–∞–∑–∞) */
    .review-preview .skin-thumb { display:block; width: clamp(220px, 35vw, 256px); height: auto; max-height: 360px; object-fit: contain; margin: 0 auto; border:1px solid transparent; border-radius:12px; background:
      linear-gradient(#1b1b23,#1b1b23) padding-box,
      var(--grad) border-box; }
    .review-hint { color:#888; font-size:0.8em; margin-top:6px; }
    @media (max-width: 720px) {
      .review-item { flex-direction:column; }
      .review-preview { order: -1; }
      .review-preview .skin-thumb { width: clamp(200px, 85vw, 320px); max-height: 300px; }
    }
    .criteria { background:#1e1e27; border-radius:8px; padding:8px 10px; margin:10px 0; font-size:0.9em; line-height:1.6; }
    .criteria small { display:block; color:#ccc; }
    /* –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–∂–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π —Å—Ç–∏–ª—å –≤—ã—à–µ */
    .review-item .skin-thumb { margin-top:10px; border-radius:8px; border:1px solid #2f2f3b; cursor:pointer; display:block; }
    .review-item .skin-thumb:hover { border-color:#8a2be2; }
    .info-text { text-align:center; color:#888; font-size:0.85em; margin-top:8px; }
    .loading { text-align:center; color:#8a2be2; padding:20px; }
    .error { color:#f88; padding:10px; border-radius:6px; background:#2a1a2a; text-align:center; }
    /* –ê–≤—Ç–æ—Ä-–±–µ–π–¥–∂ –Ω–∞–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º —Ä–µ—Ü–µ–Ω–∑–∏–∏ */
    .author-badge {
      display: inline-block;
      background: #1e1e27;
      color: #fff;
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 6px 10px;
      font-weight: 700;
      margin-bottom: 8px;
      box-shadow: 0 0 10px rgba(138,43,226,0.15);
    }

    /* Preview border gradient */
    .review-preview .skin-thumb { border:1px solid transparent; border-radius:10px; background:
      linear-gradient(#1b1b23,#1b1b23) padding-box,
      var(--grad) border-box; }
    /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–ø—Ä–∞–≤–∞ */
    @media (min-width: 1100px) {
      body.with-auth-sidebar { padding-right: 340px; }
    }
    @media (max-width: 1099px) {
      #auth-section { position: static !important; width: auto !important; margin:10px 0 16px 0 !important; }
    }
#contest {
  margin: 20px auto 30px auto;
  padding: 15px 20px;
  max-width: 600px;
  text-align: center;
  background-color: #111;
  border-radius: 14px;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
}

#contest h3 {
  color: #fff;
  margin-bottom: 8px;
  font-size: 1.2em;
}

#contest p {
  color: #ccc;
  margin-bottom: 12px;
  font-size: 0.95em;
}

.contest-btn {
  display: inline-block;
  padding: 8px 18px;
  background-color: #ff0066;
  color: #fff;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 600;
  transition: 0.2s;
}

.contest-btn:hover {
  background-color: #ff3388;
  transform: scale(1.05);
}
    .disclaimer {
  margin: 10px 0 16px 0;
  background: #1e1e27;
  border: 1px solid #2f2f3b;
  border-radius: 10px;
  padding: 10px 14px;
  color: #bbb;
  font-size: 0.85em;
  line-height: 1.5;
  text-align: center;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}
.disclaimer b {
  color: #ff4d4d;
}
/* –ú–æ–¥–∞–ª–∫–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º —Å–∫–∏–Ω–∞ */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index: 2000; }
.modal { background:#15151c; border:1px solid #2f2f3b; border-radius:12px; padding:14px; box-shadow:0 0 30px rgba(0,0,0,0.5); max-width: 90vw; }
.modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.modal-close { background:#8a2be2; border:none; color:#fff; padding:6px 12px; border-radius:8px; cursor:pointer; }
  </style>

  <!-- ==================== –í–°–¢–ê–í–õ–ï–ù–û: –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫, –∏—Ç–æ–≥–æ–≤ –∫–æ–Ω–∫—É—Ä—Å–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–Ω–æ–≤ ==================== -->
  <style>
    .tab-navigation { display:flex; gap:10px; justify-content:center; margin:20px 0; flex-wrap:wrap; }
    .tab-btn { background: var(--surface-2); color: var(--text); border: 2px solid var(--line); padding: 10px 20px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.2s; font-weight: 600; }
    .tab-btn:hover { border-color: var(--accent); transform: translateY(-2px); }
    .tab-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
    .page-section { display: none; }
    .page-section.active { display: block; }
    .results-container { max-width: 1200px; margin: 0 auto; }
    .winners-section { margin-bottom: 40px; }
    .winners-title { text-align: center; font-size: 2em; margin-bottom: 20px; background: var(--grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .winners-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .skin-card { background: var(--surface-2); border-radius: var(--radius); padding: 20px; border: 2px solid var(--line); transition: all 0.3s; position: relative; }
    .skin-card:hover { border-color: var(--accent); box-shadow: var(--ring-shadow); transform: translateY(-4px); }
    .skin-card.winner { border: 2px solid transparent; background: linear-gradient(var(--surface-2), var(--surface-2)) padding-box, var(--grad) border-box; }
    .place-badge { position: absolute; top: 10px; right: 10px; background: var(--accent); color: #fff; padding: 6px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9em; }
    .winner .place-badge { background: var(--grad); font-size: 1.1em; padding: 8px 16px; }
    .skin-thumbnail { width: 100%; max-width: 200px; height: auto; margin: 10px auto; display: block; border-radius: 8px; border: 1px solid var(--line); image-rendering: pixelated; cursor: pointer; }
    .skin-thumbnail:hover { border-color: var(--accent); }
    .skin-title { text-align: center; font-size: 1.4em; font-weight: 700; margin: 10px 0; color: var(--text); }
    .average-score { text-align: center; font-size: 1.8em; font-weight: 700; margin: 15px 0; background: var(--grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .judges-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 20px 0; }
    .judge-card { background: var(--surface); padding: 10px; border-radius: 8px; border: 1px solid var(--line); text-align: center; }
    .judge-name { font-weight: 700; color: var(--accent); margin-bottom: 5px; font-size: 0.9em; }
    .judge-score { font-size: 1.4em; font-weight: 700; color: var(--text); }
    .judge-pending { color: var(--text-3); font-style: italic; }
    .reviews-details { margin-top: 20px; }
    .reviews-details summary { cursor: pointer; font-weight: 600; padding: 10px; background: var(--surface); border-radius: 8px; list-style: none; user-select: none; }
    .reviews-details summary:hover { background: var(--line); }
    .reviews-details summary::before { content: '‚ñ∂ '; display: inline-block; transition: transform 0.2s; }
    .reviews-details[open] summary::before { transform: rotate(90deg); }
    .review-full { background: var(--surface); padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 3px solid var(--accent); }
    .review-full h4 { margin: 0 0 10px 0; color: var(--accent); }
    .review-criteria { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin: 10px 0; font-size: 0.85em; }
    .review-criteria span { background: var(--surface-2); padding: 4px 8px; border-radius: 4px; }
    .upload-skin-form { max-width: 600px; margin: 20px auto; background: var(--surface-2); padding: 20px; border-radius: var(--radius); }
    .upload-skin-form input[type="text"], .upload-skin-form input[type="file"] { width: 100%; margin: 10px 0; padding: 10px; background: var(--surface); border: 1px solid var(--line); border-radius: 8px; color: var(--text); box-sizing: border-box; }
    .skin-preview-upload { width: 100%; max-width: 200px; margin: 15px auto; display: block; border-radius: 8px; border: 2px solid var(--line); image-rendering: pixelated; }
    @media (max-width: 640px) { .winners-grid { grid-template-columns: 1fr; } .judges-grid { grid-template-columns: repeat(2, 1fr); } }
  </style>

</head>
<body>
  <div class="container">
    <header>
  <a href="https://t.me/MeatMakers" target="_blank">
    <img src="assets/–ú–ú–ú_–õ–û–ì–û_–û–†–ò–ì–ò–ù–ê–õ.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onerror="this.style.display='none'">
  </a>
  <h1>–û—Ü–µ–Ω–∫–∞ —Å–∫–∏–Ω–∞</h1>
</header>
    <nav class="tab-navigation" id="main-tabs">
      <button class="tab-btn active" data-tab="results">–ò—Ç–æ–≥–∏ –∫–æ–Ω–∫—É—Ä—Å–∞</button>
      <button class="tab-btn" data-tab="upload" style="display:none;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–∏–Ω–æ–≤</button>
    </nav>

    <div class="page-section active" id="results-section">
      <div class="results-container">
        <h2 style="text-align:center; font-size:2.2em; margin:20px 0;">üèÜ –ò—Ç–æ–≥–∏ –∫–æ–Ω–∫—É—Ä—Å–∞</h2>
        <div class="winners-section">
          <div class="winners-title">–ü—Ä–∏–∑–æ–≤—ã–µ –º–µ—Å—Ç–∞</div>
          <div class="winners-grid" id="winners-container"></div>
        </div>
        <div class="others-section">
          <h3 style="text-align:center; font-size:1.5em; margin:20px 0;">–û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
          <div id="others-container"></div>
        </div>
        <div class="loading" id="results-loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</div>
      </div>
    </div>

    <div class="page-section" id="upload-skins-section">
      <div class="upload-skin-form">
        <h2 style="text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–∏–Ω–æ–≤ –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞</h2>
        <input type="text" id="skin-title-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∏–Ω–∞" maxlength="100" />
        <input type="file" id="skin-file-input" accept="image/png" />
        <img id="skin-preview-img" class="skin-preview-upload" style="display:none;" />
        <button class="submit-button" id="upload-skin-btn" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–∏–Ω</button>
        <div id="upload-error" class="error" style="display:none; margin-top:10px;"></div>
        <div id="upload-success" class="info-text" style="display:none; margin-top:10px; color:#0f0;">–°–∫–∏–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!</div>
      </div>
      <div style="max-width:800px; margin:20px auto;">
        <h3 style="text-align:center;">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–∫–∏–Ω—ã</h3>
        <div id="uploaded-skins-list"></div>
      </div>
    </div>

    <section class="auth" id="auth-section" style="margin:10px 0 16px 0; background:#1e1e27; border:1px solid #2f2f3b; border-radius:10px; padding:10px 14px; position:fixed; right:20px; top:20px; width:300px; z-index:1000;">
      <div id="auth-status" class="info-text" style="margin-bottom:8px;">–í—ã –Ω–µ –≤–æ—à–ª–∏. –í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏–∏.</div>
      <div id="auth-controls" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <input id="auth-email" type="email" placeholder="Email" style="flex:1; min-width:180px; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:8px;" />
        <input id="auth-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="flex:1; min-width:140px; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:8px;" />
        <!-- –†–æ–ª—å –Ω–∞–∑–Ω–∞—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω; —Å–µ–ª–µ–∫—Ç–æ—Ä —Å–∫—Ä—ã—Ç -->
        <button id="auth-login" class="submit-button" style="margin-right:0;">–í–æ–π—Ç–∏</button>
        <button id="auth-register" class="reset-button" style="margin-right:0;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button id="auth-google" class="submit-button" style="background:#4285F4; margin-right:0;">Google</button>
      </div>
      <div id="nick-row" style="display:none; margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span id="nick-display" style="font-weight:700; color:#fff; background:#1e1e27; border:1px solid #8a2be2; border-radius:10px; padding:6px 10px;">‚Äî</span>
        <button id="nick-edit" class="reset-button" style="margin-right:0;">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        <div id="nick-edit-box" style="display:none; width:100%; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input id="nick-input" type="text" placeholder="–í–∞—à –Ω–∏–∫" maxlength="40" style="flex:1 1 100%; min-width:0; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:8px;" />
          <button id="nick-save" class="submit-button" style="margin-right:0; flex:1 1 0;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="nick-cancel" class="reset-button" style="margin-right:0; flex:1 1 0;">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
      <div style="margin-top:8px;">
        <button id="auth-logout" class="reset-button" style="display:none; margin-right:0;">–í—ã–π—Ç–∏</button>
      </div>
      <!-- –ú–∏–Ω–∏‚Äë–ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ–ª–µ–π -->
      <div id="admin-roles" style="display:none; margin-top:10px; padding-top:8px; border-top:1px dashed #2f2f3b;">
        <div style="font-weight:700; margin-bottom:6px;">–ê–¥–º–∏–Ω: –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π</div>
        <input id="role-user-uid" type="text" placeholder="UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="width:100%; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:8px; margin-bottom:6px;" />
        <select id="role-new-role" style="width:100%; background:#1b1b23; color:#fff; border:1px solid #2f2f3b; border-radius:8px; padding:8px; margin-bottom:6px;">
          <option value="reviewer">–†–µ—Ü–µ–Ω–∑–µ–Ω—Ç</option>
          <option value="creator">–°–æ–∑–¥–∞—Ç–µ–ª—å</option>
        </select>
        <button id="role-apply" class="submit-button" style="margin-right:0; width:100%;">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å</button>
        <div id="role-admin-error" class="error" style="display:none; margin-top:8px;"></div>
      </div>
      <div id="auth-error" class="error" style="display:none; margin-top:8px;"></div>
    </section>
    <div class="upload-section" id="upload">
      <input type="file" id="skin-upload" accept="image/png" />
      <div class="info-text">–ó–∞–≥—Ä—É–∑–∏—Ç–µ PNG —Ñ–∞–π–ª —Å–∫–∏–Ω–∞ (64x64 –∏–ª–∏ 64x32)</div>
      <canvas id="skin-viewer" class="skin-preview"></canvas>
    </div>

    <div class="criterion">
      <label for="line">–õ–∞–π–Ω / –û–±—Ä–∞–∑ <span id="line-value">5</span></label>
      <input type="range" id="line" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="palette">–ü–∞–ª–∏—Ç—Ä–∞ <span id="palette-value">5</span></label>
      <input type="range" id="palette" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="shade">–†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –®–µ–π–¥ <span id="shade-value">5</span></label>
      <input type="range" id="shade" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="style">–ê–π–¥–µ–Ω—Ç–∏–∫–∞ / –°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞ <span id="style-value">5</span></label>
      <input type="range" id="style" min="1" max="10" value="5">
    </div>
    <div class="criterion">
      <label for="vibe">–û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ / –í–∞–π–± <span id="vibe-value">5</span></label>
      <input type="range" id="vibe" min="1" max="10" value="5">
    </div>

    <div class="score-display" id="total">–ò—Ç–æ–≥: 25 / 90</div>

    <textarea id="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ—Ü–µ–Ω–∑–∏–∏" maxlength="200"></textarea>
    <textarea id="text" placeholder="–¢–µ–∫—Å—Ç —Ä–µ—Ü–µ–Ω–∑–∏–∏ (–¥–æ 8500 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="8500"></textarea>
    <div id="text-warning" class="info-text" style="display:none; text-align:left; margin-top:-6px;">
      –ú–∏–Ω–∏–º—É–º 30 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ —Ä–µ—Ü–µ–Ω–∑–∏–∏.
    </div>
  <p class="disclaimer">
   <b>–î–ò–°–ö–õ–ï–ô–ú–ï–†!</b><br>
  –í—Å–µ —Ä–µ—Ü–µ–Ω–∑–∏–∏ –±–µ–∑ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏ –æ—Ü–µ–Ω–∫–∏ ‚Äî –∞ —Ç–∞–∫–∂–µ —Å–æ—Å—Ç–æ—è—â–∏–µ –∏–∑ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –±—É–∫–≤,
  –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–π, —à—É—Ç–æ–∫ –∏ —Ç.–¥. ‚Äî –±—É–¥—É—Ç <b>—É–¥–∞–ª–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</b>.
</p>

    <button class="reset-button" id="reset">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <button class="submit-button" id="submit" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

     <section id="contest" class="centered-block">
  <div class="contest-content">
    <h2>–•—ç–ª–ª–æ—É–∏–Ω—Å–∫–∏–π –ö–æ–Ω–∫—É—Ä—Å –æ—Ç MMM</h2>
    <p>–û—Ç–ø—Ä–∞–≤—å —Å–≤–æ–π —Å–∫–∏–Ω –∏ –∑–∞—Ä–∞–±–æ—Ç–∞–π –¥–æ 2000 –†–£–ë–õ–ï–ô</p>
    <a href="https://t.me/MeatMakers/17" target="_blank" class="contest-btn">–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å</a>
  </div>
</section>
    <div class="reviews" id="reviews">
      <div class="loading" role="status" aria-live="polite">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ü–µ–Ω–∑–∏–π...</div>
    </div>
  <!-- –ú–æ–¥–∞–ª–∫–∞ SkinViewer -->
  <div id="skin-modal-overlay" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div style="font-weight:700;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–∫–∏–Ω–∞</div>
        <button id="skin-modal-close" class="modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <canvas id="skin-modal-canvas" width="320" height="420" class="skin-preview" style="max-width:320px; height:420px;"></canvas>
    </div>
  </div>
  </div>

<script>
// –û—Å–Ω–æ–≤–Ω–æ–π UI-—Å–∫—Ä–∏–ø—Ç
document.addEventListener('DOMContentLoaded', () => {
  const ranges = ['line', 'palette', 'shade', 'style', 'vibe'];
  const values = {line: 5, palette: 5, shade: 5, style: 5, vibe: 5};
  const vibeMultiplier = {
    1: 1, 2: 1.0675, 3: 1.1349, 4: 1.2024, 5: 1.2699,
    6: 1.3373, 7: 1.4048, 8: 1.4723, 9: 1.5397, 10: 1.6072
  };
  let viewer = null;
  let uploadedSkin = null;
  
  // –î–µ–ª–∞–µ–º uploadedSkin –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è Firebase
  window.uploadedSkin = null;

    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
    const submitBtn = document.getElementById('submit');
    const titleEl = document.getElementById('title');
    const textEl = document.getElementById('text');
    const textWarning = document.getElementById('text-warning');
    const MIN_TEXT_LEN = 30;

    function isNonEmpty(str) {
      return !!(str && String(str).trim().length > 0);
    }

    function updateSubmitState() {
      const hasSkin = !!window.uploadedSkin;
      const hasTitle = isNonEmpty(titleEl?.value);
      const textVal = textEl?.value || '';
      const hasText = isNonEmpty(textVal);
      const textLongEnough = textVal.trim().length >= MIN_TEXT_LEN;
      const isAuthed = !!window.currentUserUid;

      if (textWarning) {
        textWarning.style.display = (!textLongEnough ? 'block' : 'none');
      }

      if (submitBtn) submitBtn.disabled = !(hasSkin && hasTitle && hasText && textLongEnough && isAuthed);
    }

    // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –º–æ–¥—É–ª—è (Auth) –≤—ã–∑—ã–≤–∞—Ç—å –ø–µ—Ä–µ—Å—á—ë—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
    window.updateSubmitState = updateSubmitState;

  function calculateTotal() {
    const baseSum = Number(values.line) + Number(values.palette) + Number(values.shade) + Number(values.style);
    const scaled = baseSum * 1.4;
    const multiplier = vibeMultiplier[Number(values.vibe)] || 1;
    const total = Math.round(scaled * multiplier);
    document.getElementById('total').textContent = `–ò—Ç–æ–≥: ${total} / 90`;
    return total;
  }

  // –î–µ–±–∞—É–Ω—Å-—Ö–µ–ª–ø–µ—Ä
  function debounce(fn, ms) {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ —Å –¥–µ–±–∞—É–Ω—Å–æ–º
  ranges.forEach(id => {
    const input = document.getElementById(id);
    const label = document.getElementById(`${id}-value`);
    if (input && label) {
      input.addEventListener('input', debounce(() => {
        values[id] = parseInt(input.value, 10);
        label.textContent = input.value;
        calculateTotal();
      }, 120));
    }
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ + –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
  document.getElementById('skin-upload').addEventListener('change', async e => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    if (!file.type.includes('png')) {
      alert('–¢–æ–ª—å–∫–æ PNG —Ñ–∞–π–ª—ã –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Å–∫–∏–Ω–æ–≤.');
      return;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º data URL —Å–∫–∏–Ω–∞ –≤ window.uploadedSkin (base64) —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–∑–º–µ—Ä–∞
    const reader = new FileReader();
    reader.onload = async evt => {
      const dataUrl = evt.target.result;
      // –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
      try {
        const img = new Image();
        await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = dataUrl; });
        const valid = (img.width === 64 && img.height === 64) || (img.width === 64 && img.height === 32);
        if (!valid) {
          alert('–†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 64√ó64 –∏–ª–∏ 64√ó32.');
          return;
        }
      } catch(e) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.'); return; }

      uploadedSkin = dataUrl;
      window.uploadedSkin = uploadedSkin;
      
      try {
        if (!viewer) {
          viewer = new skinview3d.SkinViewer({
            canvas: document.getElementById('skin-viewer'),
            width: 300,
            height: 400,
            skin: uploadedSkin
          });
          viewer.zoom = 0.9;
          viewer.autoRotate = false;
        } else {
          viewer.loadSkin(uploadedSkin);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫–∏–Ω–∞:', err);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–Ω–∞
      updateSubmitState();
    };
    
    reader.onerror = () => {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞.');
    };
    
    reader.readAsDataURL(file);
  });

  // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
  document.getElementById('reset').addEventListener('click', () => {
    ranges.forEach(id => {
      values[id] = 5;
      const el = document.getElementById(id);
      if (el) el.value = 5;
      const label = document.getElementById(`${id}-value`);
      if (label) label.textContent = '5';
    });
    
    document.getElementById('title').value = '';
    document.getElementById('text').value = '';
    document.getElementById('skin-upload').value = '';
    
    uploadedSkin = null;
    window.uploadedSkin = null;

    if (viewer) {
      try {
        viewer.dispose();
        viewer = null;
      } catch(e) {}
    }
    
    const canvas = document.getElementById('skin-viewer');
    const ctx = canvas.getContext('2d');
    if (ctx) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    calculateTotal();

    // –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —Å–Ω–æ–≤–∞ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    updateSubmitState();
  });

  calculateTotal();
  
  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏
  if (titleEl) titleEl.addEventListener('input', updateSubmitState);
  if (textEl) textEl.addEventListener('input', updateSubmitState);
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
  updateSubmitState();
  // –î–µ–ª–∞–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –º–æ–¥—É–ª—è
  window.calculateTotalForSubmit = calculateTotal;
});
</script>


<!-- Firebase Module -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    getDoc,
    updateDoc,
    runTransaction,
    query,
    orderBy,
    serverTimestamp,
    limit,
    startAfter
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut,
    GoogleAuthProvider,
    signInWithPopup,
    signInWithRedirect,
    getRedirectResult
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
    authDomain: "skinsrzt.firebaseapp.com",
    projectId: "skinsrzt",
    storageBucket: "skinsrzt.appspot.com",
    messagingSenderId: "1084042281569",
    appId: "1:1084042281569:web:25872944cf7dac7fd66020"
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (—Ç–æ–ª—å–∫–æ Firestore)
  let app, db, auth;
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", err);
    document.getElementById('reviews').innerHTML = '<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.</div>';
  }

  // –≠–ª–µ–º–µ–Ω—Ç—ã Auth UI
  const authStatus = document.getElementById('auth-status');
  const authError = document.getElementById('auth-error');
  const authEmail = document.getElementById('auth-email');
  const authPassword = document.getElementById('auth-password');
  const authLoginBtn = document.getElementById('auth-login');
  const authRegisterBtn = document.getElementById('auth-register');
  const authGoogleBtn = document.getElementById('auth-google');
  const authLogoutBtn = document.getElementById('auth-logout');
  const authControls = document.getElementById('auth-controls');
  const googleProvider = auth ? new GoogleAuthProvider() : null;
  const nickRow = document.getElementById('nick-row');
  const nickInput = document.getElementById('nick-input');
  const nickSaveBtn = document.getElementById('nick-save');
  const nickCancelBtn = document.getElementById('nick-cancel');
  const nickEditBtn = document.getElementById('nick-edit');
  const nickEditBox = document.getElementById('nick-edit-box');
  const nickDisplay = document.getElementById('nick-display');

  async function loadNickname(uid) {
    try {
      if (!uid) return null;
      const userDocRef = doc(db, 'users', uid);
      const snap = await getDoc(userDocRef);
      if (snap.exists()) {
        const data = snap.data();
        return data?.displayName || null;
      }
      return null;
    } catch (e) {
      console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–∏–∫:', e);
      return null;
    }
  }

  async function saveNickname(uid, name) {
    if (!uid) throw new Error('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    const safe = String(name || '').trim().slice(0, 40);
    const userDocRef = doc(db, 'users', uid);
    await setDoc(userDocRef, { displayName: safe, updatedAt: Date.now() }, { merge: true });
    return safe;
  }

  function setAuthError(message) {
    if (!authError) return;
    if (message) {
      authError.textContent = message;
      authError.style.display = 'block';
    } else {
      authError.textContent = '';
      authError.style.display = 'none';
    }
  }

  // –°–ª–µ–¥–∏–º –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≤—Ö–æ–¥–∞
  if (auth) {
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ (iOS Safari)
    getRedirectResult(auth).catch(e => {
      if (e && e.code) setAuthError(`Firebase: ${e.code}`);
    });

    onAuthStateChanged(auth, async (user) => {
      window.currentUserUid = user ? user.uid : null;
      if (user) {
        if (authStatus) authStatus.textContent = `–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${user.email || '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}`;
        if (authLogoutBtn) authLogoutBtn.style.display = 'inline-block';
        if (authLoginBtn) authLoginBtn.style.display = 'none';
        if (authRegisterBtn) authRegisterBtn.style.display = 'none';
        if (authGoogleBtn) authGoogleBtn.style.display = 'none';
        if (authEmail) authEmail.style.display = 'none';
        if (authPassword) authPassword.style.display = 'none';
        if (nickRow) nickRow.style.display = 'flex';
        // –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∏–∫–∞ –∏ —Ä–æ–ª–∏
        (async () => {
          const existing = await loadNickname(user.uid);
          const fallback = user.email ? user.email.split('@')[0] : 'user';
          const name = existing || fallback;
          if (nickInput) nickInput.value = name;
          if (nickDisplay) nickDisplay.textContent = name;
          if (nickEditBox) nickEditBox.style.display = 'none';
          window.currentUserDisplayName = name;
        })();

        // –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å —Ä–æ–ª—å—é
        try {
          const userDocRef = doc(db, 'users', user.uid);
          const snap = await getDoc(userDocRef);
          const role = snap.exists() ? (snap.data()?.role || 'reviewer') : 'reviewer';
          window.currentUserRole = role;
        } catch(_) { window.currentUserRole = 'creator'; }

        // –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑—á–∏–∫ —Å–∫–∏–Ω–æ–≤, –µ—Å–ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å
        const upBox = document.getElementById('skin-upload-v2');
        if (upBox) upBox.style.display = (window.currentUserRole === 'creator') ? 'block' : 'none';
        const platformMsg = document.getElementById('platform-msg');
        if (platformMsg) platformMsg.textContent = (window.currentUserRole === 'creator') ? '–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Å–∫–∏–Ω—ã.' : '–í—ã –º–æ–∂–µ—Ç–µ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å —Å–∫–∏–Ω—ã.';

        // –ø–æ–∫–∞–∑–∞—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        try {
          const userDocRef = doc(db, 'users', user.uid);
          const snap = await getDoc(userDocRef);
          const isAdmin = snap.exists() && (snap.data()?.role === 'admin');
          const adminBox = document.getElementById('admin-roles');
          if (adminBox) adminBox.style.display = isAdmin ? 'block' : 'none';
          window.currentUserIsAdmin = isAdmin;
        } catch(_) {}
      } else {
        if (authStatus) authStatus.textContent = '–í—ã –Ω–µ –≤–æ—à–ª–∏. –í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏–∏.';
        if (authLogoutBtn) authLogoutBtn.style.display = 'none';
        if (authLoginBtn) authLoginBtn.style.display = 'inline-block';
        if (authRegisterBtn) authRegisterBtn.style.display = 'inline-block';
        if (authGoogleBtn) authGoogleBtn.style.display = 'inline-block';
        if (authEmail) authEmail.style.display = 'inline-block';
        if (authPassword) authPassword.style.display = 'inline-block';
        if (nickRow) nickRow.style.display = 'none';
        window.currentUserDisplayName = null;
        window.currentUserRole = null;
        const upBox = document.getElementById('skin-upload-v2');
        if (upBox) upBox.style.display = 'none';
        const adminBox = document.getElementById('admin-roles');
        if (adminBox) adminBox.style.display = 'none';
      }
      if (window.updateSubmitState) try { window.updateSubmitState(); } catch(e) {}
      setAuthError('');
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–≤—ã—Ö–æ–¥–∞
  if (authLoginBtn) authLoginBtn.addEventListener('click', async () => {
    setAuthError('');
    try {
      const email = authEmail?.value?.trim();
      const password = authPassword?.value || '';
      if (!email || !password) return setAuthError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å.');
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      setAuthError(e?.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
    }
  });

  if (authRegisterBtn) authRegisterBtn.addEventListener('click', async () => {
    setAuthError('');
    try {
      const email = authEmail?.value?.trim();
      const password = authPassword?.value || '';
      if (!email || !password) return setAuthError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å.');
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      try {
        // —Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞–∑–Ω–∞—á–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞: —Ç–æ–ª—å–∫–æ –†–ï–¶–ï–ù–ó–ï–ù–¢
        const role = 'reviewer';
        await setDoc(doc(db, 'users', cred.user.uid), {
          username: email.split('@')[0],
          role,
          avatarUrl: '',
          avgCreatorRating: 0,
          createdAt: Date.now()
        }, { merge: true });
      } catch(_) {}
    } catch (e) {
      setAuthError(e?.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
    }
  });

  if (authLogoutBtn) authLogoutBtn.addEventListener('click', async () => {
    setAuthError('');
    try {
      await signOut(auth);
    } catch (e) {
      setAuthError(e?.message || '–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞');
    }
  });

  if (authGoogleBtn) authGoogleBtn.addEventListener('click', async () => {
    setAuthError('');
    try {
      await signInWithPopup(auth, googleProvider);
    } catch (e) {
      // –ù–∞ iOS Safari –∏ –≤ —Å–ª—É—á–∞—è—Ö –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç
      const code = e?.code || '';
      const shouldRedirect = code.includes('popup') || code.includes('operation-not-supported');
      if (shouldRedirect) {
        try {
          await signInWithRedirect(auth, googleProvider);
          return;
        } catch (er) {
          setAuthError(er?.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google (redirect)');
        }
      } else {
        setAuthError(e?.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google');
      }
    }
  });

  if (nickEditBtn) nickEditBtn.addEventListener('click', () => {
    if (!window.currentUserUid) return setAuthError('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫.');
    if (nickEditBox) nickEditBox.style.display = 'flex';
  });

  if (nickCancelBtn) nickCancelBtn.addEventListener('click', () => {
    if (nickEditBox) nickEditBox.style.display = 'none';
    if (nickInput && nickDisplay) nickInput.value = nickDisplay.textContent || '';
  });

  if (nickSaveBtn) nickSaveBtn.addEventListener('click', async () => {
    setAuthError('');
    try {
      const uid = window.currentUserUid;
      if (!uid) return setAuthError('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫.');
      const name = nickInput?.value || '';
      const saved = await saveNickname(uid, name);
      window.currentUserDisplayName = saved;
      if (authStatus) authStatus.textContent = `–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${saved}`;
      if (nickDisplay) nickDisplay.textContent = saved;
      if (nickEditBox) nickEditBox.style.display = 'none';
    } catch (e) {
      setAuthError(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫');
    }
  });

  // –£—Ç–∏–ª–∏—Ç–∞: —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –≤—ã–≤–æ–¥–∞
  function escapeHtml(unsafe) {
    if (!unsafe && unsafe !== 0) return '';
    return String(unsafe)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ü–µ–Ω–∑–∏–π (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
  let reviewsLastDoc = null;
  const REVIEWS_PAGE = 20;
  async function loadReviews(reset = false) {
    const container = document.getElementById('reviews');

    try {
      if (reset) {
        container.innerHTML = '<div class="loading" role="status" aria-live="polite">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ü–µ–Ω–∑–∏–π...</div>';
        reviewsLastDoc = null;
      }

      let qRef = query(collection(db, "reviews"), orderBy("createdAt", "desc"), limit(REVIEWS_PAGE));
      if (reviewsLastDoc) {
        qRef = query(collection(db, "reviews"), orderBy("createdAt", "desc"), startAfter(reviewsLastDoc), limit(REVIEWS_PAGE));
      }

      const snapshot = await getDocs(qRef);

      if (snapshot.empty) {
        container.innerHTML = '<div class="info-text">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ü–µ–Ω–∑–∏–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
        const maybeMore = document.getElementById('reviews-more');
        if (maybeMore) maybeMore.style.display = 'none';
        return;
      }

      if (!reviewsLastDoc) {
        if (window.reviewViewers && Array.isArray(window.reviewViewers)) {
          window.reviewViewers.forEach(v => { try { v.dispose(); } catch(e){} });
        }
        window.reviewViewers = [];
        container.innerHTML = '';
      }

      const isMobile = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
      let mobileViewerCount = window.mobileViewerCount || 0;
      const MAX_MOBILE_VIEWERS = 3; // –æ–≥—Ä–∞–Ω–∏—á–∏–º —á–∏—Å–ª–æ WebGL –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö

      snapshot.forEach(doc => {
        const r = doc.data();
        const reviewDiv = document.createElement('div');
        reviewDiv.classList.add('review-item');

        let createdStr = '';
        if (r.createdAt) {
          try {
            const date = r.createdAt.toDate ? r.createdAt.toDate() : new Date(r.createdAt);
            createdStr = date.toLocaleString('ru-RU');
          } catch(e) {
            createdStr = '';
          }
        }

        const authorDisplay = escapeHtml(r.authorName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
        let reviewHTML = `
          <div class="review-body">
            <div class="author-badge">${authorDisplay}</div>
            <h3>${escapeHtml(r.title || '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞')}</h3>
            <p>${escapeHtml(r.text || '')}</p>
            <div class="criteria">
              <small>–õ–∞–π–Ω / –û–±—Ä–∞–∑: ${r.line ?? '-'}</small>
              <small>–ü–∞–ª–∏—Ç—Ä–∞: ${r.palette ?? '-'}</small>
              <small>–†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –®–µ–π–¥: ${r.shade ?? '-'}</small>
              <small>–ê–π–¥–µ–Ω—Ç–∏–∫–∞ / –°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞: ${r.style ?? '-'}</small>
              <small>–û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ / –í–∞–π–±: ${r.vibe ?? '-'}</small>
            </div>
            <small><b>–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:</b> ${r.total ?? '-'} / 90</small>
          </div>
          <div class="review-preview">
            <!-- preview –≤—Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∏–∂–µ -->
          </div>
        `;

        if (createdStr) {
          reviewHTML = reviewHTML.replace('</div>\n          <div class="review-preview">', `<br><small>–î–∞—Ç–∞: ${createdStr}</small></div>\n          <div class=\"review-preview\">`);
        }

        // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç–∏—á–Ω–æ–µ 3D‚Äë–ø—Ä–µ–≤—å—é (—Å–Ω–∏–º–æ–∫ –∫–∞–¥—Ä–∞ SkinViewer),
        // –∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–µ 3D –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –º–æ–¥–∞–ª–∫–µ –ø–æ –∫–ª–∏–∫—É
        // IMG –¥–æ–±–∞–≤–∏–º –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ —à–∞–±–ª–æ–Ω–∞

        reviewDiv.innerHTML = reviewHTML;
        container.appendChild(reviewDiv);

        // –î–æ–±–∞–≤–ª—è–µ–º IMG –≤ –∫–æ–ª–æ–Ω–∫—É –ø—Ä–µ–≤—å—é –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ (–Ω–∞–¥—ë–∂–Ω–µ–µ, —á–µ–º —á–µ—Ä–µ–∑ string.replace)
        if (r.skinData) {
          const previewCol = reviewDiv.querySelector('.review-preview');
          if (previewCol) {
            const img = document.createElement('img');
            img.className = 'skin-thumb';
            img.loading = 'lazy';
            img.decoding = 'async';
            img.alt = 'skin';
            img.style.opacity = '0.95';
            // –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ ‚Äî –∏—Å—Ö–æ–¥–Ω—ã–π skinData
            try { img.src = r.skinData; } catch(_) {}
            img.addEventListener('click', () => { if (window.openSkinModal) window.openSkinModal(r.skinData); });
            const hint = document.createElement('div');
            hint.className = 'review-hint';
            hint.textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–∫–∏–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞';
            previewCol.appendChild(img);
            previewCol.appendChild(hint);

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ 3D‚Äë–∫–∞–¥—Ä–∞ –≤ –æ—á–µ—Ä–µ–¥–∏, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            window.mobilePreviewQueue = (window.mobilePreviewQueue || Promise.resolve()).then(async () => {
              try {
                const off = document.createElement('canvas');
                // –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–µ–Ω–¥–µ—Ä –ø–æ–¥ —à–∏—Ä–∏–Ω—É —Ä–æ–¥–∏—Ç–µ–ª—è, –Ω–æ –º–µ–Ω—å—à–µ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö
                const parentWidth = previewCol.clientWidth || 400;
                const isMobile = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
                const targetWidth = Math.max(220, Math.min(isMobile ? 360 : 420, parentWidth));
                const targetHeight = Math.round(targetWidth * 1.35);
                off.width = targetWidth; off.height = targetHeight;
                // –°–æ–∑–¥–∞—ë–º viewer —Å –±—É—Ñ–µ—Ä–æ–º, —á—Ç–æ–±—ã toDataURL —Ä–∞–±–æ—Ç–∞–ª —Å—Ç–∞–±–∏–ª—å–Ω–æ
                const v = new skinview3d.SkinViewer({ canvas: off, width: targetWidth, height: targetHeight, preserveDrawingBuffer: true });
                // –ù–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω, –∏–Ω–∞—á–µ –º–æ–∂–µ—Ç –∫–∞–∑–∞—Ç—å—Å—è –ø—É—Å—Ç—ã–º
                try { v.renderer.setClearColor(0x15151c, 1); } catch(_) {}
                // –Ø–≤–Ω–æ –∂–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–Ω–∞
                try { await v.loadSkin(r.skinData); } catch(_) { /* –æ—Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É */ }
                v.zoom = 0.95; v.autoRotate = false;
                try {
                  const walk = new skinview3d.WalkingAnimation(v);
                  walk.speed = 1.0; walk.paused = true; walk.progress = 0.30;
                  v.playerObject.rotation.y = -0.4;
                  v.camera.position.set(0, 24, 46);
                  v.camera.lookAt(0, 18, 0);
                } catch(e) { try { v.playerObject.rotation.y = -0.4; } catch(_) {} }
                // –î–æ–∂–∏–¥–∞–µ–º—Å—è –ø–∞—Ä—ã –∫–∞–¥—Ä–æ–≤ —Ä–µ–Ω–¥–µ—Ä–∞, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç—É—Ä—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å
                await new Promise(res => requestAnimationFrame(() => requestAnimationFrame(res)));
                img.src = off.toDataURL('image/png');
                try { v.dispose(); } catch(e){}
              } catch(e) {
                // fallback: –æ—Å—Ç–∞–≤–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π skinData
                try { img.src = r.skinData; } catch(_) {}
              }
            });
          }
        }
        reviewsLastDoc = doc;
      });

      // –ö–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë" ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –µ—â—ë —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      let moreBtn = document.getElementById('reviews-more');
      const shouldShowMore = snapshot.size >= REVIEWS_PAGE;
      if (shouldShowMore) {
        if (!moreBtn) {
          const wrap = document.createElement('div');
          wrap.style.textAlign = 'center';
          wrap.style.marginTop = '10px';
          moreBtn = document.createElement('button');
          moreBtn.id = 'reviews-more';
          moreBtn.className = 'reset-button';
          moreBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë';
          wrap.appendChild(moreBtn);
          container.parentElement.appendChild(wrap);
          moreBtn.addEventListener('click', () => loadReviews(false));
        }
        moreBtn.style.display = 'inline-block';
      } else if (moreBtn) {
        moreBtn.style.display = 'none';
      }

    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ—Ü–µ–Ω–∑–∏–π:', err);
      container.innerHTML = `<div class=\"error\" role=\"alert\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>`;
    }
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Ü–µ–Ω–∑–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  loadReviews(true);

  // –ú–æ–¥–∞–ª–∫–∞ SkinViewer (—É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä)
  let modalViewer = null;
  const modalOverlay = document.getElementById('skin-modal-overlay');
  const modalClose = document.getElementById('skin-modal-close');
  const modalCanvas = document.getElementById('skin-modal-canvas');

  function openSkinModal(skinData) {
    if (!modalOverlay || !modalCanvas) return;
    try { if (modalViewer) { modalViewer.dispose(); modalViewer = null; } } catch(e){}
    modalOverlay.style.display = 'flex';
    try {
      modalViewer = new skinview3d.SkinViewer({ canvas: modalCanvas, width: modalCanvas.width, height: modalCanvas.height, skin: skinData });
      modalViewer.zoom = 0.95; modalViewer.autoRotate = false;
      // –•–æ–¥—å–±–∞ –≤ –º–æ–¥–∞–ª–∫–µ
      try { const walk = new skinview3d.WalkingAnimation(modalViewer); walk.speed = 1.0; } catch(e) {}
      const control = skinview3d.createOrbitControls(modalViewer);
      control.enableZoom = true; control.enableRotate = true;
    } catch(e) { console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –ø—Ä–µ–≤—å—é', e); }
  }

  function closeSkinModal() {
    if (!modalOverlay) return;
    modalOverlay.style.display = 'none';
    try { if (modalViewer) { modalViewer.dispose(); modalViewer = null; } } catch(e){}
  }

  window.openSkinModal = openSkinModal;
  if (modalClose) modalClose.addEventListener('click', closeSkinModal);
  if (modalOverlay) modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeSkinModal(); });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ—Ü–µ–Ω–∑–∏–∏
  document.getElementById('submit').addEventListener('click', async () => {
    const submitBtn = document.getElementById('submit');
    const titleEl = document.getElementById('title');
    const textEl = document.getElementById('text');

    const title = titleEl.value.trim();
    const text = textEl.value.trim();

    if (!title || !text) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç —Ä–µ—Ü–µ–Ω–∑–∏–∏');
      return;
    }
    if (text.trim().length < 30) {
      alert('–¢–µ–∫—Å—Ç —Ä–µ—Ü–µ–Ω–∑–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 30 —Å–∏–º–≤–æ–ª–æ–≤.');
      return;
    }
    if (!window.currentUserUid) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏–∏.');
      return;
    }
if (!window.uploadedSkin) {
  alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å–∫–∏–Ω–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ä–µ—Ü–µ–Ω–∑–∏–∏.');
  return;
}
    submitBtn.disabled = true;
    submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

    try {
      const values = {
        line: parseInt(document.getElementById('line').value, 10),
        palette: parseInt(document.getElementById('palette').value, 10),
        shade: parseInt(document.getElementById('shade').value, 10),
        style: parseInt(document.getElementById('style').value, 10),
        vibe: parseInt(document.getElementById('vibe').value, 10)
      };

      // –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π –æ—Ü–µ–Ω–∫–∏ (–∫–∞–∫ –≤ UI)
      const vibeMultiplier = {
        1: 1, 2: 1.0675, 3: 1.1349, 4: 1.2024, 5: 1.2699,
        6: 1.3373, 7: 1.4048, 8: 1.4723, 9: 1.5397, 10: 1.6072
      };
      const total = (window.calculateTotalForSubmit ? window.calculateTotalForSubmit() : (function(){
        const baseSum = Number(values.line) + Number(values.palette) + Number(values.shade) + Number(values.style);
        const scaled = baseSum * 1.4;
        const multiplier = vibeMultiplier[Number(values.vibe)] || 1;
        return Math.round(scaled * multiplier);
      })());

      const reviewData = {
        title: title,
        text: text,
        total: total,
        line: values.line,
        palette: values.palette,
        shade: values.shade,
        style: values.style,
        vibe: values.vibe,
        userId: window.currentUserUid,
        authorName: window.currentUserDisplayName || null,
        createdAt: serverTimestamp()
      };

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ base64 —Å–∫–∏–Ω–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      // Firestore –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ~1 MiB –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç. –û—Ç–∫–ª–æ–Ω—è–µ–º –±–æ–ª—å—à–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
      if (window.uploadedSkin) {
        const dataUrl = window.uploadedSkin;
        const parts = dataUrl.split(',');
        const base64 = parts[1] || '';
        const byteSize = Math.ceil((base64.length * 3) / 4); // –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö
        const MAX_BYTES = 900000; // 900 KB - –∑–∞–ø–∞—Å –ø–µ—Ä–µ–¥ –ª–∏–º–∏—Ç–æ–º Firestore

        if (byteSize > MAX_BYTES) {
          alert('–û—à–∏–±–∫–∞: —Å–∫–∏–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firestore (‚âà' + byteSize + ' –±–∞–π—Ç). –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Å–∫–∏–Ω.');
          throw new Error('–°–∫–∏–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è Firestore');
        }

        reviewData.skinData = dataUrl;
      }

      const docRef = await addDoc(collection(db, "reviews"), reviewData);
      console.log('–î–æ–∫—É–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Å ID:', docRef.id);

      alert('‚úÖ –†–µ—Ü–µ–Ω–∑–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');

      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
      await loadReviews();

    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', err);
      alert('‚ùå –û—à–∏–±–∫–∞: ' + (err.message || err));
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }
  });

  // ===== –ü–õ–ê–¢–§–û–†–ú–ê –°–ö–ò–ù–û–í (–±–µ–∑ Storage: —Å–æ—Ö—Ä–∞–Ω—è–µ–º base64 –≤ Firestore) =====
  const skinFile = document.getElementById('skin-file-v2');
  const skinName = document.getElementById('skin-name-v2');
  const skinDesc = document.getElementById('skin-desc-v2');
  const skinBtn = document.getElementById('skin-upload-btn-v2');
  const skinErr = document.getElementById('skin-upload-error');
  const feedEl = document.getElementById('skin-feed');
  const feedSort = document.getElementById('feed-sort');

  function setSkinErr(msg) {
    if (!skinErr) return;
    if (msg) { skinErr.textContent = msg; skinErr.style.display = 'block'; } else { skinErr.textContent=''; skinErr.style.display='none'; }
  }

  async function uploadSkinBase64() {
    try {
      setSkinErr('');
      if (!window.currentUserUid) return setSkinErr('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å.');
      if (window.currentUserRole !== 'creator') return setSkinErr('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å.');
      const file = skinFile?.files?.[0];
      if (!file) return setSkinErr('–í—ã–±–µ—Ä–∏—Ç–µ PNG-—Ñ–∞–π–ª.');
      if (!file.type.includes('png')) return setSkinErr('–¢–æ–ª—å–∫–æ PNG.');
      const name = (skinName?.value || '').trim();
      if (!name) return setSkinErr('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.');
      const desc = (skinDesc?.value || '').trim();
      const dataUrl = await new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); });
      const base64 = String(dataUrl);
      if (base64.length > 1_200_000) return setSkinErr('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–æ–≥—Ä. ~900KB-1MB).');

      const docRef = await addDoc(collection(db, 'skins'), {
        authorId: window.currentUserUid,
        name,
        description: desc,
        imageData: base64,
        ratings: {},
        averageRating: 0,
        ratingCount: 0,
        createdAt: serverTimestamp()
      });
      // –æ—á–∏—Å—Ç–∫–∞
      if (skinFile) skinFile.value = '';
      if (skinName) skinName.value = '';
      if (skinDesc) skinDesc.value = '';
      await loadSkinFeed();
      alert('–°–∫–∏–Ω –∑–∞–≥—Ä—É–∂–µ–Ω!');
    } catch(e) {
      setSkinErr(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–∏–Ω');
    }
  }

  if (skinBtn) skinBtn.addEventListener('click', uploadSkinBase64);
  if (feedSort) feedSort.addEventListener('change', () => loadSkinFeed());

  async function loadSkinFeed() {
    if (!feedEl) return;
    feedEl.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã...</div>';
    try {
      const sort = (feedSort?.value || 'new');
      const ref = sort === 'top'
        ? query(collection(db, 'skins'), orderBy('averageRating', 'desc'), limit(30))
        : query(collection(db, 'skins'), orderBy('createdAt', 'desc'), limit(30));
      const snap = await getDocs(ref);
      if (snap.empty) { feedEl.innerHTML = '<div class="info-text">–°–∫–∏–Ω–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>'; return; }
      feedEl.innerHTML = '';
      snap.forEach(d => {
        const s = d.data();
        const card = document.createElement('div');
        card.className = 'review-item';
        const rightId = `skin_card_img_${d.id}`;
        card.innerHTML = `
          <div class="review-body">
            <div class="author-badge">${escapeHtml(s.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
            <p>${escapeHtml(s.description || '')}</p>
            <div class="criteria">
              <small><b>–ê–≤—Ç–æ—Ä:</b> ${escapeHtml(s.authorId || '-')}</small>
              <small><b>–°—Ä–µ–¥–Ω—è—è:</b> ${Number(s.averageRating || 0)} / 90</small>
            </div>
          </div>
          <div class="review-preview"></div>
        `;
        feedEl.appendChild(card);
        const previewCol = card.querySelector('.review-preview');
        const img = document.createElement('img');
        img.id = rightId; img.className = 'skin-thumb'; img.loading = 'lazy'; img.decoding='async'; img.alt='skin'; img.style.opacity='0.95';
        try { img.src = s.imageData; } catch(_) {}
        img.addEventListener('click', () => { if (window.openSkinModal) window.openSkinModal(s.imageData); });
        const hint = document.createElement('div'); hint.className='review-hint'; hint.textContent='–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–∫–∏–Ω –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞';
        previewCol.appendChild(img); previewCol.appendChild(hint);

        // –æ—Ç—Ä–∏—Å—É–µ–º 3D‚Äë—Å–Ω–∏–º–æ–∫
        window.mobilePreviewQueue = (window.mobilePreviewQueue || Promise.resolve()).then(async () => {
          try {
            const off = document.createElement('canvas');
            const parentWidth = previewCol.clientWidth || 360;
            const isMobile = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
            const targetWidth = Math.max(220, Math.min(isMobile ? 360 : 420, parentWidth));
            const targetHeight = Math.round(targetWidth * 1.35);
            off.width = targetWidth; off.height = targetHeight;
            const v = new skinview3d.SkinViewer({ canvas: off, width: targetWidth, height: targetHeight, preserveDrawingBuffer: true });
            try { v.renderer.setClearColor(0x15151c, 1); } catch(_) {}
            try { await v.loadSkin(s.imageData); } catch(_) {}
            v.zoom = 0.95; v.autoRotate = false;
            try { const walk = new skinview3d.WalkingAnimation(v); walk.speed=1.0; walk.paused=true; walk.progress=0.30; v.playerObject.rotation.y=-0.4; v.camera.position.set(0,24,46); v.camera.lookAt(0,18,0); } catch(_) {}
            await new Promise(res => requestAnimationFrame(() => requestAnimationFrame(res)));
            img.src = off.toDataURL('image/png');
            try { v.dispose(); } catch(_) {}
          } catch(_) { try { img.src = s.imageData; } catch(_){} }
        });

        // –†–µ–π—Ç–∏–Ω–≥ (–¥–ª—è —Ä–µ—Ü–µ–Ω–∑–µ–Ω—Ç–æ–≤)
        const canRate = window.currentUserUid && window.currentUserRole === 'reviewer';
        if (canRate) {
          const rateWrap = document.createElement('div');
          rateWrap.style.marginTop = '8px';
          const input = document.createElement('input'); input.type='number'; input.min='0'; input.max='90'; input.value='45'; input.style.width='80px'; input.style.marginRight='8px';
          const btn = document.createElement('button'); btn.className='submit-button'; btn.textContent='–û—Ü–µ–Ω–∏—Ç—å';
          rateWrap.appendChild(input); rateWrap.appendChild(btn);
          card.querySelector('.review-body').appendChild(rateWrap);
          btn.addEventListener('click', async () => {
            const val = Math.max(0, Math.min(90, parseInt(input.value,10)||0));
            try {
              await runTransaction(db, async (tx) => {
                const ref = doc(db, 'skins', d.id);
                const snap = await tx.get(ref);
                if (!snap.exists()) throw new Error('–°–∫–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
                const data = snap.data();
                const ratings = data.ratings || {};
                if (ratings[window.currentUserUid]) throw new Error('–í—ã —É–∂–µ –æ—Ü–µ–Ω–∏–ª–∏ —ç—Ç–æ—Ç —Å–∫–∏–Ω');
                ratings[window.currentUserUid] = val;
                const ratingCount = (data.ratingCount || 0) + 1;
                const averageRating = Math.round(((data.averageRating || 0) * (ratingCount - 1) + val) / ratingCount);
                tx.update(ref, { ratings, ratingCount, averageRating });
              });
              await loadSkinFeed();
              alert('–û—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
            } catch(e) { alert(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É'); }
          });
        }
      });
    } catch(e) {
      feedEl.innerHTML = '<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–µ–Ω—Ç—É.</div>';
    }
  }

  // –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã
  loadSkinFeed();

  // ===== –ê–¥–º–∏–Ω: –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π =====
  const roleUidInput = document.getElementById('role-user-uid');
  const roleNewSelect = document.getElementById('role-new-role');
  const roleApplyBtn = document.getElementById('role-apply');
  const roleAdminErr = document.getElementById('role-admin-error');

  function setRoleAdminErr(msg) {
    if (!roleAdminErr) return;
    if (msg) { roleAdminErr.textContent = msg; roleAdminErr.style.display = 'block'; } else { roleAdminErr.textContent=''; roleAdminErr.style.display='none'; }
  }

  if (roleApplyBtn) roleApplyBtn.addEventListener('click', async () => {
    try {
      setRoleAdminErr('');
      if (!window.currentUserIsAdmin) return setRoleAdminErr('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤.');
      const uid = (roleUidInput?.value || '').trim();
      const newRole = (roleNewSelect?.value === 'creator') ? 'creator' : 'reviewer';
      if (!uid) return setRoleAdminErr('–í–≤–µ–¥–∏—Ç–µ UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
      await setDoc(doc(db, 'users', uid), { role: newRole }, { merge: true });
      setRoleAdminErr('–†–æ–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∞.');
      // –æ–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∞–¥–º–∏–Ω –º–µ–Ω—è–µ—Ç —Å–∞–º —Å–µ–±—è
      if (window.currentUserUid === uid) {
        window.currentUserRole = newRole;
        const upBox = document.getElementById('skin-upload-v2');
        if (upBox) upBox.style.display = (newRole === 'creator') ? 'block' : 'none';
      }
      await loadSkinFeed();
    } catch(e) { setRoleAdminErr(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å'); }
  });
</script>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ (—Å—Ç–∞—Ç–∏—á–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞ + –ø—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const tabNav = document.getElementById('main-tabs');
  const tabBtns = tabNav ? tabNav.querySelectorAll('.tab-btn') : [];
  const resultsSection = document.getElementById('results-section');
  const uploadSkinsSection = document.getElementById('upload-skins-section');

  function activate(tab) {
    tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
    if (resultsSection) resultsSection.classList.toggle('active', tab === 'results');
    if (uploadSkinsSection) uploadSkinsSection.classList.toggle('active', tab === 'upload');
    try { history.replaceState(null, '', '#tab=' + tab); } catch(_) {}
  }

  tabBtns.forEach(btn => btn.addEventListener('click', () => activate(btn.dataset.tab)));

  function readHash() {
    const h = (location.hash || '').toLowerCase();
    if (h.includes('upload')) return 'upload';
    return 'results';
  }
  window.addEventListener('hashchange', () => activate(readHash()));
  activate(readHash());

  // –í–∏–¥–∏–º–æ—Å—Ç—å –≤–∫–ª–∞–¥–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è admin
  window.updateTabVisibility = function(role) {
    const uploadTab = document.querySelector('[data-tab="upload"]');
    if (uploadTab) uploadTab.style.display = (role === 'admin') ? 'inline-block' : 'none';
  };
});
</script>

<!-- –û–°–ù–û–í–ù–û–ô –ö–û–î –î–õ–Ø –ò–¢–û–ì–û–í –ö–û–ù–ö–£–†–°–ê –ò –ó–ê–ì–†–£–ó–ö–ò –°–ö–ò–ù–û–í -->
<script type="module">
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const db = getFirestore();
const auth = getAuth();

let currentUserRole = null;
async function loadUserRole(uid) {
  if (!uid) return null;
  try {
    const userDoc = await getDoc(doc(db, 'users', uid));
    if (userDoc.exists()) return userDoc.data().role || 'user';
    return 'user';
  } catch (_) { return 'user'; }
}

onAuthStateChanged(auth, async (user) => {
  if (user) { currentUserRole = await loadUserRole(user.uid); if (window.updateTabVisibility) window.updateTabVisibility(currentUserRole); }
  else { currentUserRole = null; if (window.updateTabVisibility) window.updateTabVisibility(null); }
});

let skinsData = [];
let reviewsData = [];
onSnapshot(query(collection(db, 'skins'), orderBy('createdAt', 'desc')), (snapshot) => {
  skinsData = []; snapshot.forEach(d => skinsData.push({ id: d.id, ...d.data() }));
  renderResults(); renderUploadedSkins();
});
onSnapshot(collection(db, 'reviews'), (snapshot) => {
  reviewsData = []; snapshot.forEach(d => reviewsData.push({ id: d.id, ...d.data() }));
  renderResults();
});

function escapeHtml(unsafe) { if (!unsafe && unsafe !== 0) return ''; return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

function renderResults() {
  const winnersContainer = document.getElementById('winners-container');
  const othersContainer = document.getElementById('others-container');
  const loadingEl = document.getElementById('results-loading');
  if (!winnersContainer || !othersContainer) return;
  if (skinsData.length === 0) { if (loadingEl) loadingEl.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç —Å–∫–∏–Ω–æ–≤ –≤ –∫–æ–Ω–∫—É—Ä—Å–µ.'; winnersContainer.innerHTML=''; othersContainer.innerHTML=''; return; }
  if (loadingEl) loadingEl.style.display = 'none';
  const skinsWithScores = skinsData.map(skin => {
    const skinReviews = reviewsData.filter(r => r.skinId === skin.id);
    const judgeScores = {};
    skinReviews.forEach(review => { if (!judgeScores[review.userId]) judgeScores[review.userId] = { authorName: review.authorName || '–°—É–¥—å—è', total: review.total || 0, reviews: [] }; judgeScores[review.userId].reviews.push(review); });
    const totals = Object.values(judgeScores).map(j => j.total);
    const avgScore = totals.length ? Math.ceil(totals.reduce((a,b)=>a+b,0)/totals.length) : 0;
    return { ...skin, judgeScores, avgScore, allReviews: skinReviews };
  });
  skinsWithScores.sort((a,b)=>b.avgScore-a.avgScore);
  const winners = skinsWithScores.slice(0,3);
  const others = skinsWithScores.slice(3);
  winnersContainer.innerHTML = winners.map((s,i)=>renderSkinCard(s,i+1,true)).join('');
  othersContainer.innerHTML = others.map((s,i)=>renderSkinCard(s,i+4,false)).join('');
}

function renderSkinCard(skin, place, isWinner) {
  const judgesList = Object.entries(skin.judgeScores).map(([_, data]) => `
    <div class="judge-card">
      <div class="judge-name">${escapeHtml(data.authorName)}</div>
      <div class="judge-score">${data.total} / 90</div>
    </div>
  `).join('');
  const judgesCount = Object.keys(skin.judgeScores).length;
  const pendingJudges = Math.max(0, 4 - judgesCount);
  const pendingCards = Array(pendingJudges).fill('').map(() => `
    <div class="judge-card">
      <div class="judge-name">–°—É–¥—å—è</div>
      <div class="judge-pending">–û–∂–∏–¥–∞–µ—Ç—Å—è</div>
    </div>
  `).join('');
  const reviewsList = (skin.allReviews||[]).map(review => `
    <div class="review-full">
      <h4>${escapeHtml(review.authorName || '–°—É–¥—å—è')}</h4>
      <p>${escapeHtml(review.text || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è')}</p>
      <div class="review-criteria">
        <span>–õ–∞–π–Ω: ${review.line || '-'}</span>
        <span>–ü–∞–ª–∏—Ç—Ä–∞: ${review.palette || '-'}</span>
        <span>–®–µ–π–¥: ${review.shade || '-'}</span>
        <span>–°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞: ${review.style || '-'}</span>
        <span>–í–∞–π–±: ${review.vibe || '-'}</span>
      </div>
      <strong>–ò—Ç–æ–≥–æ: ${review.total || '-'} / 90</strong>
    </div>
  `).join('');
  return `
    <div class="skin-card ${isWinner ? 'winner' : ''}">
      <div class="place-badge">${place === 1 ? 'ü•á' : place === 2 ? 'ü•à' : place === 3 ? 'ü•â' : '#' + place}</div>
      <img src="${skin.imageData || ''}" alt="${escapeHtml(skin.title || '–°–∫–∏–Ω')}" class="skin-thumbnail" onclick="if(window.openSkinModal) window.openSkinModal('${(skin.imageData || '').replace(/'/g, "\\'")}');" />
      <div class="skin-title">${escapeHtml(skin.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</div>
      <div class="average-score">${skin.avgScore} / 90</div>
      <div class="judges-grid">${judgesList}${pendingCards}</div>
      <details class="reviews-details"><summary>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ—Ü–µ–Ω–∑–∏–∏ (${(skin.allReviews||[]).length})</summary><div style="margin-top:10px;">${reviewsList || '<p style="color:#888;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ü–µ–Ω–∑–∏–π</p>'}</div></details>
      <button class="submit-button review-btn" data-skin-id="${skin.id}" ${disabled/reviewed?}>–û—Ü–µ–Ω–∏—Ç—å</button>
    </div>`;
}

const skinTitleInput = document.getElementById('skin-title-input');
const skinFileInput = document.getElementById('skin-file-input');
const skinPreviewImg = document.getElementById('skin-preview-img');
const uploadSkinBtn = document.getElementById('upload-skin-btn');
const uploadError = document.getElementById('upload-error');
const uploadSuccess = document.getElementById('upload-success');
let uploadedSkinData = null;

if (skinFileInput) {
  skinFileInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0]; if (!file) return;
    if (!file.type.includes('png')) { if (uploadError){ uploadError.textContent='–¢–æ–ª—å–∫–æ PNG —Ñ–∞–π–ª—ã –¥–æ–ø—É—Å—Ç–∏–º—ã.'; uploadError.style.display='block'; } return; }
    const reader = new FileReader();
    reader.onload = async (evt) => {
      const dataUrl = evt.target.result;
      try {
        const img = new Image(); await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = dataUrl; });
        const valid = (img.width === 64 && img.height === 64) || (img.width === 64 && img.height === 32);
        if (!valid) { if (uploadError){ uploadError.textContent='–†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 64√ó64 –∏–ª–∏ 64√ó32.'; uploadError.style.display='block'; } return; }
      } catch(_) { if (uploadError){ uploadError.textContent='–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.'; uploadError.style.display='block'; } return; }
      uploadedSkinData = dataUrl; if (skinPreviewImg){ skinPreviewImg.src = dataUrl; skinPreviewImg.style.display = 'block'; }
      if (uploadError) uploadError.style.display = 'none'; updateUploadBtnState();
    }; reader.readAsDataURL(file);
  });
}
if (skinTitleInput) skinTitleInput.addEventListener('input', updateUploadBtnState);
function updateUploadBtnState(){ if(!uploadSkinBtn) return; const hasTitle = skinTitleInput && skinTitleInput.value.trim().length > 0; const hasSkin = !!uploadedSkinData; uploadSkinBtn.disabled = !(hasTitle && hasSkin && currentUserRole === 'admin'); }
if (uploadSkinBtn) uploadSkinBtn.addEventListener('click', async ()=>{
  const title = skinTitleInput?.value?.trim(); if(!title||!uploadedSkinData){ alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫–∏–Ω.'); return; }
  if (currentUserRole !== 'admin'){ alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–Ω–æ–≤.'); return; }
  uploadSkinBtn.disabled = true; uploadSkinBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...'; if(uploadError) uploadError.style.display = 'none'; if(uploadSuccess) uploadSuccess.style.display = 'none';
  try {
    await addDoc(collection(db,'skins'),{ title, imageData: uploadedSkinData, createdAt: serverTimestamp() });
    if(uploadSuccess){ uploadSuccess.textContent = `‚úÖ –°–∫–∏–Ω "${title}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!`; uploadSuccess.style.display = 'block'; }
    if (skinTitleInput) skinTitleInput.value = ''; if (skinFileInput) skinFileInput.value = ''; if (skinPreviewImg) skinPreviewImg.style.display = 'none'; uploadedSkinData = null;
    setTimeout(()=>{ if(uploadSuccess) uploadSuccess.style.display = 'none'; },3000);
  } catch(err){ console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–Ω–∞:', err); if(uploadError){ uploadError.textContent = '–û—à–∏–±–∫–∞: ' + (err.message||err); uploadError.style.display = 'block'; } }
  finally { uploadSkinBtn.disabled = false; uploadSkinBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–∏–Ω'; updateUploadBtnState(); }
});

function renderUploadedSkins(){ const container = document.getElementById('uploaded-skins-list'); if(!container) return; if(skinsData.length === 0){ container.innerHTML = '<p style="text-align:center; color:#888;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–∫–∏–Ω–æ–≤.</p>'; return; } container.innerHTML = skinsData.map(skin=>`
  <div style="background:var(--surface-2); padding:15px; margin:10px 0; border-radius:8px; display:flex; align-items:center; gap:15px;">
    <img src="${skin.imageData}" style="width:64px; height:64px; image-rendering:pixelated; border:1px solid var(--line); border-radius:4px;" />
    <div>
      <strong>${escapeHtml(skin.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</strong>
      <div style="font-size:0.85em; color:#888;">ID: ${skin.id}</div>
    </div>
  </div>
`).join(''); }
</script>

</body>
</html>
