<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<link rel="icon" href="data:,">
<title>Asia Festival — Contest</title>
<style>
  :root {
    --bg: #050505;
    --bg-panel: #0a0a0f;
    --glass: rgba(20, 20, 25, 0.65);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text: #eaeaf2;
    --muted: #888899;
    --sakura: #ffb7c5;
    --neon-pink: #ff0055;
    --accent: #8a2be2; /* Cyber Violet */
    
    /* Medals */
    --gold: #ffd700;
    --silver: #c0c0c0;
    --bronze: #cd7f32;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; font-family: 'Inter', system-ui, sans-serif; 
    background: var(--bg); color: var(--text); padding: 20px; min-height: 100vh;
    background-image: 
        radial-gradient(circle at 15% 50%, rgba(138, 43, 226, 0.08), transparent 40%), 
        radial-gradient(circle at 85% 30%, rgba(255, 0, 85, 0.05), transparent 40%);
    background-attachment: fixed;
  }

  /* GLOBAL PIXEL ART FIX */
  img, canvas {
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
  }

  .wrap { max-width: 1600px; margin: 0 auto; position: relative; z-index: 2; }

  /* --- HEADER --- */
  header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding: 20px 30px;
    background: rgba(20, 20, 25, 0.4); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--glass-border); border-radius: 24px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  }
  h1 { 
    margin: 0; font-size: 1.8rem; font-weight: 900; letter-spacing: -0.02em;
    background: linear-gradient(90deg, #fff, var(--sakura)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; white-space: nowrap; 
  }
  
  .btn {
    background: linear-gradient(135deg, var(--accent), #b042ff); color: #fff; padding: 10px 20px; border-radius: 12px;
    text-decoration: none; font-weight: 700; cursor: pointer; border: none; transition: all 0.3s ease; font-size: 1rem;
    display: inline-flex; align-items: center; gap: 8px; justify-content: center;
    box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
  }
  .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(138, 43, 226, 0.5); }
  .btn:active { transform: translateY(0); }
  
  .btn-ghost { background: rgba(255,255,255,0.1); box-shadow: none; border: 1px solid var(--glass-border); }
  .btn-ghost:hover { background: rgba(255,255,255,0.2); }

  /* --- ADMIN PANEL --- */
  .admin-panel {
    background: #111; border: 1px solid #333; border-radius: 16px; margin-bottom: 30px; overflow: hidden;
    transition: all 0.3s ease;
  }
  .admin-panel.hidden { display: none; }
  .admin-header {
    padding: 15px 20px; background: #1a1a20; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
  }
  .admin-content {
    padding: 20px; display: none; gap: 10px; flex-wrap: wrap; border-top: 1px solid #333;
    background: #0a0a0f;
  }
  .admin-panel.open .admin-content { display: flex; }
  
  /* Toggle Switch for Visibility */
  .toggle-wrap {
    display: flex; align-items: center; gap: 10px; margin-left: auto; padding-left: 20px; border-left: 1px solid #333;
  }
  .toggle-label { font-size: 0.9rem; color: var(--muted); }
  .switch {
    position: relative; display: inline-block; width: 40px; height: 24px;
  }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #333; transition: .4s; border-radius: 34px;
  }
  .slider:before {
    position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px;
    background-color: white; transition: .4s; border-radius: 50%;
  }
  input:checked + .slider { background-color: var(--accent); }
  input:checked + .slider:before { transform: translateX(16px); }


  /* --- PODIUM (TOP 3) --- */
  .podium-section { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin: 60px 0 80px; min-height: 300px; }
  .podium-section.hidden { display: none; }
  
  .podium-column { display: flex; flex-direction: column; align-items: center; transition: transform 0.3s; cursor: pointer; }
  .podium-column:hover { transform: translateY(-10px); }
  
  .podium-medal-label { font-weight: 900; margin-bottom: 10px; letter-spacing: 2px; font-size: 0.9rem; }
  .medal-1 { color: var(--gold); text-shadow: 0 0 20px rgba(255,215,0,0.5); }
  .medal-2 { color: var(--silver); }
  .medal-3 { color: var(--bronze); }

  .place-card {
    width: 200px; padding: 15px; border-radius: 24px; position: relative;
    background: linear-gradient(180deg, rgba(20,20,20,0.8), rgba(10,10,10,0.95));
    border: 1px solid var(--glass-border);
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    display: flex; flex-direction: column; align-items: center; gap: 15px;
  }
  
  .col-1 .place-card { width: 240px; border: 1px solid rgba(255, 215, 0, 0.3); box-shadow: 0 0 50px rgba(255, 215, 0, 0.15); z-index: 2; }
  .col-2 { margin-bottom: -20px; }
  .col-3 { margin-bottom: -40px; }
  
  .place-img-box { width: 100%; aspect-ratio: 1; border-radius: 16px; overflow: hidden; background: #151515; }
  .place-img-box img { width: 100%; height: 100%; object-fit: contain; } /* Changed to contain for full skin visibility */
  
  .place-info { text-align: center; width: 100%; }
  .place-name { font-weight: 800; font-size: 1.2rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 5px; }
  .place-score { font-family: 'Rajdhani', sans-serif; font-size: 1.5rem; color: var(--accent); font-weight: 700; }

  /* --- GRID (LIST 4+) --- */
  .grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
    gap: 20px; 
  }
  
  .card {
    background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 20px; padding: 12px; cursor: pointer; transition: all 0.3s ease;
    display: flex; flex-direction: column; position: relative; overflow: hidden;
  }
  .card:hover { 
    transform: translateY(-5px); 
    border-color: var(--accent); 
    box-shadow: 0 10px 30px -10px rgba(138, 43, 226, 0.3);
  }

  .rank-badge {
    position: absolute; top: 12px; left: 12px; z-index: 2;
    background: rgba(0,0,0,0.8); color: #fff; font-size: 0.8rem; font-weight: 700; padding: 4px 8px; border-radius: 6px;
  }
  
  .preview-box {
    width: 100%; aspect-ratio: 1; border-radius: 16px; overflow: hidden; margin-bottom: 12px;
    background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
  }
  .preview-box img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.3s; }
  .card:hover .preview-box img { transform: scale(1.05); }
  
  .card-footer { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
  
  .card-name { 
    font-weight: 700; font-size: 1rem; color: #fff; 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;
  }
  
  .card-score-box {
    background: rgba(138, 43, 226, 0.15); border: 1px solid var(--accent);
    min-width: 40px; height: 40px; border-radius: 10px; padding: 0 8px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 900; font-size: 1.1rem; color: #fff;
  }

  /* --- MODAL (UPDATED FOR MOBILE) --- */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 100; display: none; 
    align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;
  }
  .modal-overlay.active { display: flex; opacity: 1; }

  .modal-glass {
    width: 90%; max-width: 1100px; height: 85vh; background: #0f0f12;
    border: 1px solid var(--glass-border); border-radius: 24px;
    display: grid; grid-template-columns: 1fr 380px; overflow: hidden;
    position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }

  /* Close Button */
  .modal-close {
    position: absolute; top: 20px; right: 20px; z-index: 10;
    width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff;
    transition: all 0.2s; backdrop-filter: blur(4px);
  }
  .modal-close:hover { background: var(--neon-pink); transform: rotate(90deg); }

  /* Left Side: Viewer */
  .modal-left {
    position: relative; background: radial-gradient(circle at center, #1a1a20, #050505);
    display: flex; align-items: center; justify-content: center; overflow: hidden;
  }
  #viewerContainer { width: 100%; height: 100%; }

  /* Right Side: Info */
  .modal-right {
    background: rgba(255,255,255,0.02); border-left: 1px solid var(--glass-border);
    padding: 30px; display: flex; flex-direction: column; overflow-y: auto;
  }

  .modal-header { margin-bottom: 30px; }
  .modal-title { font-size: 1.8rem; font-weight: 900; line-height: 1.2; margin-bottom: 5px; }
  .modal-author { color: var(--muted); font-size: 1rem; display: flex; align-items: center; gap: 8px; }

  .score-big-block {
    background: linear-gradient(135deg, rgba(138,43,226,0.2), transparent);
    border: 1px solid var(--accent); border-radius: 16px; padding: 20px;
    text-align: center; margin-bottom: 30px;
  }
  .score-val { font-size: 3rem; font-weight: 900; line-height: 1; color: #fff; text-shadow: 0 0 30px var(--accent); }
  .score-lbl { font-size: 0.8rem; color: var(--sakura); text-transform: uppercase; letter-spacing: 2px; margin-top: 5px; }

  /* Rating Controls */
  .rating-area {
    background: rgba(0,0,0,0.3); border-radius: 16px; padding: 20px; margin-top: auto;
  }
  .rating-area.disabled { opacity: 0.5; pointer-events: none; }
  
  .range-wrap { position: relative; margin: 30px 0 10px; }
  input[type=range] {
    -webkit-appearance: none; width: 100%; background: transparent;
  }
  input[type=range]::-webkit-slider-runnable-track {
    width: 100%; height: 6px; background: #333; border-radius: 3px;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
    background: var(--accent); margin-top: -9px; box-shadow: 0 0 15px var(--accent);
    cursor: grab;
  }

  /* --- MESSAGE STATES --- */
  .hidden-state-msg {
    text-align: center; padding: 60px 20px;
    background: rgba(255, 255, 255, 0.02); border-radius: 24px; border: 1px dashed #333;
    color: var(--muted);
  }
  .hidden-state-msg h2 { color: var(--text); margin-bottom: 10px; }

  /* --- MOBILE RESPONSIVENESS --- */
  @media (max-width: 900px) {
    .modal-glass { 
      width: 100%; height: 100dvh; max-width: none; max-height: none; border-radius: 0; border: none;
      grid-template-columns: 1fr; grid-template-rows: 45vh 1fr; /* Fixed Viewer Height */
    }
    .modal-left { border-bottom: 1px solid var(--glass-border); }
    .modal-right { border-left: none; padding: 20px; }
    .modal-close { top: 15px; right: 15px; background: rgba(0,0,0,0.6); }
  }

  @media (max-width: 768px) {
    header { flex-direction: column; gap: 15px; align-items: flex-start; }
    .header-right { width: 100%; display: flex; justify-content: space-between; }
    
    /* Grid Fixes */
    .grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .podium-section { flex-direction: column; align-items: center; gap: 40px; }
    .col-1 { order: -1; } /* First place on top */
    .place-card { width: 100%; max-width: 280px; }
    .col-1 .place-card { width: 100%; max-width: 300px; }
    .col-2, .col-3 { margin: 0; }
  }

  @media (max-width: 480px) {
    h1 { font-size: 1.4rem; }
    .grid { grid-template-columns: 1fr; } /* Single column for very small screens */
    .card { flex-direction: row; align-items: center; padding: 10px; height: 80px; }
    .card .preview-box { width: 60px; height: 60px; margin-bottom: 0; margin-right: 12px; flex-shrink: 0; }
    .rank-badge { display: none; } /* Clean up list view */
    .card-name { font-size: 1.1rem; }
  }
</style>
</head>
<body>

<div class="wrap">
  <header>
    <h1>ASIA FESTIVAL <span style="font-weight:300; color:var(--muted); font-size:0.8em">ENTRY</span></h1>
    <div class="header-right">
        <button id="authBtn" class="btn btn-ghost">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/></svg>
            <span class="logout-text">Войти</span>
        </button>
    </div>
  </header>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="admin-panel hidden">
    <div class="admin-header" onclick="document.getElementById('adminPanel').classList.toggle('open')">
        <strong>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: text-bottom; margin-right: 5px;"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
            АДМИН ПАНЕЛЬ
        </strong>
        <div class="toggle-wrap" onclick="event.stopPropagation()">
            <span class="toggle-label" style="margin-right: 8px;">Результаты видны всем:</span>
            <label class="switch">
                <input type="checkbox" id="visibilityToggle">
                <span class="slider"></span>
            </label>
        </div>
        <span class="admin-arrow" style="margin-left: 15px">▼</span>
    </div>
    <div class="admin-content">
        <input type="text" id="newAuthor" placeholder="Ник автора" style="background:#222; border:1px solid #444; color:#fff; padding:10px; border-radius:8px; flex:1;">
        <input type="file" id="newFile" accept="image/png" style="display:none">
        <button onclick="document.getElementById('newFile').click()" class="btn btn-ghost">Выбрать файл</button>
        <button id="addEntryBtn" class="btn">Добавить</button>
        <span id="adminStatus" style="color:var(--accent); font-size:0.9rem;"></span>
    </div>
  </div>

  <div id="loading" style="text-align:center; padding:50px; color:var(--muted);">Загрузка данных...</div>
  
  <div id="podiumSection" class="podium-section hidden">
      <div id="podiumWrapper" style="display:contents"></div>
  </div>
  
  <div id="grid" class="grid"></div>
</div>

<!-- MODAL -->
<div id="modal" class="modal-overlay">
  <div class="modal-glass">
    <div class="modal-close" onclick="closeModal()">✕</div>
    
    <div class="modal-left">
        <div id="viewerContainer"></div>
    </div>
    
    <div class="modal-right">
        <div class="modal-header">
            <div class="modal-title" id="mTitle">Author Name</div>
            <div class="modal-author">ID: <span id="mId">...</span></div>
        </div>
        
        <div class="score-big-block">
            <div class="score-val" id="mTotal">0</div>
            <div class="score-lbl">Общий балл</div>
        </div>

        <div id="judgeSection" class="rating-area hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <label style="font-weight:700; color:#fff;">ВАША ОЦЕНКА</label>
                <span id="scoreValDisplay" style="font-weight:900; color:var(--accent);">5</span>
            </div>
            <div class="range-wrap">
                <input type="range" id="scoreRange" min="1" max="10" step="1" value="5">
            </div>
            <button id="submitScoreBtn" class="btn" style="width:100%; margin-top:20px;">Подтвердить оценку</button>
        </div>
        <div id="loginMsg" class="rating-area disabled" style="text-align:center; margin-top:auto; display:none;">
            Оценивание только для судей.
        </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
  import { SkinViewer } from "https://cdn.jsdelivr.net/npm/skinview3d@3.0.1/dist/skinview3d.bundle.js";

  const firebaseConfig = {
      apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA", // Keep your original keys
      authDomain: "skinsrzt.firebaseapp.com",
      projectId: "skinsrzt",
      storageBucket: "skinsrzt.firebasestorage.app",
      messagingSenderId: "1.084042281569e+12",
      appId: "1:1.084042281569e+12:web:25872944cf7dac7fd66020"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);
  
  // EDIT: Replace with your actual admin email
  const ADMIN_EMAIL = "nmprokhorov@gmail.com";

  let currentUser = null;
  let isJudge = false;
  let publicVisible = false; // Default secure
  let currentSkinId = null;
  let viewer = null;
  let entries = [];
  let scores = {};

  // DOM
  const grid = document.getElementById('grid');
  const podiumSection = document.getElementById('podiumSection');
  const podiumWrapper = document.getElementById('podiumWrapper');
  const modal = document.getElementById('modal');
  const viewerContainer = document.getElementById('viewerContainer');
  const authBtn = document.getElementById('authBtn');
  const visibilityToggle = document.getElementById('visibilityToggle');

  // --- 3D VIEWER SETUP ---
  function initViewer() {
    viewerContainer.innerHTML = '';
    viewer = new SkinViewer({
        canvas: document.createElement("canvas"),
        width: 300,
        height: 400,
        skin: "img/steve.png"
    });
    viewerContainer.appendChild(viewer.canvas);
    viewer.width = viewerContainer.clientWidth;
    viewer.height = viewerContainer.clientHeight;
    viewer.controls.enableZoom = true;
    viewer.controls.enableRotate = true;
    
    // Responsive Viewer Resize
    window.addEventListener('resize', () => {
        if(viewer && modal.classList.contains('active')) {
            viewer.width = viewerContainer.clientWidth;
            viewer.height = viewerContainer.clientHeight;
        }
    });
  }

  // --- VISIBILITY LOGIC ---
  onSnapshot(doc(db, 'settings', 'asia_config'), (snap) => {
      if(snap.exists()) {
          publicVisible = snap.data().publicVisible;
      } else {
          // Init settings if missing
          setDoc(doc(db, 'settings', 'asia_config'), { publicVisible: true });
          publicVisible = true;
      }
      // Update Toggle UI
      if(visibilityToggle) visibilityToggle.checked = publicVisible;
      rebuildAll();
  });

  // Admin Toggle Action
  visibilityToggle.addEventListener('change', async (e) => {
      if(!currentUser || currentUser.email !== ADMIN_EMAIL) {
          e.target.checked = !e.target.checked; // Revert if not admin
          return;
      }
      await setDoc(doc(db, 'settings', 'asia_config'), { 
          publicVisible: e.target.checked 
      }, { merge: true });
  });

  // --- AUTH ---
  const provider = new GoogleAuthProvider();
  authBtn.addEventListener('click', async () => {
    if(!currentUser) await signInWithPopup(auth, provider);
    else await signOut(auth);
  });

  onAuthStateChanged(auth, async user => {
    currentUser = user;
    document.querySelector('.logout-text').textContent = user ? 'Выйти' : 'Войти';
    
    const isAdmin = user && user.email === ADMIN_EMAIL;
    document.getElementById('adminPanel').classList.toggle('hidden', !isAdmin);
    
    if(user) {
      // Check judge role
      const snap = await getDoc(doc(db, 'judges', user.uid));
      isJudge = snap.exists() || isAdmin; // Admin is always judge
    } else {
      isJudge = false;
    }
    rebuildAll(); // Re-render based on permissions
  });

  // --- DATA LISTENERS ---
  onSnapshot(query(collection(db, 'asia_entries'), orderBy('createdAt', 'desc')), snap => {
    entries = [];
    snap.forEach(d => entries.push({id: d.id, ...d.data()}));
    rebuildAll();
  });

  onSnapshot(collection(db, 'asia_scores'), snap => {
    scores = {};
    snap.forEach(d => {
      const s = d.data();
      if(!scores[s.entryId]) scores[s.entryId] = [];
      scores[s.entryId].push(s);
    });
    rebuildAll();
    if(currentSkinId) updateModalUI();
  });

  // --- MAIN RENDER ---
  function rebuildAll() {
    document.getElementById('loading').style.display = 'none';
    
    const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
    const canView = publicVisible || isJudge || isAdmin;

    if(!canView) {
        podiumSection.classList.add('hidden');
        grid.innerHTML = `
            <div class="hidden-state-msg" style="grid-column: 1/-1;">
                <h2>⏳ Оценивание в процессе</h2>
                <p>Результаты скрыты до окончания судейства.</p>
            </div>`;
        return;
    }

    const sorted = [...entries].map(e => {
        const entryScores = scores[e.id] || [];
        const total = entryScores.reduce((acc, cur) => acc + cur.score, 0);
        return { ...e, total };
    }).sort((a,b) => b.total - a.total);

    const podiumList = sorted.slice(0, 3);
    const gridList = sorted.slice(3);

    renderPodium(podiumList);
    renderGrid(gridList);
  }

  function renderPodium(list) {
    if(list.length === 0) { podiumSection.classList.add('hidden'); return; }
    podiumSection.classList.remove('hidden');
    podiumWrapper.innerHTML = '';

    const order = [1, 0, 2]; // 2nd, 1st, 3rd
    const labels = ['1 МЕСТО', '2 МЕСТО', '3 МЕСТО'];
    const classes = ['medal-1', 'medal-2', 'medal-3'];

    order.forEach(idx => {
        if(!list[idx]) return;
        const e = list[idx];
        const col = document.createElement('div');
        col.className = `podium-column col-${idx+1}`;
        col.innerHTML = `
            <div class="podium-medal-label ${classes[idx]}">${labels[idx]}</div>
            <div class="place-card" onclick="window.openEntry('${e.id}')">
                <div class="place-img-box"><img src="${e.previewUrl || e.skinUrl}"></div>
                <div class="place-info">
                    <div class="place-name">${escapeHtml(e.authorName)}</div>
                    <div class="place-score">${e.total}</div>
                </div>
            </div>
        `;
        podiumWrapper.appendChild(col);
    });
  }

  function renderGrid(list) {
    grid.innerHTML = '';
    list.forEach((e, index) => {
      const rank = index + 4;
      const card = document.createElement('div');
      card.className = 'card';
      card.onclick = () => openModal(e);
      card.innerHTML = `
        <div class="rank-badge">#${rank}</div>
        <div class="preview-box"><img src="${e.previewUrl || e.skinUrl}"></div>
        <div class="card-footer">
            <div class="card-name">${escapeHtml(e.authorName)}</div>
            <div class="card-score-box">${e.total}</div>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  // --- MODAL LOGIC ---
  window.openModal = function(entry) {
    currentSkinId = entry.id;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden'; // Prevent background scroll
    
    document.getElementById('mTitle').textContent = entry.authorName;
    document.getElementById('mId').textContent = entry.id.slice(0,8);
    
    if(!viewer) initViewer();
    viewer.loadSkin(entry.skinUrl);
    
    // Force resize for mobile
    setTimeout(() => {
        viewer.width = viewerContainer.clientWidth;
        viewer.height = viewerContainer.clientHeight;
    }, 100);

    updateModalUI();
  };

  window.closeModal = function() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
    currentSkinId = null;
    if(viewer) viewer.dispose();
    viewer = null;
  };
  
  // Allow clicking outside to close
  modal.addEventListener('click', (e) => {
      if(e.target === modal) closeModal();
  });

  // Hook for podium clicks
  window.openEntry = (id) => {
      const entry = entries.find(e => e.id === id);
      if(entry) openModal(entry);
  };

  function updateModalUI() {
    if(!currentSkinId) return;
    const entryScores = scores[currentSkinId] || [];
    const total = entryScores.reduce((acc, cur) => acc + cur.score, 0);
    document.getElementById('mTotal').textContent = total;

    const judgeSec = document.getElementById('judgeSection');
    const loginMsg = document.getElementById('loginMsg');
    
    if(isJudge) {
        judgeSec.classList.remove('hidden');
        loginMsg.style.display = 'none';
        // Check if already rated
        const myScore = entryScores.find(s => s.judgeUid === currentUser.uid);
        const btn = document.getElementById('submitScoreBtn');
        const range = document.getElementById('scoreRange');
        const display = document.getElementById('scoreValDisplay');
        
        if(myScore) {
            range.value = myScore.score;
            display.textContent = myScore.score;
            btn.textContent = "Изменить оценку";
            btn.classList.add('btn-ghost');
        } else {
            range.value = 5;
            display.textContent = 5;
            btn.textContent = "Подтвердить оценку";
            btn.classList.remove('btn-ghost');
        }
    } else {
        judgeSec.classList.add('hidden');
        loginMsg.style.display = 'block';
    }
  }

  // Score Inputs
  const range = document.getElementById('scoreRange');
  range.addEventListener('input', (e) => document.getElementById('scoreValDisplay').textContent = e.target.value);

  document.getElementById('submitScoreBtn').addEventListener('click', async () => {
      if(!currentUser || !isJudge || !currentSkinId) return;
      const val = parseInt(range.value);
      const btn = document.getElementById('submitScoreBtn');
      btn.disabled = true;
      
      try {
          // Composite ID for uniqueness: entryId_judgeId
          const scoreId = `${currentSkinId}_${currentUser.uid}`;
          await setDoc(doc(db, 'asia_scores', scoreId), {
              entryId: currentSkinId,
              judgeUid: currentUser.uid,
              judgeName: currentUser.displayName,
              score: val,
              timestamp: serverTimestamp()
          });
          // Button visual feedback
          btn.textContent = "Сохранено!";
          setTimeout(() => btn.disabled = false, 1000);
      } catch(e) {
          console.error(e);
          alert("Ошибка сохранения");
          btn.disabled = false;
      }
  });

  // --- ADMIN ADD ENTRY ---
  document.getElementById('addEntryBtn').addEventListener('click', async () => {
      if(!currentUser || currentUser.email !== ADMIN_EMAIL) return;
      
      const fileInput = document.getElementById('newFile');
      const authorInput = document.getElementById('newAuthor');
      const file = fileInput.files[0];
      
      if(!file || !authorInput.value) {
          alert("Выберите файл и введите имя");
          return;
      }

      const status = document.getElementById('adminStatus');
      status.textContent = "Загрузка...";
      
      try {
          // Upload Skin
          const storageRef = ref(storage, `asia_skins/${Date.now()}_${file.name}`);
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          
          // Add to Firestore
          await addDoc(collection(db, 'asia_entries'), {
              authorName: authorInput.value,
              skinUrl: url,
              previewUrl: url, // Using same for now, can be optimized later
              createdAt: serverTimestamp()
          });
          
          status.textContent = "Успешно!";
          fileInput.value = '';
          authorInput.value = '';
          setTimeout(() => status.textContent = '', 3000);
      } catch(e) {
          console.error(e);
          status.textContent = "Ошибка";
      }
  });

  function escapeHtml(text) {
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }
</script>
</body>
</html>
