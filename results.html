
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Итоги конкурса — Results</title>
<style>
  :root{
    --bg:#0e0e12; --card:#14141a; --accent:#8a2be2; --text:#eaeaf2; --muted:#9aa0b2;
  }
  body{ margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); padding:22px; }
  .wrap{ max-width:1100px; margin:0 auto; }
  header{ display:flex; align-items:center; gap:12px; margin-bottom:18px; }
  .btn{ background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; font-weight:700; cursor:pointer; border: none; }
  .podium{ display:flex; gap:12px; margin-bottom:18px; }
  .place{ flex:1; background:linear-gradient(180deg, rgba(138,43,226,0.08), rgba(20,16,30,0.5)); border-radius:10px; padding:10px; border:1px solid rgba(138,43,226,0.12); cursor:pointer; }
  .grid{ display:grid; grid-template-columns:1fr; gap:12px; }
  .card{ display:flex; gap:12px; align-items:flex-start; padding:10px; background:var(--card); border-radius:10px; border:1px solid rgba(255,255,255,0.03); cursor:pointer; }
  .thumb{ width:180px; height:180px; border-radius:10px; overflow:hidden; background:#0b0b0d; display:flex; align-items:center; justify-content:center; }
  .meta{ flex:1; }
  .meta h2{ margin:0 0 6px 0; font-size:1rem; }
  .small{ color:var(--muted); font-size:0.9rem; }
  .pill{ background:#0f0f12; padding:6px 8px; border-radius:8px; display:inline-block; margin-right:6px; font-weight:700; }
  .admin-form{ margin:12px 0; padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; }
  .hidden{ display:none; }
  input, button, textarea, select { font-family:inherit; }
  .file-label{ display:inline-block; padding:8px 10px; background:#111217; border-radius:8px; cursor:pointer; border:1px solid rgba(255,255,255,0.03); margin-right:8px; }
  .admin-small{ color:var(--muted); font-size:0.85rem; margin-top:6px; }
  @media (max-width:900px){
    .thumb{ width:140px; height:140px; }
    .podium{ flex-direction:column; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Итоги конкурса</h1>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <a href="index.html" class="btn" style="background:#444">Вернуться</a>
        <button id="signBtn" class="btn">Войти</button>
      </div>
    </header>

    <!-- admin form: видна только администратору (email = nmprokhorov@gmail.com) -->
    <div id="adminWrap" class="admin-form hidden">
      <strong>Добавить скин в конкурс (админ)</strong>
      <div style="margin-top:8px;">
        <input id="authorInput" placeholder="Ник автора" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);width:240px;margin-right:8px;">
        <label class="file-label">Выбрать файл <input id="fileInput" type="file" accept=".png,.jpg,.jpeg" style="display:none"></label>
        <button id="addBtn" class="btn" style="margin-left:8px;">Добавить</button>
        <span id="adminMsg" class="small" style="margin-left:8px;"></span>
      </div>
      <div class="admin-small">Файл сохраняется как dataURL в документе <code>contest_entries</code>.</div>
    </div>

    <div id="podiumWrap" class="podium" style="display:none;"></div>
    <div id="listWrap" class="grid"></div>
    <div id="emptyMsg" class="small" style="text-align:center;margin-top:18px;display:none;">Пока нет конкурсных скинов.</div>
  </div>

  <!-- SkinView3D -->
<script src="https://cdn.jsdelivr.net/npm/skinview3d@3.4.1/bundle/skinview3d.bundle.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";


const firebaseConfig = {
      apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
      authDomain: "skinsrzt.firebaseapp.com",
      projectId: "skinsrzt",
      storageBucket: "skinsrzt.appspot.com",
      messagingSenderId: "1084042281569",
      appId: "1:1084042281569:web:25872944cf7dac7fd66020"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // элементы
    const adminWrap = document.getElementById('adminWrap');
    const authorInput = document.getElementById('authorInput');
    const fileInput = document.getElementById('fileInput');
    const addBtn = document.getElementById('addBtn');
    const adminMsg = document.getElementById('adminMsg');
    const listWrap = document.getElementById('listWrap');
    const podiumWrap = document.getElementById('podiumWrap');
    const emptyMsg = document.getElementById('emptyMsg');
    const signBtn = document.getElementById('signBtn');

    const ADMIN_EMAIL = "nmprokhorov@gmail.com";

    let currentUser = null;

    // auth controls
    const provider = new GoogleAuthProvider();
    signBtn.addEventListener('click', async () => {
      if (!currentUser) {
        try {
          await signInWithPopup(auth, provider);
        } catch(e){ alert('Ошибка входа: ' + e.message); }
      } else {
        await signOut(auth);
      }
    });

    onAuthStateChanged(auth, user => {
      currentUser = user;
      signBtn.textContent = user ? 'Выйти (' + (user.emailuser.displayName'') + ')' : 'Войти';
      adminWrap.classList.toggle('hidden', !(user && user.email === ADMIN_EMAIL));
    });

    // add entry (admin)
    addBtn.addEventListener('click', async () => {
      adminMsg.textContent = '';
      if (!currentUser || currentUser.email !== ADMIN_EMAIL) { adminMsg.textContent = 'Требуется вход админа'; return; }
      const author = (authorInput.value || '').trim();
      const f = fileInput.files[0];
      if (!author) { adminMsg.textContent = 'Введите ник автора'; return; }
      if (!f) { adminMsg.textContent = 'Выберите файл'; return; }
      adminMsg.textContent = 'Загрузка...';
      const reader = new FileReader();
      reader.onload = async (ev) => {
        try {
          const dataUrl = ev.target.result;
          await addDoc(collection(db, 'contest_entries'), {
            authorName: author,
            skinData: dataUrl,
            createdAt: serverTimestamp()
          });
          adminMsg.textContent = 'Добавлено!';
          authorInput.value = ''; fileInput.value = '';
          setTimeout(()=> adminMsg.textContent = '',2000);
        } catch(e) {
          console.error(e);
          adminMsg.textContent = 'Ошибка: ' + (e.message||e);
        }
      };
      reader.readAsDataURL(f);
    });

    // слушаем contest_entries и contest_scores, пересчитываем рейтинги
    let entries = {}; // id -> { ... }
    let scores = {};  // skinId -> [scoreDocs]

    const entriesQ = query(collection(db, 'contest_entries'), orderBy('createdAt','desc'));
    onSnapshot(entriesQ, snap => {
      snap.docChanges().forEach(ch => {
        const id = ch.doc.id;
        if (ch.type === 'removed') delete entries[id];
        else entries[id] = { id, ...ch.doc.data() };
      });
      rebuild();
    });

    const scoresQ = query(collection(db, 'contest_scores'), orderBy('createdAt','asc'));
    onSnapshot(scoresQ, snap => {
      scores = {};
      snap.forEach(d => {
        const o = d.data();
        const sid = o.skinId;
        if (!scores[sid]) scores[sid] = [];
        scores[sid].push({ id: d.id, ...o });
      });
      rebuild();
    });

    function rebuild(){
      const arr = Object.values(entries).map(e => {
        const s = scores[e.id] || [];
        const judgeCount = s.length;
        const sum = s.reduce((a,b)=>a+(b.total||0),0);
        const avgRaw = judgeCount? sum/judgeCount : 0;
        const avgCeil = judgeCount? Math.ceil(avgRaw) : 0;
        return { ...e, judgeCount, judges: s, sum, avgRaw, avgCeil };
      });


if (!arr.length) {
        listWrap.innerHTML = '';
        podiumWrap.style.display = 'none';
        emptyMsg.style.display = 'block';
        return;
      }
      emptyMsg.style.display = 'none';
      // сортировка по avgCeil, потом avgRaw
      arr.sort((a,b) => {
        if (b.avgCeil !== a.avgCeil) return b.avgCeil - a.avgCeil;
        return (b.avgRaw  0) - (a.avgRaw  0);
      });

      // топ-3
      const top3 = arr.slice(0,3);

      // показать podium
      podiumWrap.innerHTML = '';
      podiumWrap.style.display = top3.length ? 'flex' : 'none';
      top3.forEach((it, idx) => {
        const place = idx+1;
        const el = document.createElement('div');
        el.className = 'place';
        el.innerHTML = 
          <div style="display:flex;gap:8px;align-items:center;">
            <div style="width:80px;height:80px;border-radius:8px;overflow:hidden;background:#000" id="pv_${it.id}"></div>
            <div>
              <div style="font-weight:800">${escapeHtml(it.authorName || '—')}</div>
              <div class="small">Место: ${place}</div>
              <div style="margin-top:6px;"><span class="pill">Avg: ${it.avgCeil} / 90</span></div>
            </div>
          </div>
        ;
        el.addEventListener('click', ()=> window.location.href = 'skin.html?id='+it.id);
        podiumWrap.appendChild(el);
        // init mini skinview
        setTimeout(()=> initMiniViewer(pv_${it.id}, it.skinData), 60);
      });

      // общий список (включаем топ-3 также)
      listWrap.innerHTML = '';
      arr.forEach((it, idx) => {
        const place = idx+1;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = 
          <div class="thumb" id="thumb_${it.id}"></div>
          <div class="meta">
            <h2>${escapeHtml(it.authorName || '—')}</h2>
            <div class="small">Место: <strong>${place}</strong> • Судей: ${it.judgeCount}</div>
            <div style="margin-top:8px;">
              <span class="pill">Avg: ${it.avgCeil} / 90</span>
              <span class="pill">Сумма: ${it.sum}</span>
            </div>
          </div>
        ;
        card.addEventListener('click', ()=> window.location.href = 'skin.html?id='+it.id);
        listWrap.appendChild(card);
        setTimeout(()=> initMiniViewer(thumb_${it.id}, it.skinData), 60);
      });
    }

    function initMiniViewer(containerId, skinDataUrl){
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = ''; // clear
      try {
        const canvas = document.createElement('canvas');
        canvas.width = el.clientWidth || 160;
        canvas.height = el.clientHeight || 160;
        el.appendChild(canvas);
        const viewer = new skinview3d.SkinViewer({
          canvas: canvas,
          width: canvas.width,
          height: canvas.height,
          skin: skinDataUrl || ''
        });
        viewer.autoUpdate = true;
        viewer.rotation.y = Math.PI/6;
      } catch(e){
        el.innerHTML = <img src="${skinDataUrl||''}" style="width:100%;height:100%;object-fit:cover" />;
      }
    }

    function escapeHtml(s){ if (!s && s !== 0) return ''; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  </script>
</body>
</html>
