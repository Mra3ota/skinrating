<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="data:,">
<title>–ò—Ç–æ–≥–∏ –∫–æ–Ω–∫—É—Ä—Å–∞ ‚Äî Results</title>
<style>
  :root{
    --bg:#0e0e12; --card:#14141a; --accent:#8a2be2; --text:#eaeaf2; --muted:#9aa0b2;
    --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32;
  }
  * { box-sizing: border-box; }
  body{ margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); padding:22px; }
  .wrap{ max-width:1200px; margin:0 auto; }
  header{ display:flex; align-items:center; gap:12px; margin-bottom:24px; flex-wrap:wrap; }
  .btn{ background:var(--accent); color:#fff; padding:10px 16px; border-radius:8px; text-decoration:none; font-weight:700; cursor:pointer; border: none; transition: all 0.3s ease; font-size:0.95rem; }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(138,43,226,0.4); }
  
  .podium-title{ text-align:center; font-size:1.8rem; font-weight:800; margin-bottom:32px; background: linear-gradient(90deg, var(--gold), var(--silver), var(--bronze)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -0.5px; }
  
  .podium{ display:flex; align-items:flex-end; justify-content:center; gap:20px; margin-bottom:40px; padding:20px; }
  .place{ background:linear-gradient(135deg, rgba(138,43,226,0.1), rgba(20,16,30,0.6)); border-radius:16px; padding:20px; border:2px solid rgba(138,43,226,0.15); cursor:pointer; position:relative; overflow:hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); display:flex; flex-direction:column; align-items:center; justify-content:flex-end; }
  .place:hover{ transform: translateY(-12px) scale(1.02); box-shadow: 0 16px 40px rgba(138,43,226,0.4); border-color: rgba(138,43,226,0.4); }
  .place::before{ content:''; position:absolute; top:0; left:0; right:0; height:5px; }
  
  .place-1{ width:300px; height:380px; border-color: var(--gold); order:2; }
  .place-1::before{ background: linear-gradient(90deg, var(--gold), #ffed4e); box-shadow: 0 0 20px rgba(255,215,0,0.5); }
  
  .place-2{ width:280px; height:320px; border-color: var(--silver); order:1; }
  .place-2::before{ background: linear-gradient(90deg, var(--silver), #e8e8e8); box-shadow: 0 0 20px rgba(192,192,192,0.5); }
  
  .place-3{ width:280px; height:280px; border-color: var(--bronze); order:3; }
  .place-3::before{ background: linear-gradient(90deg, var(--bronze), #e89b5f); box-shadow: 0 0 20px rgba(205,127,50,0.5); }
  
  .medal{ font-size:3.5rem; margin-bottom:16px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4)); animation: float 3s ease-in-out infinite; position:relative; z-index:10; }
  @keyframes float{ 0%, 100%{ transform: translateY(0); } 50%{ transform: translateY(-8px); } }
  
  .place-content{ display:flex; flex-direction:column; align-items:center; text-align:center; width:100%; }
  .place-preview{ width:140px; height:180px; margin:0 auto 16px; border-radius:12px; overflow:hidden; background:#0a0a0f; position:relative; box-shadow: 0 8px 24px rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.05); }
  .place-preview img{ width:100%; height:100%; object-fit:contain; transition: transform 0.4s ease; }
  .place:hover .place-preview img{ transform: scale(1.1) rotate(2deg); }
  
  .place-author{ font-weight:800; font-size:1.3rem; margin-bottom:8px; letter-spacing:-0.3px; line-height:1.2; }
  .place-number{ font-size:1.1rem; font-weight:700; margin-bottom:12px; opacity:0.9; }
  .place-1 .place-number{ color: var(--gold); }
  .place-2 .place-number{ color: var(--silver); }
  .place-3 .place-number{ color: var(--bronze); }
  
  .place-score{ background:rgba(138,43,226,0.25); padding:12px 20px; border-radius:10px; font-size:1.2rem; font-weight:800; border: 1px solid rgba(138,43,226,0.3); margin-top:auto; }
  
  .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
  .card{ display:flex; gap:14px; align-items:center; padding:14px; background:var(--card); border-radius:12px; border:1px solid rgba(255,255,255,0.05); cursor:pointer; transition: all 0.3s ease; position:relative; }
  .card:hover{ transform: translateX(6px); border-color: rgba(138,43,226,0.4); box-shadow: -6px 0 16px rgba(138,43,226,0.25); background: rgba(20,20,26,0.9); }
  
  .thumb{ width:140px; height:140px; min-width:140px; border-radius:10px; overflow:hidden; background:#0a0a0f; display:flex; align-items:center; justify-content:center; position:relative; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.03); }
  .thumb img{ width:100%; height:100%; object-fit:cover; transition: transform 0.3s ease; }
  .card:hover .thumb img{ transform: scale(1.08); }
  
  .meta{ flex:1; min-width:0; }
  .meta h2{ margin:0 0 8px 0; font-size:1.15rem; font-weight:700; letter-spacing:-0.2px; }
  .small{ color:var(--muted); font-size:0.9rem; line-height:1.5; }
  .score-badge{ background:rgba(138,43,226,0.2); padding:8px 14px; border-radius:8px; display:inline-block; font-weight:700; font-size:1rem; border: 1px solid rgba(138,43,226,0.3); margin-top:10px; }
  
  .admin-form{ margin:16px 0; padding:16px; background:rgba(255,255,255,0.02); border-radius:12px; border: 1px solid rgba(255,255,255,0.05); }
  .hidden{ display:none; }
  input, button, textarea, select { font-family:inherit; }
  input[type="text"]{ padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:#0e0e12; color:var(--text); font-size:0.95rem; }
  input[type="text"]:focus{ outline:none; border-color:var(--accent); }
  .file-label{ display:inline-block; padding:10px 14px; background:#1a1a22; border-radius:8px; cursor:pointer; border:1px solid rgba(255,255,255,0.08); transition: all 0.2s ease; font-size:0.95rem; }
  .file-label:hover{ background:#242430; border-color: rgba(138,43,226,0.4); }
  .admin-small{ color:var(--muted); font-size:0.85rem; margin-top:8px; }
  
  .loading-spinner{ width:40px; height:40px; border:3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius:50%; animation: spin 0.8s linear infinite; }
  @keyframes spin{ to{ transform: rotate(360deg); } }
  
  @media (max-width:900px){
    .thumb{ width:100px; height:100px; min-width:100px; }
    .podium{ flex-direction:column; align-items:center; gap:16px; }
    .place-1, .place-2, .place-3{ width:100% !important; max-width:360px; height:auto !important; min-height:280px; order:initial !important; }
    .medal{ font-size:2.5rem; }
    .place-author{ font-size:1.1rem; }
    .podium-title{ font-size:1.4rem; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 style="font-size:1.8rem; font-weight:800; margin:0;">üèÜ –ò—Ç–æ–≥–∏ –∫–æ–Ω–∫—É—Ä—Å–∞</h1>
      <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
        <a href="index.html" class="btn" style="background:#333">–í–µ—Ä–Ω—É—Ç—å—Å—è</a>
        <button id="signBtn" class="btn">–í–æ–π—Ç–∏</button>
      </div>
    </header>

    <!-- admin form -->
    <div id="adminWrap" class="admin-form hidden">
      <strong style="font-size:1.05rem;">–î–æ–±–∞–≤–∏—Ç—å —Å–∫–∏–Ω –≤ –∫–æ–Ω–∫—É—Ä—Å (–∞–¥–º–∏–Ω)</strong>
      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <input id="authorInput" type="text" placeholder="–ù–∏–∫ –∞–≤—Ç–æ—Ä–∞" style="width:240px;">
        <label class="file-label">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª <input id="fileInput" type="file" accept=".png,.jpg,.jpeg" style="display:none"></label>
        <button id="addBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button>
        <span id="adminMsg" class="small" style="margin-left:8px;"></span>
      </div>
      <div class="admin-small">–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ dataURL –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ <code>contest_entries</code>.</div>
    </div>

    <div id="podiumSection" style="display:none;">
      <div class="podium-title">üéâ –ü—Ä–∏–∑—ë—Ä—ã –∫–æ–Ω–∫—É—Ä—Å–∞ üéâ</div>
      <div id="podiumWrap" class="podium"></div>
    </div>
    
    <div id="listWrap" class="grid"></div>
    <div id="emptyMsg" class="small" style="text-align:center;margin-top:32px;display:none;font-size:1.05rem;">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–Ω–∫—É—Ä—Å–Ω—ã—Ö —Å–∫–∏–Ω–æ–≤.</div>
  </div>

  <!-- SkinView3D -->
  <script src="https://unpkg.com/skinview3d/bundles/skinview3d.bundle.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
      authDomain: "skinsrzt.firebaseapp.com",
      projectId: "skinsrzt",
      storageBucket: "skinsrzt.appspot.com",
      messagingSenderId: "1084042281569",
      appId: "1:1084042281569:web:25872944cf7dac7fd66020"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const adminWrap = document.getElementById('adminWrap');
    const authorInput = document.getElementById('authorInput');
    const fileInput = document.getElementById('fileInput');
    const addBtn = document.getElementById('addBtn');
    const adminMsg = document.getElementById('adminMsg');
    const listWrap = document.getElementById('listWrap');
    const podiumWrap = document.getElementById('podiumWrap');
    const podiumSection = document.getElementById('podiumSection');
    const emptyMsg = document.getElementById('emptyMsg');
    const signBtn = document.getElementById('signBtn');

    const ADMIN_EMAIL = "nmprokhorov@gmail.com";
    const MEDALS = ['ü•á', 'ü•à', 'ü•â'];

    let currentUser = null;

    const provider = new GoogleAuthProvider();
    signBtn.addEventListener('click', async () => {
      if (!currentUser) {
        try {
          await signInWithPopup(auth, provider);
        } catch(e){ alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + e.message); }
      } else {
        await signOut(auth);
      }
    });

    onAuthStateChanged(auth, user => {
      currentUser = user;
      signBtn.textContent = user ? '–í—ã–π—Ç–∏ (' + (user.email || user.displayName || '') + ')' : '–í–æ–π—Ç–∏';
      adminWrap.classList.toggle('hidden', !(user && user.email === ADMIN_EMAIL));
    });

    addBtn.addEventListener('click', async () => {
      adminMsg.textContent = '';
      if (!currentUser || currentUser.email !== ADMIN_EMAIL) { adminMsg.textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –∞–¥–º–∏–Ω–∞'; return; }
      const author = (authorInput.value || '').trim();
      const f = fileInput.files[0];
      if (!author) { adminMsg.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∞–≤—Ç–æ—Ä–∞'; return; }
      if (!f) { adminMsg.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'; return; }
      adminMsg.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      const reader = new FileReader();
      reader.onload = async (ev) => {
        try {
          const dataUrl = ev.target.result;
          await addDoc(collection(db, 'contest_entries'), {
            authorName: author,
            skinData: dataUrl,
            createdAt: serverTimestamp()
          });
          adminMsg.textContent = '‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ!';
          authorInput.value = ''; fileInput.value = '';
          setTimeout(()=> adminMsg.textContent = '',2000);
        } catch(e) {
          console.error(e);
          adminMsg.textContent = '–û—à–∏–±–∫–∞: ' + (e.message||e);
        }
      };
      reader.readAsDataURL(f);
    });

    let entries = {};
    let scores = {};

    const entriesQ = query(collection(db, 'contest_entries'), orderBy('createdAt','desc'));
    onSnapshot(entriesQ, snap => {
      snap.docChanges().forEach(ch => {
        const id = ch.doc.id;
        if (ch.type === 'removed') delete entries[id];
        else entries[id] = { id, ...ch.doc.data() };
      });
      rebuild();
    });

    const scoresQ = query(collection(db, 'contest_scores'), orderBy('createdAt','asc'));
    onSnapshot(scoresQ, snap => {
      scores = {};
      snap.forEach(d => {
        const o = d.data();
        const sid = o.skinId;
        if (!scores[sid]) scores[sid] = [];
        scores[sid].push({ id: d.id, ...o });
      });
      rebuild();
    });

    function rebuild(){
      const arr = Object.values(entries).map(e => {
        const s = scores[e.id] || [];
        const judgeCount = s.length;
        const sum = s.reduce((a,b)=>a+(b.total||0),0);
        const avgRaw = judgeCount? sum/judgeCount : 0;
        const avgCeil = judgeCount? Math.ceil(avgRaw) : 0;
        return { ...e, judgeCount, judges: s, sum, avgRaw, avgCeil };
      });

      if (!arr.length) {
        listWrap.innerHTML = '';
        podiumSection.style.display = 'none';
        emptyMsg.style.display = 'block';
        return;
      }
      emptyMsg.style.display = 'none';
      
      arr.sort((a,b) => {
        if (b.avgCeil !== a.avgCeil) return b.avgCeil - a.avgCeil;
        return (b.avgRaw || 0) - (a.avgRaw || 0);
      });

      const top3 = arr.slice(0,3);

      podiumWrap.innerHTML = '';
      podiumSection.style.display = top3.length ? 'block' : 'none';
      top3.forEach((it, idx) => {
        const place = idx+1;
        const el = document.createElement('div');
        el.className = `place place-${place}`;
        el.innerHTML = `
          <div class="medal">${MEDALS[idx]}</div>
          <div class="place-content">
            <div class="place-preview" id="pv_${it.id}">
              <div class="loading-spinner" style="margin:auto;"></div>
            </div>
            <div class="place-author">${escapeHtml(it.authorName || '‚Äî')}</div>
            <div class="place-number">${place} –º–µ—Å—Ç–æ</div>
            <div class="place-score">‚≠ê ${it.avgCeil} / 90</div>
          </div>
        `;
        el.addEventListener('click', ()=> window.location.href = 'skin.html?id='+it.id);
        podiumWrap.appendChild(el);
        setTimeout(()=> init3DPreview(`pv_${it.id}`, it.skinData), 100);
      });

      listWrap.innerHTML = '';
      arr.forEach((it, idx) => {
        const place = idx+1;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="thumb" id="thumb_${it.id}">
            <div class="loading-spinner"></div>
          </div>
          <div class="meta">
            <h2>${escapeHtml(it.authorName || '‚Äî')}</h2>
            <div class="small">üìç –ú–µ—Å—Ç–æ: <strong>${place}</strong> ‚Ä¢ üë• –û—Ü–µ–Ω–æ–∫: ${it.judgeCount}</div>
            <div class="score-badge">‚≠ê –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ${it.avgCeil} / 90</div>
          </div>
        `;
        card.addEventListener('click', ()=> window.location.href = 'skin.html?id='+it.id);
        listWrap.appendChild(card);
        setTimeout(()=> init3DPreview(`thumb_${it.id}`, it.skinData), 100);
      });
    }

    // 3D –ø—Ä–µ–≤—å—é –∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ
    window.previewQueue = (window.previewQueue || Promise.resolve());
    
    async function init3DPreview(containerId, skinDataUrl){
      const container = document.getElementById(containerId);
      if (!container || !skinDataUrl) return;
      
      window.previewQueue = window.previewQueue.then(async () => {
        try {
          const img = document.createElement('img');
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.opacity = '0.95';
          img.loading = 'lazy';
          img.decoding = 'async';
          
          // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
          img.src = skinDataUrl;
          container.innerHTML = '';
          container.appendChild(img);
          
          // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 3D –∫–∞–¥—Ä–∞
          const off = document.createElement('canvas');
          const parentWidth = container.clientWidth || 180;
          const isMobile = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
          const targetWidth = Math.max(180, Math.min(isMobile ? 360 : 420, parentWidth));
          const targetHeight = Math.round(targetWidth * 1.35);
          off.width = targetWidth;
          off.height = targetHeight;
          
          const viewer = new skinview3d.SkinViewer({
            canvas: off,
            width: targetWidth,
            height: targetHeight,
            preserveDrawingBuffer: true
          });
          
          try { viewer.renderer.setClearColor(0x15151c, 1); } catch(_) {}
          
          await viewer.loadSkin(skinDataUrl);
          viewer.zoom = 0.95;
          viewer.autoRotate = false;
          
          try {
            const walk = new skinview3d.WalkingAnimation(viewer);
            walk.speed = 1.0;
            walk.paused = true;
            walk.progress = 0.30;
            viewer.playerObject.rotation.y = -0.4;
            viewer.camera.position.set(0, 24, 46);
            viewer.camera.lookAt(0, 18, 0);
          } catch(e) {
            try { viewer.playerObject.rotation.y = -0.4; } catch(_) {}
          }
          
          await new Promise(res => requestAnimationFrame(() => requestAnimationFrame(res)));
          
          img.src = off.toDataURL('image/png');
          
          try { viewer.dispose(); } catch(e) {}
        } catch(e) {
          console.error('3D preview error:', e);
          const img = document.createElement('img');
          img.src = skinDataUrl;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          container.innerHTML = '';
          container.appendChild(img);
        }
      });
    }

    function escapeHtml(s){ if (!s && s !== 0) return ''; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  </script>
</body>
</html>
