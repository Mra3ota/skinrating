<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="data:,">
<title>Конкурсы</title>
<style>
  :root{
    --bg:#0e0e12; --card:#14141a; --accent:#8a2be2; --text:#eaeaf2; --muted:#9aa0b2;
    --active: #4ade80; --finished: #9aa0b2; --danger: #ef4444;
  }
  * { box-sizing: border-box; }
  body{ margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); padding:22px; }
  .wrap{ max-width:1200px; margin:0 auto; }
  
  /* SVG Icons base style */
  .icon { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }
  .icon-sm { width: 14px; height: 14px; }
  
  header{ display:flex; align-items:center; justify-content: space-between; margin-bottom:40px; padding-bottom:16px; border-bottom:1px solid rgba(255,255,255,0.05); flex-wrap: wrap; gap: 16px; }
  header h1{ font-size:1.8rem; font-weight:800; margin:0; letter-spacing:-0.5px; display:flex; align-items:center; gap:12px; }
  
  .nav-group { display:flex; gap:10px; align-items:center; }

  .btn{ background:var(--accent); color:#fff; padding:10px 16px; border-radius:8px; text-decoration:none; font-weight:700; cursor:pointer; border: none; transition: all 0.3s ease; font-size:0.9rem; display:inline-flex; align-items:center; gap: 8px; }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(138,43,226,0.4); }
  .btn-secondary{ background:#1f1f28; border: 1px solid rgba(255,255,255,0.08); }
  .btn-secondary:hover{ background:#2a2a35; box-shadow: 0 4px 12px rgba(255,255,255,0.1); }
  .btn-danger{ background:rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
  .btn-danger:hover{ background:rgba(239, 68, 68, 0.25); transform: translateY(-2px); }

  .section-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px; }
  .section-title::after { content: ''; height: 1px; background: rgba(255,255,255,0.1); flex: 1; }
  
  .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .dot-active { background: var(--active); box-shadow: 0 0 8px rgba(74, 222, 128, 0.4); }
  .dot-past { background: var(--muted); }

  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 24px; margin-bottom: 60px; }
  
  .contest-card {
    background: var(--card); border-radius: 16px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.3s ease; cursor: pointer; display: flex; flex-direction: column; position: relative;
  }
  .contest-card:hover { transform: translateY(-6px); border-color: rgba(138,43,226,0.4); box-shadow: 0 12px 32px rgba(0,0,0,0.4); }
  
  .card-cover { height: 150px; background: #1a1a22; position: relative; overflow: hidden; }
  .card-cover-gradient { width: 100%; height: 100%; background: linear-gradient(135deg, #2a2a35 0%, #1a1a22 100%); }
  
  .card-status {
    position: absolute; top: 12px; left: 12px; padding: 6px 10px; border-radius: 6px;
    font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
    backdrop-filter: blur(8px); z-index: 2; display: flex; align-items: center; gap: 6px;
  }
  .status-active { background: rgba(74, 222, 128, 0.15); color: var(--active); border: 1px solid rgba(74, 222, 128, 0.2); }
  .status-finished { background: rgba(154, 160, 178, 0.15); color: var(--finished); border: 1px solid rgba(154, 160, 178, 0.2); }
  
  .card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
  .card-title { font-size: 1.2rem; font-weight: 800; margin: 0 0 8px 0; line-height: 1.3; }
  .card-desc { color: var(--muted); font-size: 0.9rem; line-height: 1.6; margin-bottom: 20px; flex: 1; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  
  .card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: auto; pt: 16px; border-top: 1px solid rgba(255,255,255,0.05); }
  .card-date { font-size: 0.85rem; color: var(--muted); font-weight: 500; display:flex; align-items:center; gap:6px; }
  
  .admin-controls {
    position: absolute; top: 12px; right: 12px; display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; z-index: 10;
  }
  .contest-card:hover .admin-controls { opacity: 1; }
  .admin-btn { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; color: #fff; transition: all 0.2s; backdrop-filter: blur(4px); }
  .btn-edit { background: rgba(138,43,226,0.8); }
  .btn-edit:hover { background: var(--accent); }
  .btn-del { background: rgba(239, 68, 68, 0.8); }
  .btn-del:hover { background: var(--danger); }

  .empty-msg { color: var(--muted); font-size: 0.95rem; padding: 40px; background: rgba(255,255,255,0.015); border-radius: 12px; text-align: center; border: 1px dashed rgba(255,255,255,0.1); }

  /* Modal */
  .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(4px); }
  .modal.active { display:flex; }
  .modal-content { background:var(--card); border-radius:16px; padding:28px; max-width:500px; width:100%; border:1px solid rgba(138,43,226,0.2); box-shadow:0 8px 32px rgba(0,0,0,0.6); animation: modalPop 0.3s ease; }
  @keyframes modalPop { from{transform:scale(0.95);opacity:0;} to{transform:scale(1);opacity:1;} }
  
  .modal h2 { margin:0 0 20px 0; font-size:1.4rem; color:var(--accent); }
  
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 600; color: var(--muted); }
  .form-input, .form-select, .form-textarea { 
    width: 100%; background: #0b0b0e; border: 1px solid rgba(255,255,255,0.1); 
    color: var(--text); padding: 10px 12px; border-radius: 8px; font-family: inherit; font-size: 0.95rem;
    transition: border-color 0.3s;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-row { display: flex; gap: 12px; }
  .form-row > div { flex: 1; }

  .fade-in { animation: fadeInUp 0.5s forwards; opacity: 0; }
  @keyframes fadeInUp { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }

  .hidden { display: none !important; }

  @media (max-width: 640px) {
    .grid { grid-template-columns: 1fr; }
    header { flex-direction: column; align-items: flex-start; }
    .nav-group { margin-left: 0; width: 100%; justify-content: space-between; margin-top: 12px; }
    .admin-controls { opacity: 1; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>
        <svg class="icon" style="width:32px;height:32px;color:var(--accent)" viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
        Конкурсы
      </h1>
      <div class="nav-group">
        <button id="createBtn" class="btn hidden" style="background:#1e1e24;border:1px dashed rgba(138,43,226,0.5)">
          <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
          Добавить
        </button>
        <a href="index.html" class="btn btn-secondary">
          <svg class="icon" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
          В галерею
        </a>
        <button id="signBtn" class="btn">
          <svg class="icon" viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
          Войти
        </button>
      </div>
    </header>

    <div id="activeSection">
      <div class="section-title"><span class="status-dot dot-active"></span> Актуальные</div>
      <div id="activeGrid" class="grid"></div>
    </div>

    <div id="pastSection">
      <div class="section-title"><span class="status-dot dot-past"></span> Прошедшие</div>
      <div id="pastGrid" class="grid"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Конкурс</h2>
      <div class="form-group">
        <label>Название</label>
        <input type="text" id="inpTitle" class="form-input" placeholder="Например: Halloween 2025">
      </div>
      <div class="form-group">
        <label>Описание</label>
        <textarea id="inpDesc" class="form-textarea" placeholder="Краткое описание сути конкурса..."></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Статус</label>
          <select id="inpStatus" class="form-select">
            <option value="active">Активный</option>
            <option value="finished">Завершен</option>
          </select>
        </div>
        <div class="form-group">
          <label>Даты</label>
          <input type="text" id="inpDate" class="form-input" placeholder="окт - ноя 2025">
        </div>
      </div>
      <div class="form-group">
        <label>Ссылка на итоги/форму (URL)</label>
        <input type="text" id="inpLink" class="form-input" placeholder="results.html или внешняя ссылка">
      </div>
      <div style="display:flex; gap:10px; margin-top:24px;">
        <button id="saveBtn" class="btn" style="flex:1">Сохранить</button>
        <button id="closeModal" class="btn btn-secondary">Отмена</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
      authDomain: "skinsrzt.firebaseapp.com",
      projectId: "skinsrzt",
      storageBucket: "skinsrzt.appspot.com",
      messagingSenderId: "1084042281569",
      appId: "1:1084042281569:web:25872944cf7dac7fd66020"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_EMAIL = "nmprokhorov@gmail.com";

    const activeGrid = document.getElementById('activeGrid');
    const pastGrid = document.getElementById('pastGrid');
    const signBtn = document.getElementById('signBtn');
    const createBtn = document.getElementById('createBtn');
    
    // Modal elements
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const inpTitle = document.getElementById('inpTitle');
    const inpDesc = document.getElementById('inpDesc');
    const inpStatus = document.getElementById('inpStatus');
    const inpDate = document.getElementById('inpDate');
    const inpLink = document.getElementById('inpLink');
    const saveBtn = document.getElementById('saveBtn');
    const closeModal = document.getElementById('closeModal');

    let currentUser = null;
    let currentEditId = null;

    // Auth
    const provider = new GoogleAuthProvider();
    signBtn.addEventListener('click', async () => {
      if (!currentUser) {
        try { await signInWithPopup(auth, provider); } catch(e){ alert(e.message); }
      } else {
        await signOut(auth);
      }
    });

    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        signBtn.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> Выйти`;
      } else {
        signBtn.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg> Войти`;
      }
      
      // Show admin controls
      const isAdmin = user && user.email === ADMIN_EMAIL;
      createBtn.classList.toggle('hidden', !isAdmin);
      document.querySelectorAll('.admin-controls').forEach(el => {
        el.style.display = isAdmin ? 'flex' : 'none';
      });
    });

    // Load Contests
    const q = query(collection(db, 'contests'), orderBy('createdAt', 'desc'));
    onSnapshot(q, snap => {
      const contests = [];
      snap.forEach(doc => contests.push({id: doc.id, ...doc.data()}));
      render(contests);
    });

    function render(list) {
      activeGrid.innerHTML = '';
      pastGrid.innerHTML = '';
      
      // Сортировка: Активные сначала по дате создания, Прошедшие тоже
      // Можно добавить логику сортировки, если нужно
      
      let activeCount = 0;
      let pastCount = 0;

      list.forEach(c => {
        const isActive = c.status === 'active';
        const target = isActive ? activeGrid : pastGrid;
        
        const card = document.createElement('div');
        card.className = 'contest-card fade-in';
        
        // Admin buttons
        const adminHtml = `
          <div class="admin-controls" style="display:${(currentUser && currentUser.email === ADMIN_EMAIL) ? 'flex' : 'none'}">
             <button class="admin-btn btn-edit" data-id="${c.id}">
               <svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
             </button>
             <button class="admin-btn btn-del" data-id="${c.id}">
               <svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
             </button>
          </div>
        `;

        const statusBadge = isActive 
          ? `<div class="card-status status-active"><span class="status-dot dot-active" style="width:6px;height:6px"></span> Идет прием</div>`
          : `<div class="card-status status-finished"><span class="status-dot dot-past" style="width:6px;height:6px"></span> Завершен</div>`;
        
        const btnText = isActive ? 'Участвовать' : 'Смотреть итоги';
        
        card.innerHTML = `
          ${adminHtml}
          <div class="card-cover">
            <div class="card-cover-gradient"></div>
            ${statusBadge}
          </div>
          <div class="card-body">
            <div class="card-title">${escapeHtml(c.title)}</div>
            <div class="card-desc">${escapeHtml(c.description)}</div>
            <div class="card-meta">
              <div class="card-date">
                <svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                ${escapeHtml(c.dateLabel)}
              </div>
              <div style="color:var(--accent);font-weight:700;font-size:0.9rem;display:flex;align-items:center;gap:4px;">
                ${btnText} <svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
              </div>
            </div>
          </div>
        `;

        // Edit click
        card.querySelector('.btn-edit').addEventListener('click', (e) => {
          e.stopPropagation();
          openModal(c);
        });
        // Delete click
        card.querySelector('.btn-del').addEventListener('click', async (e) => {
          e.stopPropagation();
          if(confirm('Удалить конкурс безвозвратно?')) {
            await deleteDoc(doc(db, 'contests', c.id));
          }
        });
        // Card click
        card.addEventListener('click', (e) => {
          // Don't trigger if clicking admin controls
          if (e.target.closest('.admin-controls')) return;
          
          if (c.link && c.link !== '#') {
             window.location.href = c.link;
          } else {
             alert('Ссылка еще не настроена');
          }
        });

        target.appendChild(card);
        if(isActive) activeCount++; else pastCount++;
      });

      if(activeCount === 0) activeGrid.innerHTML = '<div class="empty-msg">Сейчас нет активных конкурсов.</div>';
      if(pastCount === 0) pastGrid.innerHTML = '<div class="empty-msg">Архив пуст.</div>';
    }

    // Modal Logic
    createBtn.addEventListener('click', () => openModal());
    closeModal.addEventListener('click', () => modal.classList.remove('active'));
    
    function openModal(data = null) {
      if (data) {
        currentEditId = data.id;
        modalTitle.textContent = 'Редактировать';
        inpTitle.value = data.title;
        inpDesc.value = data.description;
        inpStatus.value = data.status;
        inpDate.value = data.dateLabel;
        inpLink.value = data.link;
      } else {
        currentEditId = null;
        modalTitle.textContent = 'Новый конкурс';
        inpTitle.value = '';
        inpDesc.value = '';
        inpStatus.value = 'active';
        inpDate.value = '';
        inpLink.value = '';
      }
      modal.classList.add('active');
    }

    saveBtn.addEventListener('click', async () => {
      const title = inpTitle.value.trim();
      if (!title) return alert('Введите название');
      
      const payload = {
        title,
        description: inpDesc.value.trim(),
        status: inpStatus.value,
        dateLabel: inpDate.value.trim(),
        link: inpLink.value.trim(),
        updatedAt: serverTimestamp()
      };

      saveBtn.disabled = true;
      try {
        if (currentEditId) {
          await updateDoc(doc(db, 'contests', currentEditId), payload);
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db, 'contests'), payload);
        }
        modal.classList.remove('active');
      } catch(e) {
        alert('Ошибка: ' + e.message);
      }
      saveBtn.disabled = false;
    });

    function escapeHtml(s) { return s ? String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }
  </script>
</body>
</html>
