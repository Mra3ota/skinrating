<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ú–∞—Å—Ç–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö</title>
<style>
  :root{ --bg:#0e0e12; --card:#14141a; --accent:#8a2be2; --text:#eaeaf2; --muted:#9aa0b2; --success:#4ade80; --error:#f87171; }
  * { box-sizing: border-box; }
  body{ margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); padding:40px; }
  .container{ max-width:900px; margin:0 auto; background:var(--card); border-radius:16px; padding:32px; border:1px solid rgba(255,255,255,0.05); }
  h1{ margin:0 0 10px 0; font-size:2rem; font-weight:800; color:var(--accent); }
  .subtitle { color: var(--muted); margin-bottom: 24px; }
  
  .warning{ background:rgba(255,77,77,0.1); border:1px solid rgba(255,77,77,0.3); border-radius:8px; padding:16px; margin:20px 0; }
  .warning strong{ color:#ff4d4d; }

  .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; }
  .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--muted); }
  select, input[type="checkbox"] { padding: 8px; background: #000; color: #fff; border: 1px solid #333; border-radius: 6px; }
  select { width: 100%; font-size: 1rem; height: 40px; }

  .btn{ background:var(--accent); color:#fff; padding:14px 24px; border-radius:8px; cursor:pointer; border:none; font-weight:700; transition: all 0.3s ease; font-size:1rem; }
  .btn:hover{ filter: brightness(1.2); }
  .btn:disabled{ background:#444; cursor:not-allowed; opacity:0.7; }
  .btn-secondary{ background:#333; }

  .progress-bar{ width:100%; height:20px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden; margin:20px 0; position: relative; }
  .progress-fill{ height:100%; background:linear-gradient(90deg, var(--accent), #9b4dff); width: 0%; transition:width 0.3s; }
  .progress-text { position: absolute; top: 0; left: 0; right: 0; bottom: 0; text-align: center; font-size: 12px; line-height: 20px; font-weight: bold; text-shadow: 0 1px 2px black; }

  .log{ background:#000; border-radius:8px; padding:16px; margin-top:20px; height:300px; overflow-y:auto; font-family:monospace; font-size:0.85rem; border: 1px solid #333; }
  .log-item{ margin:4px 0; border-bottom: 1px solid #111; padding-bottom: 2px; }
  .log-item.success{ color:var(--success); }
  .log-item.error{ color:var(--error); }
  .log-item.info{ color:var(--muted); }

  .stats{ display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-bottom:24px; }
  .stat-card{ background:rgba(138,43,226,0.1); border:1px solid rgba(138,43,226,0.3); border-radius:8px; padding:16px; text-align:center; }
  .stat-value{ font-size:1.8rem; font-weight:800; color:var(--accent); }
  .hidden{ display:none; }
</style>
</head>
<body>
  <div class="container">
    <h1>üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h1>
    <div class="subtitle">–ü–µ—Ä–µ–Ω–æ—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ Firestore Base64 –≤ Firebase Storage</div>
    
    <div class="warning">
      <strong>‚ö†Ô∏è –í–ê–ñ–ù–û:</strong> –°–¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø (—ç–∫—Å–ø–æ—Ä—Ç) –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ Google Cloud Console –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º!
    </div>

    <div id="authSection">
      <button id="signInBtn" class="btn">–í–æ–π—Ç–∏ –∫–∞–∫ –ê–¥–º–∏–Ω</button>
      <p id="authStatus" style="margin-top:12px; color:var(--muted);"></p>
    </div>
    
    <div id="mainSection" class="hidden">
      <div class="controls">
        <div class="control-group">
          <label>1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é:</label>
          <select id="collectionSelect">
            <option value="skins">üì∏ –ì–∞–ª–µ—Ä–µ—è (skins)</option>
            <option value="contest_entries">üèÜ –ö–æ–Ω–∫—É—Ä—Å—ã (contest_entries)</option>
          </select>
        </div>
        <div class="control-group">
          <label>2. –û–ø—Ü–∏–∏:</label>
          <div style="display:flex; align-items:center; gap:10px; height:40px;">
            <input type="checkbox" id="deleteSource" checked>
            <label for="deleteSource" style="margin:0; cursor:pointer; color: #fff;">–£–¥–∞–ª—è—Ç—å Base64 –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏</label>
          </div>
          <small style="color:var(--muted)">–≠—Ç–æ —Å–∏–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏—Ç —Ä–∞–∑–º–µ—Ä –±–∞–∑—ã</small>
        </div>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="totalDocs">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="toMigrate">0</div>
          <div class="stat-label">–ù—É–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="alreadyDone">0</div>
          <div class="stat-label">–£–∂–µ –≥–æ—Ç–æ–≤–æ</div>
        </div>
      </div>
      
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <button id="refreshStatsBtn" class="btn btn-secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        <button id="testBtn" class="btn btn-secondary">üß™ –¢–µ—Å—Ç (1 —Ñ–∞–π–ª)</button>
        <button id="startBtn" class="btn">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é</button>
        <a href="index.html" class="btn btn-secondary" style="margin-left:auto;text-decoration:none;">–í—ã—Ö–æ–¥</a>
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
        <div class="progress-text" id="progressText">0%</div>
      </div>
      
      <div class="log" id="logContainer">
        <div class="log-item info">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É".</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
      authDomain: "skinsrzt.firebaseapp.com",
      projectId: "skinsrzt",
      storageBucket: "skinsrzt.firebasestorage.app", // –ò–°–ü–†–ê–í–õ–ï–ù–û!
      messagingSenderId: "1084042281569",
      appId: "1:1084042281569:web:25872944cf7dac7fd66020"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const ADMIN_EMAIL = "nmprokhorov@gmail.com";

    // UI Elements
    const authSection = document.getElementById('authSection');
    const mainSection = document.getElementById('mainSection');
    const logContainer = document.getElementById('logContainer');
    const collectionSelect = document.getElementById('collectionSelect');
    const deleteSourceCheckbox = document.getElementById('deleteSource');
    
    // Stats
    const totalDocsEl = document.getElementById('totalDocs');
    const toMigrateEl = document.getElementById('toMigrate');
    const alreadyDoneEl = document.getElementById('alreadyDone');

    let docsToProcess = [];

    // --- AUTH ---
    const provider = new GoogleAuthProvider();
    document.getElementById('signInBtn').addEventListener('click', async () => {
      try { await signInWithPopup(auth, provider); } 
      catch(e) { addLog('error', 'Auth error: ' + e.message); }
    });

    onAuthStateChanged(auth, user => {
      if (user && user.email === ADMIN_EMAIL) {
        authSection.classList.add('hidden');
        mainSection.classList.remove('hidden');
        addLog('success', `–ê–¥–º–∏–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${user.email}`);
        loadStats();
      } else if (user) {
        document.getElementById('authStatus').textContent = '–ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (–Ω—É–∂–µ–Ω nmprokhorov@gmail.com)';
      }
    });

    // --- LOGIC ---

    function addLog(type, msg) {
      const div = document.createElement('div');
      div.className = `log-item ${type}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logContainer.appendChild(div);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    document.getElementById('refreshStatsBtn').addEventListener('click', loadStats);
    collectionSelect.addEventListener('change', loadStats);

    async function loadStats() {
      const collName = collectionSelect.value;
      addLog('info', `–ê–Ω–∞–ª–∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ${collName}...`);
      
      try {
        const snap = await getDocs(collection(db, collName));
        let total = 0;
        let need = 0;
        let done = 0;
        
        docsToProcess = [];

        snap.forEach(d => {
          total++;
          const data = d.data();
          // –ö—Ä–∏—Ç–µ—Ä–∏–π –º–∏–≥—Ä–∞—Ü–∏–∏: –ï—Å—Ç—å skinData (base64) –ò (–Ω–µ—Ç skinUrl –ò–õ–ò skinUrl –ø—É—Å—Ç–æ–π)
          if (data.skinData && (!data.skinUrl || !data.skinUrl.startsWith('http'))) {
            need++;
            docsToProcess.push(d);
          } else {
            done++;
          }
        });

        totalDocsEl.textContent = total;
        toMigrateEl.textContent = need;
        alreadyDoneEl.textContent = done;
        
        addLog('info', `–ù–∞–π–¥–µ–Ω–æ ${need} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.`);
      } catch(e) {
        addLog('error', '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –±–∞–∑—ã: ' + e.message);
      }
    }

    async function migrateDocument(docSnap) {
      const collName = collectionSelect.value;
      const id = docSnap.id;
      const data = docSnap.data();
      const name = data.name || data.authorName || id;

      // –í—ã–±–æ—Ä –ø–∞–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (—Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º Storage)
      const folder = collName === 'skins' ? 'gallery-skins' : 'contest-skins';
      const path = `${folder}/${id}.png`;
      
      try {
        addLog('info', `–ó–∞–≥—Ä—É–∑–∫–∞ ${name} –≤ ${path}...`);
        
        // 1. Upload Base64 to Storage
        const storageRef = ref(storage, path);
        await uploadString(storageRef, data.skinData, 'data_url', { contentType: 'image/png' });
        
        // 2. Get URL
        const url = await getDownloadURL(storageRef);
        
        // 3. Update Firestore
        const updatePayload = { skinUrl: url };
        if (deleteSourceCheckbox.checked) {
          updatePayload.skinData = deleteField(); // –£–¥–∞–ª—è–µ–º —Ç—è–∂–µ–ª–æ–µ –ø–æ–ª–µ
        }
        
        await updateDoc(doc(db, collName, id), updatePayload);
        
        addLog('success', `OK: ${name}`);
        return true;
      } catch(e) {
        addLog('error', `FAIL ${name}: ${e.message}`);
        return false;
      }
    }

    async function runBatch(isTest = false) {
      const list = isTest ? docsToProcess.slice(0, 1) : docsToProcess;
      if (list.length === 0) {
        alert('–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏. –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É".');
        return;
      }

      const btns = document.querySelectorAll('button');
      btns.forEach(b => b.disabled = true);

      let processed = 0;
      let errors = 0;

      for (const d of list) {
        const success = await migrateDocument(d);
        if (!success) errors++;
        processed++;

        // Update UI
        const pct = Math.round((processed / list.length) * 100);
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressText').textContent = `${processed}/${list.length} (${pct}%)`;

        // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞, —á—Ç–æ–±—ã –Ω–µ –∑–∞–¥—É—à–∏—Ç—å —Å–µ—Ç—å
        await new Promise(r => setTimeout(r, 500));
      }

      addLog('info', `=== –ó–ê–í–ï–†–®–ï–ù–û. –û—à–∏–±–æ–∫: ${errors} ===`);
      btns.forEach(b => b.disabled = false);
      loadStats(); // –û–±–Ω–æ–≤–∏—Ç—å —Ü–∏—Ñ—Ä—ã
    }

    document.getElementById('testBtn').addEventListener('click', () => runBatch(true));
    document.getElementById('startBtn').addEventListener('click', () => {
      if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ë—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${docsToProcess.length} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.`)) {
        runBatch(false);
      }
    });

  </script>
</body>
</html>
