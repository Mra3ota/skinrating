<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="data:,">
<title>–ú–∏–≥—Ä–∞—Ü–∏—è —Å–∫–∏–Ω–æ–≤ –≤ Storage</title>
<style>
  :root{ --bg:#0e0e12; --card:#14141a; --accent:#8a2be2; --text:#eaeaf2; --muted:#9aa0b2; }
  * { box-sizing: border-box; }
  body{ margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); padding:40px; }
  .container{ max-width:800px; margin:0 auto; background:var(--card); border-radius:16px; padding:32px; border:1px solid rgba(255,255,255,0.05); }
  h1{ margin:0 0 16px 0; font-size:2rem; font-weight:800; color:var(--accent); }
  .warning{ background:rgba(255,77,77,0.1); border:1px solid rgba(255,77,77,0.3); border-radius:8px; padding:16px; margin:20px 0; }
  .warning strong{ color:#ff4d4d; }
  .btn{ background:var(--accent); color:#fff; padding:14px 24px; border-radius:8px; cursor:pointer; border:none; font-weight:700; transition: all 0.3s ease; font-size:1rem; }
  .btn:hover{ transform: translateY(-2px); box-shadow: 0 4px 12px rgba(138,43,226,0.5); }
  .btn:disabled{ background:#555; cursor:not-allowed; opacity:0.5; }
  .btn-secondary{ background:#333; }
  .progress-section{ margin:24px 0; display:none; }
  .progress-section.active{ display:block; }
  .progress-bar{ width:100%; height:12px; background:rgba(255,255,255,0.1); border-radius:12px; overflow:hidden; margin:12px 0; }
  .progress-fill{ height:100%; background:linear-gradient(90deg, var(--accent), #9b4dff); transition:width 0.3s; border-radius:12px; }
  .status{ font-size:1rem; margin:8px 0; color:var(--muted); }
  .status.success{ color:#4ade80; }
  .status.error{ color:#f87171; }
  .log{ background:#0a0a0f; border-radius:8px; padding:16px; margin:16px 0; max-height:300px; overflow-y:auto; font-family:monospace; font-size:0.85rem; line-height:1.6; }
  .log-item{ margin:4px 0; }
  .log-item.success{ color:#4ade80; }
  .log-item.error{ color:#f87171; }
  .log-item.info{ color:#a9a9b8; }
  .stats{ display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin:24px 0; }
  .stat-card{ background:rgba(138,43,226,0.1); border:1px solid rgba(138,43,226,0.3); border-radius:8px; padding:16px; text-align:center; }
  .stat-value{ font-size:2rem; font-weight:800; color:var(--accent); }
  .stat-label{ font-size:0.9rem; color:var(--muted); margin-top:8px; }
  .hidden{ display:none; }
  .cors-fix{ background:rgba(255,165,0,0.1); border:1px solid rgba(255,165,0,0.3); border-radius:8px; padding:16px; margin:20px 0; }
  .cors-fix code{ background:#000; padding:2px 6px; border-radius:4px; font-family:monospace; font-size:0.9rem; }
  .cors-fix pre{ background:#000; padding:12px; border-radius:6px; overflow-x:auto; margin:8px 0; }
</style>
</head>
<body>
  <div class="container">
    <h1>üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–∫–∏–Ω–æ–≤ –≤ Firebase Storage</h1>
    <p style="color:var(--muted); margin-bottom:24px;">–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–∏–Ω–æ–≤ –∏–∑ Firestore (base64) –≤ Firebase Storage –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –∑–∞—Ç—Ä–∞—Ç –∏ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.</p>
    
    <div class="warning">
      <strong>‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!</strong>
      <ul style="margin:8px 0 0 0; padding-left:20px;">
        <li>–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (nmprokhorov@gmail.com)</li>
        <li>–°–æ–∑–¥–∞–π—Ç–µ backup Firestore –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º</li>
        <li>–ü—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç</li>
        <li>–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</li>
      </ul>
    </div>

    <div class="cors-fix">
      <strong>üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!):</strong>
      <ol style="margin:8px 0 0 0; padding-left:20px; line-height:1.8;">
        <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ <a href="https://cloud.google.com/sdk/docs/install" target="_blank" style="color:var(--accent);">Google Cloud SDK</a></li>
        <li>–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å: <code>gcloud auth login</code></li>
        <li>–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª <code>cors.json</code>:</li>
      </ol>
      <pre>[
  {
    "origin": ["*"],
    "method": ["GET", "HEAD", "PUT", "POST", "DELETE", "OPTIONS"],
    "responseHeader": ["Content-Type", "Access-Control-Allow-Origin"],
    "maxAgeSeconds": 3600
  }
]</pre>
      <ol start="4" style="margin:0; padding-left:20px; line-height:1.8;">
        <li>–ü—Ä–∏–º–µ–Ω–∏—Ç–µ: <code>gsutil cors set cors.json gs://skinsrzt.appspot.com</code></li>
      </ol>
    </div>
    
    <div id="authSection">
      <button id="signInBtn" class="btn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
      <p id="authStatus" style="margin-top:12px; color:var(--muted);"></p>
    </div>
    
    <div id="mainSection" class="hidden">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="totalSkins">0</div>
          <div class="stat-label">–í—Å–µ–≥–æ —Å–∫–∏–Ω–æ–≤</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="toMigrate">0</div>
          <div class="stat-label">–ö –º–∏–≥—Ä–∞—Ü–∏–∏</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="migrated">0</div>
          <div class="stat-label">–ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ</div>
        </div>
      </div>
      
      <div style="display:flex; gap:12px; margin-bottom:24px;">
        <button id="startBtn" class="btn">üöÄ –ù–∞—á–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é</button>
        <button id="testBtn" class="btn btn-secondary">üß™ –¢–µ—Å—Ç (1 —Å–∫–∏–Ω)</button>
        <button id="backBtn" class="btn btn-secondary" onclick="location.href='index.html'">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</button>
      </div>
      
      <div class="progress-section" id="progressSection">
        <h3 style="margin:0 0 12px 0;">–ü—Ä–æ–≥—Ä–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="status" id="progressStatus">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: 0/0</div>
      </div>
      
      <div>
        <h3 style="margin:24px 0 12px 0;">–ñ—É—Ä–Ω–∞–ª –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
        <div class="log" id="logContainer">
          <div class="log-item info">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBTClf2FpsEGwBBP6hFNFV2Zn8DordYLkA",
      authDomain: "skinsrzt.firebaseapp.com",
      projectId: "skinsrzt",
      storageBucket: "skinsrzt.appspot.com"

      messagingSenderId: "1084042281569",
      appId: "1:1084042281569:web:25872944cf7dac7fd66020"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const ADMIN_EMAIL = "nmprokhorov@gmail.com";

    const authSection = document.getElementById('authSection');
    const mainSection = document.getElementById('mainSection');
    const signInBtn = document.getElementById('signInBtn');
    const authStatus = document.getElementById('authStatus');
    const totalSkins = document.getElementById('totalSkins');
    const toMigrate = document.getElementById('toMigrate');
    const migrated = document.getElementById('migrated');
    const startBtn = document.getElementById('startBtn');
    const testBtn = document.getElementById('testBtn');
    const progressSection = document.getElementById('progressSection');
    const progressFill = document.getElementById('progressFill');
    const progressStatus = document.getElementById('progressStatus');
    const logContainer = document.getElementById('logContainer');

    let currentUser = null;

    const provider = new GoogleAuthProvider();
    signInBtn.addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch(e) {
        authStatus.textContent = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + e.message;
        authStatus.style.color = '#f87171';
      }
    });

    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if (user) {
        if (user.email === ADMIN_EMAIL) {
          authSection.classList.add('hidden');
          mainSection.classList.remove('hidden');
          await loadStats();
        } else {
          authStatus.textContent = '‚úó –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ —Å ' + ADMIN_EMAIL;
          authStatus.style.color = '#f87171';
        }
      } else {
        authSection.classList.remove('hidden');
        mainSection.classList.add('hidden');
        authStatus.textContent = '–í–æ–π–¥–∏—Ç–µ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
      }
    });

    async function loadStats() {
      try {
        const snapshot = await getDocs(collection(db, 'skins'));
        const total = snapshot.size;
        let needMigration = 0;
        let alreadyMigrated = 0;

        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.skinData && !data.skinUrl) {
            needMigration++;
          } else if (data.skinUrl) {
            alreadyMigrated++;
          }
        });

        totalSkins.textContent = total;
        toMigrate.textContent = needMigration;
        migrated.textContent = alreadyMigrated;
        
        addLog('info', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${total} —Å–∫–∏–Ω–æ–≤, –ö –º–∏–≥—Ä–∞—Ü–∏–∏: ${needMigration}`);
      } catch(e) {
        addLog('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + e.message);
      }
    }

    function addLog(type, message) {
      const logItem = document.createElement('div');
      logItem.className = `log-item ${type}`;
      logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(logItem);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    async function migrateSkin(docId, skinData, skinName) {
      try {
        addLog('info', `–ú–∏–≥—Ä–∞—Ü–∏—è: ${skinName || docId}`);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º uploadString –≤–º–µ—Å—Ç–æ uploadBytes - —ç—Ç–æ –æ–±—Ö–æ–¥–∏—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ CORS –ø—Ä–æ–±–ª–µ–º—ã
        const storageRef = ref(storage, `gallery-skins/${docId}.png`);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é data URL
        const uploadResult = await uploadString(storageRef, skinData, 'data_url', {
          contentType: 'image/png'
        });
        
        addLog('info', `–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ–ª—É—á–µ–Ω–∏–µ URL...`);
        
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–ª—É—á–µ–Ω–∏–µ–º URL
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const downloadURL = await getDownloadURL(storageRef);
        addLog('success', `URL: ${downloadURL.substring(0, 60)}...`);
        
        const docRef = doc(db, 'skins', docId);
        await updateDoc(docRef, { skinUrl: downloadURL });
        addLog('success', `‚úì ${skinName || docId} - –∑–∞–≤–µ—Ä—à–µ–Ω–æ`);
        
        return { success: true, url: downloadURL };
      } catch(e) {
        console.error('Migration error:', e);
        
        if (e.code === 'storage/unauthorized') {
          addLog('error', `–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è ${skinName || docId}`);
        } else if (e.message.includes('CORS') || e.message.includes('Failed to fetch')) {
          addLog('error', `CORS –æ—à–∏–±–∫–∞ –¥–ª—è ${skinName || docId}. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS —á–µ—Ä–µ–∑ gsutil!`);
        } else {
          addLog('error', `${skinName || docId}: ${e.message}`);
        }
        
        return { success: false, error: e.message };
      }
    }

    async function startMigration(testMode = false) {
      try {
        startBtn.disabled = true;
        testBtn.disabled = true;
        progressSection.classList.add('active');
        
        addLog('info', testMode ? '–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ (1 —Å–∫–∏–Ω)...' : '–ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏...');
        
        const snapshot = await getDocs(collection(db, 'skins'));
        const skinsToMigrate = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.skinData && !data.skinUrl) {
            skinsToMigrate.push({ id: doc.id, data });
          }
        });
        
        if (!skinsToMigrate.length) {
          addLog('info', '–ù–µ—Ç —Å–∫–∏–Ω–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏');
          startBtn.disabled = false;
          testBtn.disabled = false;
          return;
        }
        
        const toProcess = testMode ? skinsToMigrate.slice(0, 1) : skinsToMigrate;
        addLog('info', `–ù–∞–π–¥–µ–Ω–æ ${toProcess.length} —Å–∫–∏–Ω–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏`);
        
        let processed = 0;
        let succeeded = 0;
        let failed = 0;
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ –æ–¥–Ω–æ–º—É —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        for (const skin of toProcess) {
          const result = await migrateSkin(skin.id, skin.data.skinData, skin.data.name);
          processed++;
          
          if (result.success) {
            succeeded++;
            migrated.textContent = parseInt(migrated.textContent) + 1;
            toMigrate.textContent = parseInt(toMigrate.textContent) - 1;
          } else {
            failed++;
          }
          
          const progress = (processed / toProcess.length) * 100;
          progressFill.style.width = progress + '%';
          progressStatus.textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processed}/${toProcess.length}`;
          
          // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–∫–∏–Ω–∞–º–∏ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å Storage
          if (processed < toProcess.length) {
            await new Promise(resolve => setTimeout(resolve, 2000));
          }
        }
        
        addLog('info', `‚úì –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ: ${succeeded}, –û—à–∏–±–æ–∫: ${failed}`);
        if (succeeded > 0) {
          progressStatus.className = 'status success';
        }
        
        startBtn.disabled = false;
        testBtn.disabled = false;
        
      } catch(e) {
        addLog('error', '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + e.message);
        console.error(e);
        startBtn.disabled = false;
        testBtn.disabled = false;
      }
    }

    startBtn.addEventListener('click', () => {
      if (confirm('–ù–∞—á–∞—Ç—å –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é –≤—Å–µ—Ö —Å–∫–∏–Ω–æ–≤? –ü—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.')) {
        startMigration(false);
      }
    });

    testBtn.addEventListener('click', () => {
      if (confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é (1 —Å–∫–∏–Ω)?')) {
        startMigration(true);
      }
    });
  </script>
</body>
</html>
